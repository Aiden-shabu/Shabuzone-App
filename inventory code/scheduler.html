<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Shabu Zone Schedule Manager</title>
  
  <!-- ExcelJS for Excel export with colors -->
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  
  <!-- Firebase v8 SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  
  <!-- ============================================ -->
  <!-- CSS STYLES - ìŠ¤íƒ€ì¼ ì •ì˜ -->
  <!-- ============================================ -->
  <style>
    /* --- ê¸°ë³¸ ë¦¬ì…‹ --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    /* --- Body ì „ì²´ ë°°ê²½ --- */
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f5f5f0;
      min-height: 100vh;
      padding: 10px;
      overflow-x: hidden;
      -webkit-tap-highlight-color: transparent;
    }
    
    @media (max-width: 768px) {
      body {
        padding: 5px;
      }
    }
    
    /* --- ë©”ì¸ ì»¨í…Œì´ë„ˆ --- */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    /* --- í—¤ë” (ì œëª© + ì–¸ì–´ ì„ íƒ) --- */
    .header {
      background: linear-gradient(135deg, #7f1d1d, #991b1b);
      padding: 20px;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    .header h1 { 
      font-size: clamp(20px, 5vw, 36px);
      font-weight: 700;
    }
    
    @media (max-width: 768px) {
      .header {
        padding: 15px;
      }
      .header h1 {
        font-size: 24px;
      }
    }
    .header .subtitle { font-size: 13px; opacity: 0.9; margin-top: 8px; }
    .header select {
      padding: 10px 16px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
    }
    
    /* --- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ --- */
    .tabs {
      display: flex;
      border-bottom: 2px solid #e8e8e8;
      background: white;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .tabs::-webkit-scrollbar {
      display: none;
    }
    .tab {
      flex: 1;
      min-width: 100px;
      padding: 16px 12px;
      border: none;
      background: transparent;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-weight: 500;
      color: #6b7280;
      font-size: 14px;
      transition: all 0.3s ease;
      white-space: nowrap;
    }
    
    @media (max-width: 768px) {
      .tab {
        padding: 12px 10px;
        font-size: 13px;
        min-width: 80px;
      }
    }
    .tab:hover {
      background: #fafafa;
      color: #374151;
    }
    .tab.active {
      background: #fef5f5;
      border-bottom: 3px solid #7f1d1d;
      font-weight: 600;
      color: #7f1d1d;
    }
    
    /* --- ì½˜í…ì¸  ì˜ì—­ --- */
    .content { 
      padding: 20px;
      min-height: 500px;
    }
    
    @media (max-width: 768px) {
      .content {
        padding: 15px 10px;
        min-height: auto;
      }
    }
    
    /* --- ë²„íŠ¼ ìŠ¤íƒ€ì¼ --- */
    .btn-primary {
      padding: 12px 20px;
      background: linear-gradient(135deg, #7f1d1d, #991b1b);
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 15px;
      min-height: 44px;
      touch-action: manipulation;
    }
    .btn-primary:hover { opacity: 0.9; }
    .btn-primary:active { transform: scale(0.98); }
    
    .btn-secondary {
      padding: 10px 16px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      min-height: 40px;
      touch-action: manipulation;
    }
    .btn-secondary:active { background: #f5f5f5; }
    
    @media (max-width: 768px) {
      .btn-primary {
        padding: 10px 16px;
        font-size: 14px;
        width: 100%;
      }
      .btn-secondary {
        padding: 8px 12px;
        font-size: 13px;
      }
    }
    
    /* --- ë¡œë”© í™”ë©´ --- */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      color: #7f1d1d;
      font-size: 24px;
      font-weight: 600;
    }
    
    /* --- ì§ì› ê·¸ë¦¬ë“œ --- */
    .employee-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
      margin-top: 24px;
    }
    
    @media (max-width: 768px) {
      .employee-grid {
        grid-template-columns: 1fr;
        gap: 12px;
        margin-top: 16px;
      }
    }
    
    /* --- ì§ì› ì¹´ë“œ --- */
    .employee-card {
      padding: 16px;
      background: white;
      border-radius: 12px;
      border: 1px solid #e8e8e8;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      transition: box-shadow 0.2s;
    }
    .employee-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .employee-card h3 { 
      margin: 0 0 8px 0;
      font-size: 17px;
      font-weight: 600;
      color: #2c3e50;
      word-break: break-word;
    }
    
    @media (max-width: 768px) {
      .employee-card {
        padding: 12px;
      }
      .employee-card h3 {
        font-size: 16px;
      }
    }
    
    /* --- ë°°ì§€ (ì„±ë³„, ìƒíƒœ) --- */
    .badge {
      padding: 4px 10px;
      color: white;
      border-radius: 6px;
      font-size: 12px;
      margin-right: 8px;
      display: inline-block;
      font-weight: 500;
    }
    .badge-male { background: #3b82f6; }
    .badge-female { background: #ec4899; }
    .badge-active { background: #10b981; }
    .badge-cant-work { background: #f59e0b; }
    
    /* --- í¼ ê·¸ë£¹ --- */
    .form-group { margin-bottom: 16px; }
    .form-group label { 
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      font-size: 14px;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 16px;
      -webkit-appearance: none;
      appearance: none;
    }
    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #7f1d1d;
    }
    
    @media (max-width: 768px) {
      .form-group input, .form-group select {
        padding: 14px 12px;
        font-size: 16px;
      }
    }
    
    /* --- ëª¨ë‹¬ (íŒì—…) --- */
    .modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 10px;
    }
    .modal.show { display: flex; }
    .modal-content {
      background: white;
      padding: 24px;
      border-radius: 16px;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    @media (max-width: 768px) {
      .modal {
        padding: 0;
        align-items: flex-end;
      }
      .modal-content {
        padding: 20px 16px;
        border-radius: 16px 16px 0 0;
        max-height: 95vh;
        width: 100%;
      }
    }
    
    /* --- Requirements í…Œì´ë¸” --- */
    .requirements-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      display: table;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .requirements-table th,
    .requirements-table td {
      padding: 10px 8px;
      border: 1px solid #ddd;
      text-align: center;
      font-size: 14px;
    }
    .requirements-table th { 
      background: #f5f5f5;
      font-weight: 600;
      white-space: nowrap;
    }
    .requirements-table input[type="number"] {
      width: 50px;
      padding: 6px 4px;
      text-align: center;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    @media (max-width: 768px) {
      .requirements-table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }
      .requirements-table th,
      .requirements-table td {
        padding: 8px 6px;
        font-size: 13px;
      }
      .requirements-table input[type="number"] {
        width: 45px;
        font-size: 13px;
      }
    }
    
    /* --- Preferences í…Œì´ë¸” --- */
    .preferences-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      display: table;
    }
    .preferences-table th,
    .preferences-table td {
      padding: 10px 8px;
      border: 1px solid #e0e0e0;
      font-size: 14px;
    }
    .preferences-table th { 
      background: #f5f5f5;
      font-weight: 600;
      white-space: nowrap;
    }
    
    .pref-button {
      width: 70px;
      height: 38px;
      border: 2px solid #ddd;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 16px;
      touch-action: manipulation;
    }
    .pref-button:active {
      transform: scale(0.95);
    }
    
    @media (max-width: 768px) {
      .preferences-table {
        display: block;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        white-space: nowrap;
      }
      .preferences-table th,
      .preferences-table td {
        padding: 8px 6px;
        font-size: 13px;
      }
      .pref-button {
        width: 60px;
        height: 36px;
        font-size: 15px;
      }
    }
    
    /* --- Schedule ê·¸ë¦¬ë“œ --- */
    .schedule-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 12px;
      margin-top: 20px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    @media (max-width: 1200px) {
      .schedule-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }
    
    @media (max-width: 768px) {
      .schedule-grid {
        grid-template-columns: 1fr;
        gap: 10px;
      }
    }
    
    .schedule-day {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 12px;
      min-height: 250px;
    }
    
    .schedule-day.holiday {
      background: #FFF3E0;
      border-color: #FF9800;
    }
    
    .schedule-day h3 {
      margin: 0 0 10px 0;
      font-size: 15px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e0e0e0;
    }
    
    @media (max-width: 768px) {
      .schedule-day {
        padding: 12px;
        min-height: auto;
      }
      .schedule-day h3 {
        font-size: 16px;
        font-weight: 700;
      }
    }
    
    .schedule-shift {
      margin-bottom: 12px;
    }
    
    .schedule-shift h4 {
      font-size: 13px;
      color: #666;
      margin-bottom: 6px;
      font-weight: 600;
    }
    
    .schedule-person {
      background: #f9f9f9;
      padding: 6px 10px;
      margin: 3px 0;
      border-radius: 6px;
      font-size: 13px;
      line-height: 1.4;
    }
    
    @media (max-width: 768px) {
      .schedule-shift {
        margin-bottom: 10px;
      }
      .schedule-shift h4 {
        font-size: 14px;
      }
      .schedule-person {
        padding: 8px 12px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <!-- ============================================ -->
  <!-- FIREBASE & JAVASCRIPT -->
  <!-- ============================================ -->
  <script>
    // ============================================
    // FIREBASE ì„¤ì • (v8 SDK)
    // ============================================
    const firebaseConfig = {
      apiKey: "AIzaSyAkAf6r0vaBfdF_VvhjFJUp_N4iQx7JXH4",
      authDomain: "shabu-zone-db.firebaseapp.com",
      databaseURL: "https://shabu-zone-inventory-default-rtdb.firebaseio.com",
      projectId: "shabu-zone-db",
      storageBucket: "shabu-zone-db.firebasestorage.app",
      messagingSenderId: "584815119069",
      appId: "1:584815119069:web:18d050cccf586e8f98e52b"
    };

    // --- Firebase ì´ˆê¸°í™” (ì™„ì „ ë…ë¦½) ---
    let schedulerApp;
    try {
      // ê¸°ì¡´ ì•±ì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
      schedulerApp = firebase.apps.find(app => app.name === 'scheduler-app') || 
                     firebase.initializeApp(firebaseConfig, 'scheduler-app');
    } catch (error) {
      console.log('Firebase ì´ë¯¸ ì´ˆê¸°í™”ë¨, ê¸°ì¡´ ì¸ìŠ¤í„´ìŠ¤ ì‚¬ìš©');
      schedulerApp = firebase.app('scheduler-app');
    }
    const db = schedulerApp.database();
    
    // --- URL íŒŒë¼ë¯¸í„°ì—ì„œ locationê³¼ language ì½ê¸° ---
    const urlParams = new URLSearchParams(window.location.search);
    const LOCATION = urlParams.get('location');
    const INITIAL_LANG = urlParams.get('lang') || 'ko';
    const READ_ONLY = urlParams.get('readonly') === 'true'; // ì½ê¸° ì „ìš© ëª¨ë“œ
    
    // ğŸ”’ ë³´ì•ˆ: location íŒŒë¼ë¯¸í„° ì—†ìœ¼ë©´ index.htmlë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
    if (!LOCATION) {
      console.log('âš ï¸ No location parameter - redirecting to index.html');
      window.location.href = 'index.html';
      throw new Error('Unauthorized access');
    }
    
    console.log('ğŸŒ Location:', LOCATION);
    console.log('ğŸŒ Language:', INITIAL_LANG);
    console.log('ğŸ”’ Read Only Mode:', READ_ONLY);

    // ============================================
    // STORAGE - Firebase Realtime Database ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° (v8)
    // ============================================
    const storage = {
      // --- ë°ì´í„° ì €ì¥ ---
      async saveData(key, data) {
        try {
          const path = `${LOCATION}/management/${key}`;
          await db.ref(path).set(data);
          console.log(`âœ… Firebase saved: ${path}`);
          return true;
        } catch (error) {
          console.error('âŒ Firebase save error:', error);
          alert(`Save error: ${error.message}`);
          return false;
        }
      },
      
      // --- ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ---
      async loadData(key, defaultValue) {
        try {
          const path = `${LOCATION}/management/${key}`;
          const snapshot = await db.ref(path).once('value');
          if (snapshot.exists()) {
            console.log(`âœ… Firebase loaded: ${path}`);
            return snapshot.val();
          }
          return defaultValue;
        } catch (error) {
          console.error('âŒ Firebase load error:', error);
          return defaultValue;
        }
      }
    };

    // ============================================
    // ìƒìˆ˜ ì •ì˜
    // ============================================
    
    // --- ìš”ì¼ ë°°ì—´ ---
    const DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    
    // --- ì‹œí”„íŠ¸ ì¢…ë¥˜ ---
    const SHIFTS = {
      morning: ['open', 'eleven', 'elevenThirty'],
      evening: ['threeThirty', 'six']
    };

    // ============================================
    // ë²ˆì—­ (3ê°œ ì–¸ì–´)
    // ============================================
    const TRANSLATIONS = {
      en: {
        appTitle: "Shabu Zone Schedule Manager",
        connectedToFirebase: "Connected to Firebase",
        tabs: {
          employees: "Employees",
          requirements: "Requirements",
          preferences: "Preferences",
          schedule: "Schedule",
          excelView: "Excel View",
          tips: "Tips"
        },
        employees: {
          title: "Employee Management",
          addEmployee: "Add Employee",
          name: "Name",
          gender: "Gender",
          male: "Male",
          female: "Female",
          status: "Status",
          active: "Active",
          cantWork: "Can't Work",
          save: "Save",
          cancel: "Cancel",
          noEmployees: "No employees yet. Click 'Add Employee' to start!",
          cantWorkDetails: "Can't Work Details",
          reason: "Reason",
          startDate: "Start Date",
          endDate: "End Date"
        },
        requirements: {
          title: "Weekly Requirements",
          copyPrevious: "Copy Previous Week",
          lunch: "LUNCH",
          dinner: "DINNER",
          open: "Open~Break",
          eleven: "11:00~Break",
          elevenThirty: "11:30~Break",
          threeThirty: "3:30~Close",
          six: "6:00~Close",
          total: "Total",
          holiday: "Holiday"
        },
        preferences: {
          title: "Employee Preferences",
          selectEmployee: "-- Select Employee --",
          minGuarantee: "Min. Guaranteed Shifts",
          savePreferences: "Save Preferences",
          lastSaved: "Last saved",
          clickToCycle: "Click to cycle colors",
          morning: "Morning",
          evening: "Evening",
          fixed: "Fixed"
        },
        schedule: {
          title: "Weekly Schedule",
          runSchedule: "Run Schedule",
          noSchedule: "No schedule generated yet. Click 'Run Schedule' to create!",
          generating: "Generating schedule...",
          lunch: "Lunch",
          dinner: "Dinner"
        },
        excelView: {
          title: "Excel View - Edit Schedule",
          noSchedule: "No schedule yet. Go to Schedule tab and click 'Run Schedule' first!",
          lunchCount: "Lunch Count",
          dinnerCount: "Dinner Count",
          allDayCount: "All Day Count",
          clickToEdit: "Click to edit shift",
          changeShift: "Change Shift",
          currentShift: "Current",
          changeTo: "Change to",
          switchEmployee: "Switch Employee",
          off: "OFF",
          availableEmployees: "Available Employees",
          swapWith: "Click to swap with"
        },
        sections: {
          title: "Section Assignment",
          comingSoon: "Coming soon!"
        }
      },
      ko: {
        appTitle: "ìƒ¤ë¶€ì¡´ ìŠ¤ì¼€ì¤„ ê´€ë¦¬",
        connectedToFirebase: "Firebase ì—°ê²°ë¨",
        tabs: {
          employees: "ì§ì› ê´€ë¦¬",
          requirements: "ì¸ì› ì„¤ì •",
          preferences: "í¬ë§ ìŠ¤ì¼€ì¤„",
          schedule: "ìŠ¤ì¼€ì¤„",
          excelView: "ì—‘ì…€ ë·°",
          tips: "íŒ ê´€ë¦¬"
        },
        employees: {
          title: "ì§ì› ê´€ë¦¬",
          addEmployee: "ì§ì› ì¶”ê°€",
          name: "ì´ë¦„",
          gender: "ì„±ë³„",
          male: "ë‚¨ì",
          female: "ì—¬ì",
          status: "ìƒíƒœ",
          active: "ê·¼ë¬´ ê°€ëŠ¥",
          cantWork: "ê·¼ë¬´ ë¶ˆê°€",
          save: "ì €ì¥",
          cancel: "ì·¨ì†Œ",
          noEmployees: "ì•„ì§ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤. 'ì§ì› ì¶”ê°€'ë¥¼ í´ë¦­í•˜ì„¸ìš”!",
          cantWorkDetails: "ê·¼ë¬´ ë¶ˆê°€ ìƒì„¸",
          reason: "ì‚¬ìœ ",
          startDate: "ì‹œì‘ì¼",
          endDate: "ì¢…ë£Œì¼"
        },
        requirements: {
          title: "ì£¼ê°„ í•„ìš” ì¸ì›",
          copyPrevious: "ì´ì „ ì£¼ ë³µì‚¬",
          lunch: "ì ì‹¬",
          dinner: "ì €ë…",
          open: "ì˜¤í”ˆ~ë¸Œë ˆì´í¬",
          eleven: "11:00~ë¸Œë ˆì´í¬",
          elevenThirty: "11:30~ë¸Œë ˆì´í¬",
          threeThirty: "3:30~ë§ˆê°",
          six: "6:00~ë§ˆê°",
          total: "í•©ê³„",
          holiday: "íŠ¹ë³„ì¼"
        },
        preferences: {
          title: "ì§ì› í¬ë§ ìŠ¤ì¼€ì¤„",
          selectEmployee: "-- ì§ì› ì„ íƒ --",
          minGuarantee: "ìµœì†Œ ë³´ì¥ ì‹œí”„íŠ¸",
          savePreferences: "ì €ì¥",
          lastSaved: "ë§ˆì§€ë§‰ ì €ì¥",
          clickToCycle: "í´ë¦­í•˜ì—¬ ìƒ‰ìƒ ë³€ê²½",
          morning: "ì˜¤ì „",
          evening: "ì˜¤í›„",
          fixed: "ê³ ì •"
        },
        schedule: {
          title: "ì£¼ê°„ ìŠ¤ì¼€ì¤„",
          runSchedule: "ìŠ¤ì¼€ì¤„ ìƒì„±",
          noSchedule: "ì•„ì§ ìŠ¤ì¼€ì¤„ì´ ì—†ìŠµë‹ˆë‹¤. 'ìŠ¤ì¼€ì¤„ ìƒì„±'ì„ í´ë¦­í•˜ì„¸ìš”!",
          generating: "ìŠ¤ì¼€ì¤„ ìƒì„± ì¤‘...",
          lunch: "ì ì‹¬",
          dinner: "ì €ë…"
        },
        sections: {
          title: "ì„¹ì…˜ ë°°ì •",
          comingSoon: "ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤!"
        }
      },
      vi: {
        appTitle: "Quáº£n LÃ½ Lá»‹ch Shabu Zone",
        connectedToFirebase: "ÄÃ£ káº¿t ná»‘i Firebase",
        tabs: {
          employees: "NhÃ¢n ViÃªn",
          requirements: "YÃªu Cáº§u",
          preferences: "Mong Muá»‘n",
          schedule: "Lá»‹ch LÃ m",
          excelView: "Excel",
          tips: "Tips"
        },
        employees: {
          title: "Quáº£n LÃ½ NhÃ¢n ViÃªn",
          addEmployee: "ThÃªm NV",
          name: "TÃªn",
          gender: "Giá»›i TÃ­nh",
          male: "Nam",
          female: "Ná»¯",
          status: "Tráº¡ng ThÃ¡i",
          active: "Hoáº¡t Äá»™ng",
          cantWork: "KhÃ´ng LÃ m",
          save: "LÆ°u",
          cancel: "Há»§y",
          noEmployees: "ChÆ°a cÃ³ nhÃ¢n viÃªn. Click 'ThÃªm NV' Ä‘á»ƒ báº¯t Ä‘áº§u!",
          cantWorkDetails: "Chi Tiáº¿t KhÃ´ng LÃ m",
          reason: "LÃ½ Do",
          startDate: "NgÃ y Báº¯t Äáº§u",
          endDate: "NgÃ y Káº¿t ThÃºc"
        },
        requirements: {
          title: "YÃªu Cáº§u HÃ ng Tuáº§n",
          copyPrevious: "Sao ChÃ©p Tuáº§n TrÆ°á»›c",
          lunch: "TRÆ¯A",
          dinner: "Tá»I",
          open: "Má»Ÿ~Nghá»‰",
          eleven: "11:00~Nghá»‰",
          elevenThirty: "11:30~Nghá»‰",
          threeThirty: "3:30~ÄÃ³ng",
          six: "6:00~ÄÃ³ng",
          total: "Tá»•ng",
          holiday: "NgÃ y Lá»…"
        },
        preferences: {
          title: "Mong Muá»‘n NhÃ¢n ViÃªn",
          selectEmployee: "-- Chá»n NhÃ¢n ViÃªn --",
          minGuarantee: "Ca Tá»‘i Thiá»ƒu",
          savePreferences: "LÆ°u",
          lastSaved: "LÆ°u láº§n cuá»‘i",
          clickToCycle: "Click Ä‘á»ƒ thay Ä‘á»•i mÃ u",
          morning: "SÃ¡ng",
          evening: "Tá»‘i",
          fixed: "Cá»‘ Äá»‹nh"
        },
        schedule: {
          title: "Lá»‹ch HÃ ng Tuáº§n",
          runSchedule: "Táº¡o Lá»‹ch",
          noSchedule: "ChÆ°a cÃ³ lá»‹ch. Click 'Táº¡o Lá»‹ch' Ä‘á»ƒ báº¯t Ä‘áº§u!",
          generating: "Äang táº¡o lá»‹ch...",
          lunch: "TrÆ°a",
          dinner: "Tá»‘i"
        },
        sections: {
          title: "PhÃ¢n Khu Vá»±c",
          comingSoon: "Sáº¯p ra máº¯t!"
        }
      }
    };

    // ============================================
    // APP STATE - ì•± ì „ì²´ ìƒíƒœ ê´€ë¦¬
    // ìˆ˜ì •: ì´ˆê¸°ê°’ ë³€ê²½í•˜ë ¤ë©´ ì—¬ê¸°!
    // ============================================
    let state = {
      language: INITIAL_LANG,       // í˜„ì¬ ì–¸ì–´ (URLì—ì„œ)
      activeTab: 'employees',       // í˜„ì¬ íƒ­
      employees: [],                // ì§ì› ëª©ë¡
      requirements: {},             // ì£¼ê°„ í•„ìš” ì¸ì›
      preferences: {},              // ì§ì›ë³„ í¬ë§ ìŠ¤ì¼€ì¤„
      schedule: {},                 // ìƒì„±ëœ ìŠ¤ì¼€ì¤„
      loading: true,                // ë¡œë”© ìƒíƒœ
      showModal: false,             // ëª¨ë‹¬ í‘œì‹œ ì—¬ë¶€
      editingEmployee: null,        // ìˆ˜ì • ì¤‘ì¸ ì§ì›
      selectedEmployee: null,       // ì„ íƒëœ ì§ì› (Preferencesìš©)
      generating: false,            // ìŠ¤ì¼€ì¤„ ìƒì„± ì¤‘
      
      // Tips ê´€ë ¨
      tipsSubTab: 'entry',          // tips ì„œë¸Œíƒ­: 'entry', 'statistics', 'settlement', 'history'
      tipsData: {},                 // íŒ ë°ì´í„°: { "2026-01-27": { lunch: {}, dinner: {} } }
      tipStats: {},                 // í†µê³„: { "John": { pending, paid, total } }
      settlements: [],              // ì •ì‚° ê¸°ë¡
      selectedTipDate: null,        // ì„ íƒëœ ë‚ ì§œ
      tipEntryStep: 'select-date',  // 'select-date', 'lunch-select', 'lunch-entry', 'dinner-select', 'dinner-entry'
      lunchWorkers: [],             // Lunch shift ê·¼ë¬´ì
      dinnerWorkers: [],            // Dinner shift ê·¼ë¬´ì
      lunchTips: {},                // { "John": 150.00 }
      dinnerTips: {},               // { "John": 200.00 }
      settlementStart: '',          // ì •ì‚° ì‹œì‘ì¼
      settlementEnd: '',            // ì •ì‚° ì¢…ë£Œì¼
      settlementSummary: null,      // ì •ì‚° ìš”ì•½
      selectedSettlement: null,     // Historyì—ì„œ ì„ íƒëœ ì •ì‚°
      tipCalendarMonth: new Date(),  // ë‹¬ë ¥ ì›”
      confirmModal: null             // í™•ì¸ ëª¨ë‹¬ ë°ì´í„°
    };

    // ============================================
    // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
    // ============================================
    async function loadInitialData() {
      state.loading = true;
      render();
      
      // --- Firebaseì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ---
      const [employees, requirements, preferences, schedule, tipsData, tipStats, settlements] = await Promise.all([
        storage.loadData('employees', []),
        storage.loadData('requirements', getDefaultRequirements()),
        storage.loadData('preferences', {}),
        storage.loadData('schedule', {}),
        storage.loadData('tips', {}),
        storage.loadData('tipStats', {}),
        storage.loadData('settlements', [])
      ]);
      
      state.employees = employees;
      state.requirements = requirements;
      state.preferences = preferences;
      state.schedule = schedule;
      state.tipsData = tipsData;
      state.tipStats = tipStats;
      state.settlements = settlements;
      state.loading = false;
      
      render();
    }

    // --- ê¸°ë³¸ Requirements êµ¬ì¡° ìƒì„± ---
    function getDefaultRequirements() {
      const reqs = {};
      DAYS.forEach(day => {
        reqs[day] = {
          lunch: { open: 4, eleven: 2, elevenThirty: 3 },
          dinner: { threeThirty: 8, six: 0 },
          allDayMax: 0,
          isHoliday: false
        };
      });
      return reqs;
    }

    // ============================================
    // ë°ì´í„° ì €ì¥ í•¨ìˆ˜ë“¤
    // ============================================
    async function saveEmployees() {
      await storage.saveData('employees', state.employees);
    }

    async function saveRequirements() {
      await storage.saveData('requirements', state.requirements);
    }

    async function savePreferences() {
      await storage.saveData('preferences', state.preferences);
    }

    async function saveSchedule() {
      await storage.saveData('schedule', state.schedule);
    }

    // ============================================
    // RENDER í•¨ìˆ˜ë“¤
    // ============================================
    
    // --- ë©”ì¸ ë Œë”ë§ ---
    function render() {
      const app = document.getElementById('app');
      
      if (state.loading) {
        app.innerHTML = `<div class="loading">ğŸ”¥ Loading...</div>`;
        return;
      }

      const t = TRANSLATIONS[state.language];

      app.innerHTML = `
        <div class="container">
          ${renderHeader(t)}
          ${renderTabs(t)}
          ${renderContent(t)}
        </div>
        ${state.showModal ? renderModal(t) : ''}
        ${state.confirmModal ? renderConfirmModal() : ''}
      `;

      attachEventListeners();
    }

    // --- í—¤ë” ë Œë”ë§ ---
    function renderHeader(t) {
      return `
        <div class="header">
          <div style="display: flex; align-items: center; gap: 12px;">
            <img src="./shabu_logo_80x80.png" style="width: 80px; height: 80px; border-radius: 8px;">
            <div>
              <h1>${t.appTitle}</h1>
              <div class="subtitle">ğŸ”¥ ${t.connectedToFirebase}</div>
            </div>
          </div>
          <select id="language-selector">
            <option value="en" ${state.language === 'en' ? 'selected' : ''}>ğŸ‡ºğŸ‡¸ English</option>
            <option value="ko" ${state.language === 'ko' ? 'selected' : ''}>ğŸ‡°ğŸ‡· í•œêµ­ì–´</option>
            <option value="vi" ${state.language === 'vi' ? 'selected' : ''}>ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</option>
          </select>
        </div>
      `;
    }

    // --- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ ë Œë”ë§ ---
    function renderTabs(t) {
      // READ_ONLY ëª¨ë“œì—ì„œëŠ” íŠ¹ì • íƒ­ë§Œ í‘œì‹œ
      const allTabs = ['employees', 'requirements', 'preferences', 'schedule', 'excelView', 'tips'];
      const visibleTabs = READ_ONLY 
        ? ['employees', 'preferences', 'schedule', 'excelView', 'tips'] // READ_ONLY: Requirementsë§Œ ìˆ¨ê¹€
        : allTabs;
      
      return `
        <div class="tabs">
          ${visibleTabs.map(tab => `
            <button class="tab ${state.activeTab === tab ? 'active' : ''}" data-tab="${tab}">
              ${t.tabs[tab]}
            </button>
          `).join('')}
        </div>
      `;
    }

    // --- ì½˜í…ì¸  ë Œë”ë§ (íƒ­ë³„) ---
    function renderContent(t) {
      return `
        <div class="content">
          ${state.activeTab === 'employees' ? renderEmployeesTab(t) : ''}
          ${state.activeTab === 'requirements' ? renderRequirementsTab(t) : ''}
          ${state.activeTab === 'preferences' ? renderPreferencesTab(t) : ''}
          ${state.activeTab === 'schedule' ? renderScheduleTab(t) : ''}
          ${state.activeTab === 'excelView' ? renderExcelViewTab(t) : ''}
          ${state.activeTab === 'tips' ? renderTipsTab(t) : ''}
        </div>
      `;
    }

    // ============================================
    // EMPLOYEES TAB - ì§ì› ê´€ë¦¬ íƒ­
    // ìˆ˜ì •: ì¹´ë“œ ë””ìì¸ ë³€ê²½í•˜ë ¤ë©´ ì´ í•¨ìˆ˜!
    // ============================================
    function renderEmployeesTab(t) {
      return `
        <div style="display:flex;justify-content:space-between;margin-bottom:24px;">
          <h2 style="margin:0;font-size:24px;font-weight:600;">${t.employees.title} (${state.employees.length})</h2>
          ${!READ_ONLY ? `
            <button class="btn-primary" id="add-employee-btn">
              â• ${t.employees.addEmployee}
            </button>
          ` : ''}
        </div>

        ${state.employees.length === 0 ? `
          <div style="padding:60px;text-align:center;background:#f9f9f9;border-radius:12px;border:2px dashed #ddd;">
            <div style="font-size:48px;margin-bottom:16px;">ğŸ‘¥</div>
            <p style="color:#999;font-size:16px;">${t.employees.noEmployees}</p>
          </div>
        ` : `
          <div class="employee-grid">
            ${state.employees.map(emp => `
              <div class="employee-card" style="${emp.status === 'cantWork' ? 'background:#FFF3E0;' : ''}">
                <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px;">
                  <div style="flex:1;">
                    <h3>${emp.name}</h3>
                    <div style="margin:8px 0;">
                      <span class="badge ${emp.gender === 'male' ? 'badge-male' : 'badge-female'}">
                        ${emp.gender === 'male' ? t.employees.male : t.employees.female}
                      </span>
                      <span class="badge ${emp.status === 'cantWork' ? 'badge-cant-work' : 'badge-active'}">
                        ${emp.status === 'cantWork' ? t.employees.cantWork : t.employees.active}
                      </span>
                    </div>
                    ${emp.status === 'cantWork' && emp.cantWorkDetails ? `
                      <div style="font-size:12px;color:#666;margin-top:8px;padding:8px;background:white;border-radius:6px;">
                        <div><strong>${t.employees.reason}:</strong> ${emp.cantWorkDetails.reason || 'N/A'}</div>
                        <div><strong>${t.employees.startDate}:</strong> ${emp.cantWorkDetails.startDate || 'N/A'}</div>
                        <div><strong>${t.employees.endDate}:</strong> ${emp.cantWorkDetails.endDate || 'N/A'}</div>
                      </div>
                    ` : ''}
                  </div>
                  ${!READ_ONLY ? `
                    <div style="display:flex;gap:8px;">
                      <button onclick="editEmployee(${emp.id})" style="padding:6px;background:white;border:1px solid #ddd;border-radius:6px;cursor:pointer;" title="Edit">
                        âœï¸
                      </button>
                      <button onclick="deleteEmployee(${emp.id})" style="padding:6px;background:white;border:1px solid #ddd;border-radius:6px;cursor:pointer;color:#FF6B6B;" title="Delete">
                        ğŸ—‘ï¸
                      </button>
                    </div>
                  ` : ''}
                </div>
              </div>
            `).join('')}
          </div>
        `}
      `;
    }

    // ============================================
    // REQUIREMENTS TAB - ì¸ì› ì„¤ì • íƒ­
    // ìˆ˜ì •: í…Œì´ë¸” êµ¬ì¡° ë³€ê²½í•˜ë ¤ë©´ ì´ í•¨ìˆ˜!
    // ============================================
    function renderRequirementsTab(t) {
      return `
        <div style="display:flex;justify-content:space-between;margin-bottom:24px;">
          <h2 style="margin:0;font-size:24px;font-weight:600;">${t.requirements.title}</h2>
        </div>

        <table class="requirements-table">
          <thead>
            <tr>
              <th rowspan="2" style="width:100px;">Day</th>
              <th colspan="3">${t.requirements.lunch}</th>
              <th rowspan="2" style="width:80px;">Lunch<br>Total</th>
              <th colspan="2">${t.requirements.dinner}</th>
              <th rowspan="2" style="width:80px;">Dinner<br>Total</th>
              <th rowspan="2" style="width:80px;">All Day<br>Max</th>
              <th rowspan="2" style="width:100px;">${t.requirements.holiday}</th>
            </tr>
            <tr>
              <th>${t.requirements.open}</th>
              <th>${t.requirements.eleven}</th>
              <th>${t.requirements.elevenThirty}</th>
              <th>${t.requirements.threeThirty}</th>
              <th>${t.requirements.six}</th>
            </tr>
          </thead>
          <tbody>
            ${DAYS.map(day => {
              const req = state.requirements[day];
              const lunchTotal = (req.lunch.open || 0) + (req.lunch.eleven || 0) + (req.lunch.elevenThirty || 0);
              const dinnerTotal = (req.dinner.threeThirty || 0) + (req.dinner.six || 0);
              
              return `
                <tr style="${req.isHoliday ? 'background:#FFF3E0;' : ''}">
                  <td style="font-weight:600;">${t.days?.[day] || day}</td>
                  <td><input type="number" min="0" value="${req.lunch.open}" onchange="updateRequirement('${day}', 'lunch', 'open', this.value)"></td>
                  <td><input type="number" min="0" value="${req.lunch.eleven}" onchange="updateRequirement('${day}', 'lunch', 'eleven', this.value)"></td>
                  <td><input type="number" min="0" value="${req.lunch.elevenThirty}" onchange="updateRequirement('${day}', 'lunch', 'elevenThirty', this.value)"></td>
                  <td style="font-weight:700;background:#E8F5E9;color:#2E7D32;font-size:16px;">${lunchTotal}</td>
                  <td><input type="number" min="0" value="${req.dinner.threeThirty}" onchange="updateRequirement('${day}', 'dinner', 'threeThirty', this.value)"></td>
                  <td><input type="number" min="0" value="${req.dinner.six}" onchange="updateRequirement('${day}', 'dinner', 'six', this.value)"></td>
                  <td style="font-weight:700;background:#E3F2FD;color:#1565C0;font-size:16px;">${dinnerTotal}</td>
                  <td><input type="number" min="0" value="${req.allDayMax || 0}" onchange="updateAllDayMax('${day}', this.value)" style="width:60px;"></td>
                  <td>
                    <input type="checkbox" ${req.isHoliday ? 'checked' : ''} onchange="toggleHoliday('${day}')" style="cursor:pointer;width:20px;height:20px;">
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>

        <div style="margin-top:20px;padding:16px;background:#E3F2FD;border-radius:8px;font-size:14px;">
          ğŸ’¡ <strong>Holiday Mode:</strong> When checked, all available employees will be scheduled regardless of preferences to prevent shortages.<br>
          <strong>Main Job employees</strong> will maintain their fixed schedule even on holidays.
        </div>
      `;
    }

    // ============================================
    // PREFERENCES TAB - í¬ë§ ìŠ¤ì¼€ì¤„ íƒ­
    // ìˆ˜ì •: ìƒ‰ìƒ ë²„íŠ¼ ë³€ê²½í•˜ë ¤ë©´ ì´ í•¨ìˆ˜!
    // ============================================
    function renderPreferencesTab(t) {
      const activeEmployees = state.employees.filter(e => e.status === 'active');
      const selectedEmp = state.selectedEmployee;
      const empPrefs = selectedEmp ? (state.preferences[selectedEmp.id] || {}) : {};

      return `
        ${READ_ONLY ? `
          <div style="padding:16px;background:#fff7ed;border-radius:8px;margin-bottom:20px;border:2px solid #fbbf24;">
            <div style="display:flex;align-items:center;gap:12px;">
              <span style="font-size:1.5rem;">ğŸ”’</span>
              <div>
                <div style="font-weight:700;color:#92400e;margin-bottom:4px;">Read-Only Mode</div>
                <div style="color:#64748b;font-size:0.875rem;">You can view preferences but cannot modify them</div>
              </div>
            </div>
          </div>
        ` : ''}
        
        <div style="margin-bottom:24px;">
          <h2 style="margin:0 0 16px 0;font-size:24px;font-weight:600;">${t.preferences.title}</h2>
          
          <select id="employee-selector" style="width:300px;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:15px;" ${READ_ONLY ? 'disabled' : ''}>
            <option value="">${t.preferences.selectEmployee}</option>
            ${activeEmployees.map(emp => `
              <option value="${emp.id}" ${selectedEmp?.id === emp.id ? 'selected' : ''}>${emp.name}</option>
            `).join('')}
          </select>
        </div>

        ${!selectedEmp ? `
          <div style="padding:60px;text-align:center;background:#f9f9f9;border-radius:12px;border:2px dashed #ddd;">
            <div style="font-size:48px;margin-bottom:16px;">ğŸ‘¤</div>
            <p style="color:#999;font-size:16px;">Select an employee to ${READ_ONLY ? 'view' : 'set'} preferences</p>
          </div>
        ` : `
          <div style="padding:24px;background:white;border-radius:12px;border:2px solid #7f1d1d;">
            <h3 style="margin:0 0 16px 0;">${selectedEmp.name}</h3>
            
            <table class="preferences-table">
              <thead>
                <tr style="background:#f5f5f5;">
                  <th style="text-align:left;width:120px;">Day</th>
                  <th style="text-align:center;width:120px;">${t.preferences.morning}</th>
                  <th style="text-align:center;width:80px;">${t.preferences.fixed}</th>
                  <th style="text-align:center;width:120px;">${t.preferences.evening}</th>
                  <th style="text-align:center;width:80px;">${t.preferences.fixed}</th>
                </tr>
              </thead>
              <tbody>
                ${DAYS.map(day => {
                  const dayPrefs = empPrefs[day] || { morning: 0, evening: 0, morningFixed: false, eveningFixed: false };
                  return `
                    <tr>
                      <td style="font-weight:500;">${t.days?.[day] || day}</td>
                      <td style="text-align:center;">
                        <button class="pref-button" 
                                ${READ_ONLY ? '' : `onclick="cyclePreference('${day}', 'morning')"`}
                                style="background:${getPrefColor(dayPrefs.morning, 'morning')};${READ_ONLY ? 'cursor:not-allowed;opacity:0.7;' : ''}">
                          ${getPrefEmoji(dayPrefs.morning, 'morning')}
                        </button>
                      </td>
                      <td style="text-align:center;">
                        <input type="checkbox" 
                               ${dayPrefs.morningFixed ? 'checked' : ''} 
                               ${READ_ONLY ? 'disabled' : `onchange="toggleFixed('${day}', 'morning')"`}
                               style="width:20px;height:20px;${READ_ONLY ? 'cursor:not-allowed;' : 'cursor:pointer;'}"
                               ${dayPrefs.morning === 0 ? 'disabled' : ''}>
                      </td>
                      <td style="text-align:center;">
                        <button class="pref-button" 
                                ${READ_ONLY ? '' : `onclick="cyclePreference('${day}', 'evening')"`}
                                style="background:${getPrefColor(dayPrefs.evening, 'evening')};${READ_ONLY ? 'cursor:not-allowed;opacity:0.7;' : ''}">
                          ${getPrefEmoji(dayPrefs.evening, 'evening')}
                        </button>
                      </td>
                      <td style="text-align:center;">
                        <input type="checkbox" 
                               ${dayPrefs.eveningFixed ? 'checked' : ''} 
                               ${READ_ONLY ? 'disabled' : `onchange="toggleFixed('${day}', 'evening')"`}
                               style="width:20px;height:20px;${READ_ONLY ? 'cursor:not-allowed;' : 'cursor:pointer;'}"
                               ${dayPrefs.evening === 0 ? 'disabled' : ''}>
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>

            <div style="margin-top:16px;padding:12px;background:#FFF3E0;border-radius:8px;font-size:13px;border-left:3px solid #F57C00;">
              <strong>â­ Fixed:</strong> When checked, this shift will <strong>ALWAYS</strong> be assigned (ignores min guarantee and shortages).<br>
              <strong>ğŸ’¡ Tip:</strong> Use Fixed for employees who need specific regular shifts (e.g., always Monday morning, always Tuesday evening).
            </div>

            <div style="margin-top:16px;padding:12px;background:#E3F2FD;border-radius:8px;font-size:13px;">
              ğŸ’¡ ${t.preferences.clickToCycle}<br>
              ${t.preferences.morning}: Empty â†’ ğŸŸ¡ (Open~Break) â†’ ğŸŸ¢ (11:00/11:30~Break)<br>
              ${t.preferences.evening}: Empty â†’ ğŸ”µ (3:30~Close) â†’ ğŸŸ£ (6:00~Close)
            </div>

            <div style="margin-top:24px;padding:16px;background:#f9f9f9;border-radius:8px;">
              <label style="display:block;margin-bottom:8px;font-weight:600;">
                ${t.preferences.minGuarantee}:
              </label>
              <input type="number" min="0" id="min-guarantee" value="${empPrefs.minGuarantee || 0}" 
                     style="width:100px;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:15px;"
                     ${READ_ONLY ? 'disabled' : ''}>
              <div style="margin-top:8px;font-size:12px;color:#666;">
                (Applies only to non-fixed shifts. Fixed shifts are always assigned.)
              </div>
            </div>

            ${!READ_ONLY ? `
              <button class="btn-primary" onclick="saveCurrentPreferences()" style="margin-top:24px;">
                ğŸ’¾ ${t.preferences.savePreferences}
              </button>
            ` : ''}

            ${empPrefs.savedAt ? `
              <div style="margin-top:12px;color:#4CAF50;font-size:14px;">
                âœ… ${t.preferences.lastSaved}: ${new Date(empPrefs.savedAt).toLocaleString()}
              </div>
            ` : ''}
          </div>
        `}
      `;
    }

    // --- Preference ìƒ‰ìƒ ë°˜í™˜ ---
    function getPrefColor(value, period) {
      if (value === 0) return '#f5f5f5';
      if (period === 'morning') return value === 1 ? '#FFD93D' : '#6BCB77';
      return value === 1 ? '#4D96FF' : '#9D4EDD';
    }

    // --- Preference ì´ëª¨ì§€ ë°˜í™˜ ---
    function getPrefEmoji(value, period) {
      if (value === 0) return 'â€”';
      if (period === 'morning') return value === 1 ? 'ğŸŸ¡' : 'ğŸŸ¢';
      return value === 1 ? 'ğŸ”µ' : 'ğŸŸ£';
    }

    // ============================================
    // SCHEDULE TAB - ìŠ¤ì¼€ì¤„ íƒ­
    // ìˆ˜ì •: ìŠ¤ì¼€ì¤„ ë ˆì´ì•„ì›ƒ ë³€ê²½í•˜ë ¤ë©´ ì´ í•¨ìˆ˜!
    // ============================================
    function renderScheduleTab(t) {
      const hasSchedule = Object.keys(state.schedule).length > 0;

      return `
        <div style="display:flex;justify-content:space-between;margin-bottom:24px;">
          <h2 style="margin:0;font-size:24px;font-weight:600;">${t.schedule.title}</h2>
          ${!READ_ONLY ? `
            <button class="btn-primary" onclick="runScheduleGeneration()" ${state.generating ? 'disabled' : ''}>
              ${state.generating ? 'â³' : 'â–¶ï¸'} ${state.generating ? t.schedule.generating : t.schedule.runSchedule}
            </button>
          ` : ''}
        </div>

        ${!hasSchedule ? `
          <div style="padding:60px;text-align:center;background:#f9f9f9;border-radius:12px;border:2px dashed #ddd;">
            <div style="font-size:48px;margin-bottom:16px;">ğŸ“…</div>
            <p style="color:#999;font-size:16px;">${t.schedule.noSchedule}</p>
          </div>
        ` : `
          <div class="schedule-grid">
            ${DAYS.map(day => {
              const daySchedule = state.schedule[day] || {};
              const isHoliday = state.requirements[day]?.isHoliday;
              const req = state.requirements[day] || { lunch: {}, dinner: {} };
              
              // í•„ìš” ì¸ì› ê³„ì‚°
              const lunchNeed = (req.lunch.open || 0) + (req.lunch.eleven || 0) + (req.lunch.elevenThirty || 0);
              const dinnerNeed = (req.dinner.threeThirty || 0) + (req.dinner.six || 0);
              
              // ë°°ì •ëœ ì¸ì›
              const lunchAssigned = (daySchedule.lunch || []).length;
              const dinnerAssigned = (daySchedule.dinner || []).length;
              
              // All Day ì§ì› ì°¾ê¸°
              const lunchNames = (daySchedule.lunch || []).map(e => e.name);
              const dinnerNames = (daySchedule.dinner || []).map(e => e.name);
              const allDayPeople = lunchNames.filter(name => dinnerNames.includes(name));
              
              // Short/Over ì²´í¬
              const lunchDiff = lunchAssigned - lunchNeed;
              const dinnerDiff = dinnerAssigned - dinnerNeed;
              
              return `
                <div class="schedule-day ${isHoliday ? 'holiday' : ''}">
                  <h3>${t.days?.[day] || day} ${isHoliday ? 'ğŸ„' : ''}</h3>
                  
                  <!-- LUNCH SECTION -->
                  <div class="schedule-shift">
                    <h4 style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                      <span>â˜€ï¸ ${t.schedule.lunch}</span>
                      <div style="display:flex;align-items:center;gap:8px;">
                        <span style="font-size:11px;font-weight:normal;color:#666;">
                          ${lunchAssigned}/${lunchNeed}
                        </span>
                        <button onclick="showAvailable('${day}', 'lunch')" style="background:none;border:none;cursor:pointer;font-size:16px;padding:4px;" title="View available employees">
                          ğŸ”
                        </button>
                      </div>
                    </h4>
                    
                    ${lunchDiff < 0 ? `
                      <div style="padding:6px 10px;background:#FFEBEE;color:#C62828;border-radius:4px;margin-bottom:8px;font-size:12px;font-weight:600;">
                        âŒ SHORT: ${Math.abs(lunchDiff)} more needed!
                      </div>
                    ` : lunchDiff > 0 ? `
                      <div style="padding:6px 10px;background:#FFF3E0;color:#F57C00;border-radius:4px;margin-bottom:8px;font-size:12px;font-weight:600;">
                        âš ï¸ OVER: ${lunchDiff} extra assigned!
                      </div>
                    ` : lunchAssigned > 0 ? `
                      <div style="padding:4px 8px;background:#E8F5E9;color:#2E7D32;border-radius:4px;margin-bottom:8px;font-size:11px;font-weight:600;">
                        âœ… OK
                      </div>
                    ` : ''}
                    
                    ${(daySchedule.lunch || []).map(emp => {
                      const isAllDay = allDayPeople.includes(emp.name);
                      const fixedMark = emp.isFixed ? ' *' : '';
                      return `
                        <div class="schedule-person" style="${isAllDay ? 'font-weight:700;border-left:3px solid #D32F2F;' : ''}">
                          ${isAllDay ? 'ğŸ”´ ' : ''}${emp.name}${fixedMark} <span style="font-size:11px;color:#666;">(${emp.shift})</span>
                        </div>
                      `;
                    }).join('') || '<div style="color:#999;font-size:12px;padding:8px;">No assignments</div>'}
                  </div>

                  <!-- DINNER SECTION -->
                  <div class="schedule-shift">
                    <h4 style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                      <span>ğŸŒ™ ${t.schedule.dinner}</span>
                      <div style="display:flex;align-items:center;gap:8px;">
                        <span style="font-size:11px;font-weight:normal;color:#666;">
                          ${dinnerAssigned}/${dinnerNeed}
                        </span>
                        <button onclick="showAvailable('${day}', 'dinner')" style="background:none;border:none;cursor:pointer;font-size:16px;padding:4px;" title="View available employees">
                          ğŸ”
                        </button>
                      </div>
                    </h4>
                    
                    ${dinnerDiff < 0 ? `
                      <div style="padding:6px 10px;background:#FFEBEE;color:#C62828;border-radius:4px;margin-bottom:8px;font-size:12px;font-weight:600;">
                        âŒ SHORT: ${Math.abs(dinnerDiff)} more needed!
                      </div>
                    ` : dinnerDiff > 0 ? `
                      <div style="padding:6px 10px;background:#FFF3E0;color:#F57C00;border-radius:4px;margin-bottom:8px;font-size:12px;font-weight:600;">
                        âš ï¸ OVER: ${dinnerDiff} extra assigned!
                      </div>
                    ` : dinnerAssigned > 0 ? `
                      <div style="padding:4px 8px;background:#E8F5E9;color:#2E7D32;border-radius:4px;margin-bottom:8px;font-size:11px;font-weight:600;">
                        âœ… OK
                      </div>
                    ` : ''}
                    
                    ${(daySchedule.dinner || []).map(emp => {
                      const isAllDay = allDayPeople.includes(emp.name);
                      const fixedMark = emp.isFixed ? ' *' : '';
                      return `
                        <div class="schedule-person" style="${isAllDay ? 'font-weight:700;border-left:3px solid #D32F2F;' : ''}">
                          ${isAllDay ? 'ğŸ”´ ' : ''}${emp.name}${fixedMark} <span style="font-size:11px;color:#666;">(${emp.shift})</span>
                        </div>
                      `;
                    }).join('') || '<div style="color:#999;font-size:12px;padding:8px;">No assignments</div>'}
                  </div>

                  <!-- ALL DAY SUMMARY -->
                  ${allDayPeople.length > 0 ? `
                    <div style="margin-top:12px;padding:8px;background:${
                      req.allDayMax && allDayPeople.length > req.allDayMax 
                        ? '#FFEBEE' 
                        : '#FFF3E0'
                    };border-radius:6px;border-left:3px solid ${
                      req.allDayMax && allDayPeople.length > req.allDayMax 
                        ? '#C62828' 
                        : '#F57C00'
                    };">
                      <div style="font-size:11px;font-weight:600;color:${
                        req.allDayMax && allDayPeople.length > req.allDayMax 
                          ? '#C62828' 
                          : '#E65100'
                      };margin-bottom:4px;">
                        ğŸ“Š All Day: ${allDayPeople.length}${req.allDayMax ? `/${req.allDayMax}` : ''} 
                        ${req.allDayMax && allDayPeople.length > req.allDayMax 
                          ? `âš ï¸ (${allDayPeople.length - req.allDayMax} over - remove some Fixed)` 
                          : ''}
                      </div>
                      <div style="font-size:11px;color:#666;">
                        ${allDayPeople.join(', ')}
                      </div>
                    </div>
                  ` : ''}
                </div>
              `;
            }).join('')}
          </div>
        `}
      `;
    }

    // ============================================
    // ============================================
    // EXCEL VIEW TAB - ì—‘ì…€ ë·° íƒ­
    // ============================================
    function renderExcelViewTab(t) {
      // ë²ˆì—­ ì•ˆì „ ì ‘ê·¼
      const excelT = t.excelView || {};
      
      if (!state.schedule || Object.keys(state.schedule).length === 0) {
        return `
          <div style="padding:60px;text-align:center;">
            <div style="font-size:48px;margin-bottom:16px;">ğŸ“Š</div>
            <h3>${excelT.noSchedule || 'No schedule yet. Generate schedule first!'}</h3>
          </div>
        `;
      }

      // ì •í•´ì§„ ì§ì› ìˆœì„œ
      const employeeOrder = [
        'Aiden', 'Carlos', 'Edgar', 'Hung', 'Thanh', 'Tien', 'Tommy', 'Judy', 
        'Justin', 'Tina N', 'Alan', 'Chau', 'Le', 'Crystal', 'Tue', 'Cherry', 
        'Christine', 'Hieu', 'Kai', 'Dat', 'Johnny', 'Ly', 'Tho', 'Kha', 
        'Phung', 'Ye', 'Esther', 'Duc', 'Jimmy', 'Aca', 'Vivi', 'Catherine', 
        'Tiffany', 'Steven', 'Chris', 'Dung'
      ];

      // í™œì„± ì§ì› ì •ë ¬
      const orderedEmployees = [];
      employeeOrder.forEach(name => {
        const emp = state.employees.find(e => e.name === name && e.status === 'active');
        if (emp) orderedEmployees.push(emp);
      });

      // ìˆœì„œì— ì—†ëŠ” ì§ì› ì¶”ê°€
      state.employees.filter(e => e.status === 'active').forEach(emp => {
        if (!employeeOrder.includes(emp.name)) {
          orderedEmployees.push(emp);
        }
      });

      return `
        <div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <h2 style="margin:0;font-size:24px;font-weight:600;">${excelT.title || 'Excel View'}</h2>
            <button onclick="downloadExcel()" class="btn-primary" style="display:inline-flex;align-items:center;gap:8px;">
              ğŸ“¥ Download Excel
            </button>
          </div>
          
          <div style="overflow-x:auto;max-height:calc(100vh - 200px);border:3px solid #333;border-radius:8px;">
            <table style="width:100%;border-collapse:collapse;background:white;font-size:13px;">
              <thead style="position:sticky;top:0;z-index:10;">
                <tr style="background:#7f1d1d;color:white;">
                  <th style="padding:10px;border:2px solid #333;width:35px;position:sticky;left:0;background:#7f1d1d;z-index:11;">#</th>
                  <th style="padding:10px;border:2px solid #333;width:90px;position:sticky;left:35px;background:#7f1d1d;z-index:11;">Name</th>
                  ${DAYS.map(day => {
                    const dayT = TRANSLATIONS[state.language];
                    return `
                      <th style="padding:10px;border:2px solid #333;min-width:110px;">
                        ${dayT.days?.[day] || day}
                      </th>
                    `;
                  }).join('')}
                </tr>
              </thead>
              <tbody>
                ${orderedEmployees.map((emp, idx) => {
                  return `
                    <!-- Lunch Row -->
                    <tr>
                      <td rowspan="2" style="padding:8px;border:2px solid #333;text-align:center;background:#f0f0f0;font-weight:700;position:sticky;left:0;z-index:5;">${idx + 1}</td>
                      <td style="padding:8px;border:2px solid #333;font-weight:600;background:#FFF9E6;position:sticky;left:35px;z-index:5;">
                        ${emp.name}
                        <div style="font-size:10px;color:#666;font-weight:400;">Lunch</div>
                      </td>
                      ${DAYS.map(day => {
                        const daySchedule = state.schedule[day] || {};
                        const lunchShift = (daySchedule.lunch || []).find(e => e.id === emp.id);
                        
                        return `
                          <td onclick="editShift('${emp.id}', '${day}', 'lunch')" 
                              style="padding:8px;border:2px solid #333;cursor:pointer;text-align:center;
                                     background:${getShiftColor(lunchShift?.shift)};
                                     ${lunchShift ? 'font-weight:600;' : ''}
                                     transition:background 0.2s;">
                            ${lunchShift ? lunchShift.shift : ''}
                          </td>
                        `;
                      }).join('')}
                    </tr>
                    <!-- Dinner Row -->
                    <tr>
                      <td style="padding:8px;border:2px solid #333;font-weight:600;background:#E6F3FF;position:sticky;left:35px;z-index:5;">
                        ${emp.name}
                        <div style="font-size:10px;color:#666;font-weight:400;">Dinner</div>
                      </td>
                      ${DAYS.map(day => {
                        const daySchedule = state.schedule[day] || {};
                        const dinnerShift = (daySchedule.dinner || []).find(e => e.id === emp.id);
                        
                        return `
                          <td onclick="editShift('${emp.id}', '${day}', 'dinner')" 
                              style="padding:8px;border:2px solid #333;cursor:pointer;text-align:center;
                                     background:${getShiftColor(dinnerShift?.shift)};
                                     ${dinnerShift ? 'font-weight:600;' : ''}
                                     transition:background 0.2s;">
                            ${dinnerShift ? dinnerShift.shift : ''}
                          </td>
                        `;
                      }).join('')}
                    </tr>
                  `;
                }).join('')}
              </tbody>
              <tfoot style="position:sticky;bottom:0;background:white;z-index:8;">
                <tr style="background:#E8F5E9;font-weight:700;font-size:12px;">
                  <td colspan="2" style="padding:10px;border:2px solid #333;text-align:right;position:sticky;left:0;background:#E8F5E9;z-index:9;">
                    Lunch:
                  </td>
                  ${DAYS.map(day => {
                    const daySchedule = state.schedule[day] || {};
                    const lunchCount = (daySchedule.lunch || []).length;
                    return `
                      <td style="padding:10px;border:2px solid #333;text-align:center;color:#2E7D32;">${lunchCount}</td>
                    `;
                  }).join('')}
                </tr>
                <tr style="background:#E3F2FD;font-weight:700;font-size:12px;">
                  <td colspan="2" style="padding:10px;border:2px solid #333;text-align:right;position:sticky;left:0;background:#E3F2FD;z-index:9;">
                    Dinner:
                  </td>
                  ${DAYS.map(day => {
                    const daySchedule = state.schedule[day] || {};
                    const dinnerCount = (daySchedule.dinner || []).length;
                    return `
                      <td style="padding:10px;border:2px solid #333;text-align:center;color:#1565C0;">${dinnerCount}</td>
                    `;
                  }).join('')}
                </tr>
                <tr style="background:#FFF3E0;font-weight:700;font-size:12px;">
                  <td colspan="2" style="padding:10px;border:2px solid #333;text-align:right;position:sticky;left:0;background:#FFF3E0;z-index:9;">
                    All Day:
                  </td>
                  ${DAYS.map(day => {
                    const daySchedule = state.schedule[day] || {};
                    const lunchNames = (daySchedule.lunch || []).map(e => e.name);
                    const dinnerNames = (daySchedule.dinner || []).map(e => e.name);
                    const allDayCount = lunchNames.filter(name => dinnerNames.includes(name)).length;
                    return `
                      <td style="padding:10px;border:2px solid #333;text-align:center;color:#F57C00;">${allDayCount}</td>
                    `;
                  }).join('')}
                </tr>
              </tfoot>
            </table>
          </div>

          <div style="margin-top:16px;padding:12px;background:#E3F2FD;border-radius:8px;font-size:13px;">
            ğŸ’¡ <strong>Tip:</strong> Click any cell to edit shift. Use arrow keys or scroll to navigate.
          </div>
        </div>
      `;
    }

    // ì‹œí”„íŠ¸ ìƒ‰ìƒ ë°˜í™˜
    function getShiftColor(shift) {
      if (!shift) return '#ffffff';
      if (shift.includes('Open')) return '#FFD93D';  // ğŸŸ¡ ë…¸ë€ìƒ‰
      if (shift.includes('11:00') || shift.includes('11:30')) return '#6BCB77';  // ğŸŸ¢ ì´ˆë¡ìƒ‰
      if (shift.includes('3:30')) return '#4D96FF';  // ğŸ”µ íŒŒë€ìƒ‰
      if (shift.includes('6:00') || shift.includes('6 PM')) return '#9D4EDD';  // ğŸŸ£ ë³´ë¼ìƒ‰
      return '#ffffff';
    }

    // ì‹œí”„íŠ¸ ìƒ‰ìƒ ARGB ë°˜í™˜ (ExcelJSìš©)
    function getShiftColorARGB(shift) {
      if (!shift) return 'FFFFFFFF';
      if (shift.includes('Open')) return 'FFFFD93D';  // ğŸŸ¡ ë…¸ë€ìƒ‰
      if (shift.includes('11:00') || shift.includes('11:30')) return 'FF6BCB77';  // ğŸŸ¢ ì´ˆë¡ìƒ‰
      if (shift.includes('3:30')) return 'FF4D96FF';  // ğŸ”µ íŒŒë€ìƒ‰
      if (shift.includes('6:00') || shift.includes('6 PM')) return 'FF9D4EDD';  // ğŸŸ£ ë³´ë¼ìƒ‰
      return 'FFFFFFFF';
    }

    // SECTIONS TAB - ì„¹ì…˜ íƒ­
    // ============================================
    function renderTipsTab(t) {
      // Tips ì„œë¸Œíƒ­
      const tipsSubTab = state.tipsSubTab || 'entry';
      
      return `
        <div style="padding:20px;">
          <!-- ì„œë¸Œíƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
          ${READ_ONLY ? `
            <!-- READ_ONLY ëª¨ë“œ: Statisticsë§Œ í‘œì‹œ -->
            <div style="padding:20px;background:#fff7ed;border-radius:8px;margin-bottom:20px;border:2px solid #fbbf24;">
              <div style="display:flex;align-items:center;gap:12px;">
                <span style="font-size:1.5rem;">ğŸ”’</span>
                <div>
                  <div style="font-weight:700;color:#92400e;margin-bottom:4px;">Read-Only Mode</div>
                  <div style="color:#64748b;font-size:0.875rem;">You can only view tip statistics</div>
                </div>
              </div>
            </div>
          ` : `
            <div style="display:flex;gap:8px;margin-bottom:20px;border-bottom:2px solid #e2e8f0;padding-bottom:10px;">
              <button 
                onclick="setTipsSubTab('entry')" 
                style="padding:10px 20px;border:none;background:${tipsSubTab === 'entry' ? '#7f1d1d' : 'transparent'};color:${tipsSubTab === 'entry' ? 'white' : '#64748b'};border-radius:8px 8px 0 0;cursor:pointer;font-weight:600;">
                ğŸ“… Tip Entry
              </button>
              <button 
                onclick="setTipsSubTab('statistics')" 
                style="padding:10px 20px;border:none;background:${tipsSubTab === 'statistics' ? '#7f1d1d' : 'transparent'};color:${tipsSubTab === 'statistics' ? 'white' : '#64748b'};border-radius:8px 8px 0 0;cursor:pointer;font-weight:600;">
                ğŸ“Š Statistics
              </button>
              <button 
                onclick="setTipsSubTab('settlement')" 
                style="padding:10px 20px;border:none;background:${tipsSubTab === 'settlement' ? '#7f1d1d' : 'transparent'};color:${tipsSubTab === 'settlement' ? 'white' : '#64748b'};border-radius:8px 8px 0 0;cursor:pointer;font-weight:600;">
                ğŸ’° Settlement
              </button>
              <button 
                onclick="setTipsSubTab('history')" 
                style="padding:10px 20px;border:none;background:${tipsSubTab === 'history' ? '#7f1d1d' : 'transparent'};color:${tipsSubTab === 'history' ? 'white' : '#64748b'};border-radius:8px 8px 0 0;cursor:pointer;font-weight:600;">
                ğŸ“œ History
              </button>
            </div>
          `}
          
          <!-- ì„œë¸Œíƒ­ ë‚´ìš© -->
          ${READ_ONLY ? renderTipStatistics(t) : `
            ${tipsSubTab === 'entry' ? renderTipEntry(t) : ''}
            ${tipsSubTab === 'statistics' ? renderTipStatistics(t) : ''}
            ${tipsSubTab === 'settlement' ? renderTipSettlement(t) : ''}
            ${tipsSubTab === 'history' ? renderTipHistory(t) : ''}
          `}
        </div>
      `;
    }
    
    // Tip Entry íƒ­
    function renderTipEntry(t) {
      const step = state.tipEntryStep;
      
      // Step 0: ê¸°ì¡´ ë°ì´í„° ìˆ˜ì •/ì¶”ê°€ ëª¨ë“œ
      if (step === 'edit-existing') {
        return renderEditExistingTips();
      }
      
      // Step 1: ë‚ ì§œ ì„ íƒ
      if (step === 'select-date') {
        return renderTipCalendar();
      }
      
      // Step 2: ê·¼ë¬´ì ì„ íƒ (Lunch/Dinner í†µí•©)
      if (step === 'worker-select') {
        return renderWorkerSelection();
      }
      
      // Step 3: Lunch íŒ ì…ë ¥
      if (step === 'lunch-entry') {
        return renderTipInput('lunch');
      }
      
      // Step 4: Dinner íŒ ì…ë ¥
      if (step === 'dinner-entry') {
        return renderTipInput('dinner');
      }
    }
    
    // ê¸°ì¡´ íŒ ìˆ˜ì •/ì¶”ê°€ í™”ë©´
    function renderEditExistingTips() {
      const activeEmployees = state.employees
        .filter(e => e.status === 'active')
        .sort((a, b) => a.name.localeCompare(b.name)); // ì•ŒíŒŒë²³ìˆœ ì •ë ¬
      const lunchTips = state.lunchTips || {};
      const dinnerTips = state.dinnerTips || {};
      
      // ì•„ì§ ì¶”ê°€ ì•ˆ ëœ ì§ì›ë“¤ (ì•ŒíŒŒë²³ìˆœ ìœ ì§€)
      const lunchEmployees = activeEmployees.filter(emp => !lunchTips[emp.name]);
      const dinnerEmployees = activeEmployees.filter(emp => !dinnerTips[emp.name]);
      
      return `
        <div style="max-width:900px;margin:0 auto;padding:20px;">
          <h2 style="color:#7f1d1d;margin-bottom:8px;text-align:center;">âœï¸ Edit Tips</h2>
          <p style="text-align:center;color:#64748b;margin-bottom:30px;">
            ${(() => {
              const [year, month, day] = state.selectedTipDate.split('-');
              const date = new Date(year, month - 1, day);
              return date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            })()}
          </p>
          
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
            <!-- Lunch Tips -->
            <div>
              <h3 style="color:#92400e;margin-bottom:16px;display:flex;align-items:center;gap:8px;">
                <span>ğŸŒ</span>
                <span>Lunch Tips</span>
              </h3>
              
              <!-- ê¸°ì¡´ Lunch íŒ -->
              <div style="background:white;border-radius:8px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,0.1);margin-bottom:16px;">
                ${Object.keys(lunchTips).length > 0 ? 
                  Object.keys(lunchTips).sort((a, b) => a.localeCompare(b)).map(empName => `
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;padding:8px;background:#fef3c7;border-radius:6px;">
                      <span style="flex:1;font-weight:600;color:#2c3e50;">${empName}</span>
                      <div style="display:flex;align-items:center;gap:4px;">
                        <span style="color:#92400e;font-weight:600;">$</span>
                        <input type="number" 
                               step="0.01" 
                               value="${lunchTips[empName]}" 
                               onchange="updateExistingTip('lunch', '${empName}', this.value)"
                               style="width:90px;padding:6px;border:2px solid #fbbf24;border-radius:4px;text-align:right;background:white;">
                        <button onclick="deleteExistingTip('lunch', '${empName}')" 
                                style="padding:6px 10px;background:#ef4444;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:600;">
                          âœ•
                        </button>
                      </div>
                    </div>
                  `).join('') : 
                  '<p style="color:#64748b;text-align:center;padding:20px;font-size:0.875rem;">No lunch tips yet</p>'
                }
              </div>
              
              <!-- ìƒˆ Lunch íŒ ì¶”ê°€ -->
              ${lunchEmployees.length > 0 ? `
                <div style="background:#fff7ed;border-radius:8px;padding:16px;border:2px dashed #fbbf24;">
                  <div style="font-weight:600;color:#92400e;margin-bottom:12px;font-size:0.875rem;">â• Add Lunch Tip</div>
                  <div style="display:flex;gap:8px;margin-bottom:8px;">
                    <select id="newLunchEmployee" style="flex:1;padding:8px;border:2px solid #fbbf24;border-radius:6px;background:white;">
                      <option value="">Select employee...</option>
                      ${lunchEmployees.map(emp => `<option value="${emp.name}">${emp.name}</option>`).join('')}
                    </select>
                    <div style="display:flex;align-items:center;gap:4px;">
                      <span style="color:#92400e;font-weight:600;">$</span>
                      <input type="number" 
                             id="newLunchAmount" 
                             step="0.01" 
                             placeholder="0.00"
                             style="width:90px;padding:8px;border:2px solid #fbbf24;border-radius:6px;text-align:right;">
                    </div>
                  </div>
                  <button onclick="addNewTip('lunch')" 
                          style="width:100%;padding:10px;background:#fbbf24;color:#92400e;border:none;border-radius:6px;cursor:pointer;font-weight:700;">
                    â• Add
                  </button>
                </div>
              ` : '<p style="color:#64748b;text-align:center;padding:12px;font-size:0.875rem;background:#f8fafc;border-radius:6px;">All employees added</p>'}
            </div>
            
            <!-- Dinner Tips -->
            <div>
              <h3 style="color:#1e40af;margin-bottom:16px;display:flex;align-items:center;gap:8px;">
                <span>ğŸŒ™</span>
                <span>Dinner Tips</span>
              </h3>
              
              <!-- ê¸°ì¡´ Dinner íŒ -->
              <div style="background:white;border-radius:8px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,0.1);margin-bottom:16px;">
                ${Object.keys(dinnerTips).length > 0 ? 
                  Object.keys(dinnerTips).sort((a, b) => a.localeCompare(b)).map(empName => `
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;padding:8px;background:#dbeafe;border-radius:6px;">
                      <span style="flex:1;font-weight:600;color:#2c3e50;">${empName}</span>
                      <div style="display:flex;align-items:center;gap:4px;">
                        <span style="color:#1e40af;font-weight:600;">$</span>
                        <input type="number" 
                               step="0.01" 
                               value="${dinnerTips[empName]}" 
                               onchange="updateExistingTip('dinner', '${empName}', this.value)"
                               style="width:90px;padding:6px;border:2px solid #60a5fa;border-radius:4px;text-align:right;background:white;">
                        <button onclick="deleteExistingTip('dinner', '${empName}')" 
                                style="padding:6px 10px;background:#ef4444;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:600;">
                          âœ•
                        </button>
                      </div>
                    </div>
                  `).join('') : 
                  '<p style="color:#64748b;text-align:center;padding:20px;font-size:0.875rem;">No dinner tips yet</p>'
                }
              </div>
              
              <!-- ìƒˆ Dinner íŒ ì¶”ê°€ -->
              ${dinnerEmployees.length > 0 ? `
                <div style="background:#eff6ff;border-radius:8px;padding:16px;border:2px dashed #60a5fa;">
                  <div style="font-weight:600;color:#1e40af;margin-bottom:12px;font-size:0.875rem;">â• Add Dinner Tip</div>
                  <div style="display:flex;gap:8px;margin-bottom:8px;">
                    <select id="newDinnerEmployee" style="flex:1;padding:8px;border:2px solid #60a5fa;border-radius:6px;background:white;">
                      <option value="">Select employee...</option>
                      ${dinnerEmployees.map(emp => `<option value="${emp.name}">${emp.name}</option>`).join('')}
                    </select>
                    <div style="display:flex;align-items:center;gap:4px;">
                      <span style="color:#1e40af;font-weight:600;">$</span>
                      <input type="number" 
                             id="newDinnerAmount" 
                             step="0.01" 
                             placeholder="0.00"
                             style="width:90px;padding:8px;border:2px solid #60a5fa;border-radius:6px;text-align:right;">
                    </div>
                  </div>
                  <button onclick="addNewTip('dinner')" 
                          style="width:100%;padding:10px;background:#60a5fa;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:700;">
                    â• Add
                  </button>
                </div>
              ` : '<p style="color:#64748b;text-align:center;padding:12px;font-size:0.875rem;background:#f8fafc;border-radius:6px;">All employees added</p>'}
            </div>
          </div>
          
          <div style="display:flex;gap:12px;margin-top:30px;">
            <button onclick="state.tipEntryStep='select-date';render();" 
                    style="flex:1;padding:14px;background:white;color:#7f1d1d;border:2px solid #7f1d1d;border-radius:8px;cursor:pointer;font-weight:700;">
              â† Back to Calendar
            </button>
            <button onclick="saveEditedTips()" 
                    style="flex:2;padding:14px;background:#22c55e;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:1.1rem;">
              ğŸ’¾ Save Changes
            </button>
          </div>
        </div>
      `;
    }
    
    // ê¸°ì¡´ íŒ ì—…ë°ì´íŠ¸
    window.updateExistingTip = (shift, empName, amount) => {
      const value = parseFloat(amount) || 0;
      if (shift === 'lunch') {
        state.lunchTips[empName] = value;
      } else {
        state.dinnerTips[empName] = value;
      }
    };
    
    // ê¸°ì¡´ íŒ ì‚­ì œ
    window.deleteExistingTip = (shift, empName) => {
      if (confirm(`Delete ${empName}'s ${shift} tip?`)) {
        if (shift === 'lunch') {
          delete state.lunchTips[empName];
        } else {
          delete state.dinnerTips[empName];
        }
        render();
      }
    };
    
    // ìƒˆ íŒ ì¶”ê°€
    window.addNewTip = (shift) => {
      const employeeSelect = document.getElementById(`new${shift === 'lunch' ? 'Lunch' : 'Dinner'}Employee`);
      const amountInput = document.getElementById(`new${shift === 'lunch' ? 'Lunch' : 'Dinner'}Amount`);
      
      const empName = employeeSelect.value;
      const amount = parseFloat(amountInput.value) || 0;
      
      if (!empName) {
        alert('Please select an employee');
        return;
      }
      
      if (amount <= 0) {
        alert('Please enter a valid amount');
        return;
      }
      
      if (shift === 'lunch') {
        state.lunchTips[empName] = amount;
      } else {
        state.dinnerTips[empName] = amount;
      }
      
      render();
    };
    
    // ìˆ˜ì •ëœ íŒ ì €ì¥
    window.saveEditedTips = async () => {
      const date = state.selectedTipDate;
      
      // $0 ì œì™¸
      const filteredLunchTips = {};
      Object.keys(state.lunchTips).forEach(empName => {
        const amount = parseFloat(state.lunchTips[empName]) || 0;
        if (amount > 0) {
          filteredLunchTips[empName] = amount;
        }
      });
      
      const filteredDinnerTips = {};
      Object.keys(state.dinnerTips).forEach(empName => {
        const amount = parseFloat(state.dinnerTips[empName]) || 0;
        if (amount > 0) {
          filteredDinnerTips[empName] = amount;
        }
      });
      
      state.tipsData[date] = {
        lunch: filteredLunchTips,
        dinner: filteredDinnerTips
      };
      
      await storage.saveData('tips', state.tipsData);
      await updateTipStats();
      
      alert('âœ… Tips updated successfully!');
      state.tipEntryStep = 'select-date';
      state.selectedTipDate = null;
      render();
    };
    
    // ë‹¬ë ¥ ë Œë”ë§
    function renderTipCalendar() {
      const year = state.tipCalendarMonth.getFullYear();
      const month = state.tipCalendarMonth.getMonth();
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                          'July', 'August', 'September', 'October', 'November', 'December'];
      
      let calendar = '';
      let dayCount = 1;
      
      for (let week = 0; week < 6; week++) {
        let weekHtml = '<tr>';
        for (let day = 0; day < 7; day++) {
          if ((week === 0 && day < firstDay) || dayCount > daysInMonth) {
            weekHtml += '<td></td>';
          } else {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(dayCount).padStart(2, '0')}`;
            const hasTips = state.tipsData[dateStr];
            
            // ì˜¤ëŠ˜ ë‚ ì§œ ë¹„êµ (ë¡œì»¬ ì‹œê°„ëŒ€)
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            const isToday = dateStr === todayStr;
            
            weekHtml += `
              <td onclick="selectTipDate('${dateStr}')" 
                  style="padding:12px;text-align:center;cursor:pointer;border:1px solid #e2e8f0;
                         background:${isToday ? '#fff7ed' : 'white'};
                         position:relative;
                         ${hasTips ? 'font-weight:700;' : ''}">
                ${dayCount}
                ${hasTips ? '<div style="width:6px;height:6px;background:#7f1d1d;border-radius:50%;position:absolute;bottom:4px;left:50%;transform:translateX(-50%);"></div>' : ''}
              </td>
            `;
            dayCount++;
          }
        }
        weekHtml += '</tr>';
        calendar += weekHtml;
        if (dayCount > daysInMonth) break;
      }
      
      return `
        <div style="max-width:600px;margin:0 auto;padding:20px;">
          <h2 style="color:#7f1d1d;margin-bottom:20px;text-align:center;">ğŸ“… Select Date</h2>
          
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <button onclick="changeCalendarMonth(-1)" style="padding:8px 16px;background:#7f1d1d;color:white;border:none;border-radius:6px;cursor:pointer;">
              â† Prev
            </button>
            <h3 style="margin:0;">${monthNames[month]} ${year}</h3>
            <button onclick="changeCalendarMonth(1)" style="padding:8px 16px;background:#7f1d1d;color:white;border:none;border-radius:6px;cursor:pointer;">
              Next â†’
            </button>
          </div>
          
          <table style="width:100%;border-collapse:collapse;background:white;border-radius:8px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
            <thead>
              <tr style="background:#f8fafc;">
                <th style="padding:12px;color:#64748b;font-weight:600;">Sun</th>
                <th style="padding:12px;color:#64748b;font-weight:600;">Mon</th>
                <th style="padding:12px;color:#64748b;font-weight:600;">Tue</th>
                <th style="padding:12px;color:#64748b;font-weight:600;">Wed</th>
                <th style="padding:12px;color:#64748b;font-weight:600;">Thu</th>
                <th style="padding:12px;color:#64748b;font-weight:600;">Fri</th>
                <th style="padding:12px;color:#64748b;font-weight:600;">Sat</th>
              </tr>
            </thead>
            <tbody>
              ${calendar}
            </tbody>
          </table>
          
          <p style="text-align:center;color:#64748b;margin-top:20px;font-size:0.875rem;">
            â€¢ <span style="color:#7f1d1d;font-weight:700;">Bold dates</span> have tips recorded
          </p>
        </div>
      `;
    }
    
    // ë‹¬ë ¥ ì›” ë³€ê²½
    window.changeCalendarMonth = (delta) => {
      const newMonth = new Date(state.tipCalendarMonth);
      newMonth.setMonth(newMonth.getMonth() + delta);
      state.tipCalendarMonth = newMonth;
      render();
    };
    
    // ê·¼ë¬´ì ì„ íƒ í™”ë©´ (í†µí•©)
    function renderWorkerSelection() {
      const workers = state.lunchWorkers; // í•˜ë‚˜ì˜ ë¦¬ìŠ¤íŠ¸ë¡œ í†µí•©
      const activeEmployees = state.employees
        .filter(e => e.status === 'active')
        .sort((a, b) => a.name.localeCompare(b.name)); // ì•ŒíŒŒë²³ìˆœ ì •ë ¬
      
      if (activeEmployees.length === 0) {
        return `
          <div style="text-align:center;padding:60px;">
            <div style="font-size:48px;margin-bottom:16px;">ğŸ‘¥</div>
            <h2 style="color:#7f1d1d;margin-bottom:8px;">No Employees</h2>
            <p style="color:#64748b;">Please add employees first</p>
            <button onclick="state.tipEntryStep='select-date';render();" 
                    style="margin-top:20px;padding:10px 20px;background:#7f1d1d;color:white;border:none;border-radius:6px;cursor:pointer;">
              â† Back to Calendar
            </button>
          </div>
        `;
      }
      
      return `
        <div style="max-width:600px;margin:0 auto;padding:20px;">
          <h2 style="color:#7f1d1d;margin-bottom:8px;text-align:center;">ğŸ‘¥ Select Workers</h2>
          <p style="text-align:center;color:#64748b;margin-bottom:20px;">
            ${(() => {
              const [year, month, day] = state.selectedTipDate.split('-');
              const date = new Date(year, month - 1, day);
              return date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            })()}
          </p>
          <p style="text-align:center;color:#64748b;margin-bottom:30px;font-weight:600;">
            Select employees who worked (Lunch or Dinner)
          </p>
          
          <div style="background:white;border-radius:8px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
            ${activeEmployees.map(emp => {
              const isSelected = workers.includes(emp.name);
              return `
                <div onclick="toggleWorker('${emp.name}')" 
                     style="display:flex;align-items:center;gap:12px;padding:12px;margin-bottom:8px;
                            background:${isSelected ? '#f0fdf4' : '#f8fafc'};
                            border:2px solid ${isSelected ? '#22c55e' : '#e2e8f0'};
                            border-radius:8px;cursor:pointer;transition:all 0.2s;">
                  <div style="width:24px;height:24px;border-radius:4px;
                              background:${isSelected ? '#22c55e' : 'white'};
                              border:2px solid ${isSelected ? '#22c55e' : '#cbd5e1'};
                              display:flex;align-items:center;justify-content:center;
                              color:white;font-weight:700;font-size:16px;">
                    ${isSelected ? 'âœ“' : ''}
                  </div>
                  <span style="font-weight:600;color:#2c3e50;">${emp.name}</span>
                </div>
              `;
            }).join('')}
          </div>
          
          <div style="display:flex;gap:12px;margin-top:30px;">
            <button onclick="state.tipEntryStep='select-date';render();" 
                    style="flex:1;padding:12px;background:white;color:#7f1d1d;border:2px solid #7f1d1d;border-radius:8px;cursor:pointer;font-weight:600;">
              â† Back
            </button>
            <button onclick="proceedToLunchEntry()" 
                    style="flex:1;padding:12px;background:#7f1d1d;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;
                           ${workers.length === 0 ? 'opacity:0.5;cursor:not-allowed;' : ''}"
                    ${workers.length === 0 ? 'disabled' : ''}>
              Next: Enter Tips â†’
            </button>
          </div>
        </div>
      `;
    }
    
    // ê·¼ë¬´ì í† ê¸€ (í†µí•©)
    window.toggleWorker = (empName) => {
      const index = state.lunchWorkers.indexOf(empName);
      if (index === -1) {
        state.lunchWorkers.push(empName);
      } else {
        state.lunchWorkers.splice(index, 1);
      }
      render();
    };
    
    // Lunch ì…ë ¥ìœ¼ë¡œ ì§„í–‰
    window.proceedToLunchEntry = () => {
      if (state.lunchWorkers.length === 0) {
        alert('Please select at least one employee');
        return;
      }
      state.tipEntryStep = 'lunch-entry';
      render();
    };
    
    // íŒ ì…ë ¥ í™”ë©´
    function renderTipInput(shift) {
      const shiftName = shift === 'lunch' ? 'ğŸŒ Lunch' : 'ğŸŒ™ Dinner';
      const workers = state.lunchWorkers; // ì„ íƒëœ ì „ì²´ ê·¼ë¬´ì ì‚¬ìš©
      const tips = shift === 'lunch' ? state.lunchTips : state.dinnerTips;
      
      return `
        <div style="max-width:600px;margin:0 auto;padding:20px;">
          <h2 style="color:#7f1d1d;margin-bottom:8px;text-align:center;">${shiftName} Tips</h2>
          <p style="text-align:center;color:#64748b;margin-bottom:30px;">
            ${(() => {
              const [year, month, day] = state.selectedTipDate.split('-');
              const date = new Date(year, month - 1, day);
              return date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            })()}
          </p>
          
          <div style="background:white;border-radius:8px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
            ${workers.map(empName => `
              <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                <span style="flex:1;font-weight:600;color:#2c3e50;">${empName}</span>
                <div style="display:flex;align-items:center;gap:8px;">
                  <span style="color:#64748b;font-size:1.2rem;font-weight:600;">$</span>
                  <input type="number" 
                         step="0.01" 
                         value="${tips[empName] || ''}" 
                         onchange="set${shift === 'lunch' ? 'Lunch' : 'Dinner'}Tip('${empName}', this.value)"
                         placeholder="0.00"
                         style="width:120px;padding:10px;border:2px solid #e2e8f0;border-radius:6px;font-size:1rem;text-align:right;">
                </div>
              </div>
            `).join('')}
          </div>
          
          <p style="text-align:center;color:#64748b;margin-top:20px;font-size:0.875rem;">
            ğŸ’¡ Enter $0 if they didn't work this shift
          </p>
          
          <div style="display:flex;gap:12px;margin-top:30px;">
            <button onclick="state.tipEntryStep='worker-select';render();" 
                    style="flex:1;padding:12px;background:white;color:#7f1d1d;border:2px solid #7f1d1d;border-radius:8px;cursor:pointer;font-weight:600;">
              â† Back
            </button>
            <button onclick="confirmAnd${shift === 'lunch' ? 'SaveLunch' : 'SaveDinner'}Tips()" 
                    style="flex:1;padding:12px;background:#22c55e;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;">
              ${shift === 'lunch' ? 'ğŸ’¾ Save & Next' : 'âœ… Save'}
            </button>
          </div>
        </div>
      `;
    }
    
    // Lunch íŒ í™•ì¸ ë° ì €ì¥
    window.confirmAndSaveLunchTips = () => {
      const workers = state.lunchWorkers;
      const tips = state.lunchTips;
      
      // $0 ì œì™¸í•˜ê³  ì‹¤ì œ ì¼í•œ ì‚¬ëŒë§Œ í•„í„°ë§
      const workedList = workers
        .filter(name => (tips[name] || 0) > 0)
        .map(name => ({ name, amount: tips[name] || 0 }))
        .sort((a, b) => b.amount - a.amount); // ë†’ì€ ê°€ê²©ìˆœ
      
      if (workedList.length === 0) {
        if (confirm('No tips entered for Lunch. Skip Lunch and continue to Dinner?')) {
          state.tipEntryStep = 'dinner-entry';
          render();
        }
        return;
      }
      
      // ì´ì•¡ ê³„ì‚°
      const total = workedList.reduce((sum, w) => sum + w.amount, 0);
      
      // ì»¤ìŠ¤í…€ ëª¨ë‹¬ í‘œì‹œ
      state.confirmModal = {
        shift: 'lunch',
        workers: workedList,
        total: total,
        onConfirm: () => {
          state.confirmModal = null;
          saveLunchTips();
        },
        onCancel: () => {
          state.confirmModal = null;
          render();
        }
      };
      render();
    };
    
    // Dinner íŒ í™•ì¸ ë° ì €ì¥
    window.confirmAndSaveDinnerTips = () => {
      const workers = state.lunchWorkers;
      const tips = state.dinnerTips;
      
      // $0 ì œì™¸í•˜ê³  ì‹¤ì œ ì¼í•œ ì‚¬ëŒë§Œ í•„í„°ë§
      const workedList = workers
        .filter(name => (tips[name] || 0) > 0)
        .map(name => ({ name, amount: tips[name] || 0 }))
        .sort((a, b) => b.amount - a.amount); // ë†’ì€ ê°€ê²©ìˆœ
      
      if (workedList.length === 0) {
        if (confirm('No tips entered for Dinner. Save anyway?')) {
          saveDinnerTips();
        }
        return;
      }
      
      // ì´ì•¡ ê³„ì‚°
      const total = workedList.reduce((sum, w) => sum + w.amount, 0);
      
      // ì»¤ìŠ¤í…€ ëª¨ë‹¬ í‘œì‹œ
      state.confirmModal = {
        shift: 'dinner',
        workers: workedList,
        total: total,
        onConfirm: () => {
          state.confirmModal = null;
          saveDinnerTips();
        },
        onCancel: () => {
          state.confirmModal = null;
          render();
        }
      };
      render();
    };
    
    // Statistics íƒ­
    function renderTipStatistics(t) {
      const employees = Object.keys(state.tipStats);
      
      if (employees.length === 0) {
        return `
          <div style="text-align:center;padding:60px;">
            <div style="font-size:48px;margin-bottom:16px;">ğŸ“Š</div>
            <h2 style="color:#7f1d1d;margin-bottom:8px;">No Statistics Yet</h2>
            <p style="color:#64748b;">Enter tips first to see statistics</p>
          </div>
        `;
      }
      
      // ì „ì²´ í•©ê³„ ê³„ì‚°
      let totalPending = 0;
      let totalPaid = 0;
      let grandTotal = 0;
      
      employees.forEach(empName => {
        const stats = state.tipStats[empName];
        totalPending += stats.pending || 0;
        totalPaid += stats.paid || 0;
        grandTotal += stats.total || 0;
      });
      
      return `
        <div style="max-width:800px;margin:0 auto;padding:20px;">
          <h2 style="color:#7f1d1d;margin-bottom:30px;text-align:center;">ğŸ“Š Tip Statistics</h2>
          
          <!-- ì „ì²´ ìš”ì•½ -->
          <div style="background:linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%);color:white;border-radius:12px;padding:24px;margin-bottom:30px;box-shadow:0 4px 12px rgba(127,29,29,0.2);">
            <h3 style="margin:0 0 16px 0;font-size:1.1rem;opacity:0.9;">Overall Summary</h3>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:20px;">
              <div>
                <div style="font-size:0.875rem;opacity:0.9;margin-bottom:4px;">ğŸ’° Total (All)</div>
                <div style="font-size:1.75rem;font-weight:700;">$${grandTotal.toFixed(2)}</div>
              </div>
              <div>
                <div style="font-size:0.875rem;opacity:0.9;margin-bottom:4px;">â³ Pending</div>
                <div style="font-size:1.75rem;font-weight:700;">$${totalPending.toFixed(2)}</div>
              </div>
              <div>
                <div style="font-size:0.875rem;opacity:0.9;margin-bottom:4px;">âœ… Paid</div>
                <div style="font-size:1.75rem;font-weight:700;">$${totalPaid.toFixed(2)}</div>
              </div>
            </div>
          </div>
          
          <!-- ì§ì›ë³„ í†µê³„ -->
          <div style="display:grid;gap:16px;">
            ${employees.map(empName => {
              const stats = state.tipStats[empName];
              const emp = state.employees.find(e => e.name === empName);
              const isActive = emp && emp.status === 'active';
              
              return `
                <div style="background:white;border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1);border-left:4px solid ${isActive ? '#22c55e' : '#ef4444'};">
                  <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                    <div style="font-size:1.5rem;">ğŸ‘¤</div>
                    <div style="flex:1;">
                      <div style="font-size:1.25rem;font-weight:700;color:#2c3e50;">${empName}</div>
                      <div style="font-size:0.875rem;color:${isActive ? '#22c55e' : '#ef4444'};font-weight:600;">
                        ${isActive ? 'âœ“ Active' : 'âœ— Left'}
                      </div>
                    </div>
                  </div>
                  
                  <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;">
                    <div style="text-align:center;padding:12px;background:#f8fafc;border-radius:8px;">
                      <div style="font-size:0.75rem;color:#64748b;margin-bottom:4px;font-weight:600;">ğŸ’° TOTAL</div>
                      <div style="font-size:1.25rem;font-weight:700;color:#2c3e50;">$${stats.total.toFixed(2)}</div>
                    </div>
                    <div style="text-align:center;padding:12px;background:#fef3c7;border-radius:8px;">
                      <div style="font-size:0.75rem;color:#92400e;margin-bottom:4px;font-weight:600;">â³ PENDING</div>
                      <div style="font-size:1.25rem;font-weight:700;color:#92400e;">$${stats.pending.toFixed(2)}</div>
                    </div>
                    <div style="text-align:center;padding:12px;background:#d1fae5;border-radius:8px;">
                      <div style="font-size:0.75rem;color:#065f46;margin-bottom:4px;font-weight:600;">âœ… PAID</div>
                      <div style="font-size:1.25rem;font-weight:700;color:#065f46;">$${stats.paid.toFixed(2)}</div>
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }
    
    // Settlement íƒ­
    function renderTipSettlement(t) {
      // ì •ì‚° ìš”ì•½ì´ ìˆìœ¼ë©´ í‘œì‹œ
      if (state.settlementSummary) {
        return renderSettlementSummary();
      }
      
      return `
        <div style="max-width:700px;margin:0 auto;padding:20px;">
          <h2 style="color:#7f1d1d;margin-bottom:30px;text-align:center;">ğŸ’° Tip Settlement</h2>
          
          <div style="background:white;border-radius:12px;padding:30px;box-shadow:0 2px 12px rgba(0,0,0,0.1);">
            <h3 style="color:#2c3e50;margin:0 0 24px 0;font-size:1.1rem;">Settlement Period</h3>
            
            <div style="display:grid;gap:20px;margin-bottom:30px;">
              <div>
                <label style="display:block;color:#64748b;font-weight:600;margin-bottom:8px;font-size:0.875rem;">
                  ğŸ“… Start Date
                </label>
                <input type="date" 
                       value="${state.settlementStart}" 
                       onchange="state.settlementStart=this.value;render();"
                       style="width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:8px;font-size:1rem;">
              </div>
              
              <div>
                <label style="display:block;color:#64748b;font-weight:600;margin-bottom:8px;font-size:0.875rem;">
                  ğŸ“… End Date
                </label>
                <input type="date" 
                       value="${state.settlementEnd}" 
                       onchange="state.settlementEnd=this.value;render();"
                       style="width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:8px;font-size:1rem;">
              </div>
            </div>
            
            <button onclick="calculateSettlement()" 
                    style="width:100%;padding:14px;background:#7f1d1d;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:1rem;
                           ${!state.settlementStart || !state.settlementEnd ? 'opacity:0.5;cursor:not-allowed;' : ''}"
                    ${!state.settlementStart || !state.settlementEnd ? 'disabled' : ''}>
              ğŸ” Calculate Settlement
            </button>
          </div>
        </div>
      `;
    }
    
    // ì •ì‚° ìš”ì•½ í™”ë©´
    function renderSettlementSummary() {
      const summary = state.settlementSummary;
      const employees = Object.keys(summary.employees);
      let grandTotal = 0;
      
      employees.forEach(empName => {
        grandTotal += summary.employees[empName].total;
      });
      
      return `
        <div style="max-width:800px;margin:0 auto;padding:20px;">
          <h2 style="color:#7f1d1d;margin-bottom:8px;text-align:center;">ğŸ’° Settlement Summary</h2>
          <p style="text-align:center;color:#64748b;margin-bottom:30px;font-size:1rem;font-weight:600;">
            ${new Date(summary.startDate).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})} ~ 
            ${new Date(summary.endDate).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})}
          </p>
          
          <div style="display:grid;gap:16px;margin-bottom:30px;">
            ${employees.map(empName => {
              const empData = summary.employees[empName];
              const emp = state.employees.find(e => e.name === empName);
              const isActive = emp && emp.status === 'active';
              
              return `
                <div style="background:white;border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                  <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                    <div style="font-size:1.5rem;">ğŸ‘¤</div>
                    <div style="flex:1;">
                      <div style="font-size:1.25rem;font-weight:700;color:#2c3e50;">${empName}</div>
                      <div style="font-size:0.875rem;color:${isActive ? '#22c55e' : '#64748b'};font-weight:600;">
                        ${isActive ? 'Active' : 'Left'}
                      </div>
                    </div>
                    <div style="font-size:1.5rem;font-weight:700;color:#7f1d1d;">
                      $${empData.total.toFixed(2)}
                    </div>
                  </div>
                  
                  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <div style="background:#fef3c7;padding:12px;border-radius:8px;">
                      <div style="font-size:0.75rem;color:#92400e;margin-bottom:4px;font-weight:600;">ğŸŒ LUNCH</div>
                      <div style="font-size:1.1rem;font-weight:700;color:#92400e;">$${empData.lunch.toFixed(2)}</div>
                      <div style="font-size:0.75rem;color:#92400e;margin-top:4px;">
                        Days: ${empData.lunchDays.sort((a,b) => a-b).join(', ')}
                      </div>
                    </div>
                    <div style="background:#dbeafe;padding:12px;border-radius:8px;">
                      <div style="font-size:0.75rem;color:#1e40af;margin-bottom:4px;font-weight:600;">ğŸŒ™ DINNER</div>
                      <div style="font-size:1.1rem;font-weight:700;color:#1e40af;">$${empData.dinner.toFixed(2)}</div>
                      <div style="font-size:0.75rem;color:#1e40af;margin-top:4px;">
                        Days: ${empData.dinnerDays.sort((a,b) => a-b).join(', ')}
                      </div>
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
          
          <div style="background:linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%);color:white;border-radius:12px;padding:24px;margin-bottom:20px;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div style="font-size:1.25rem;font-weight:600;">ğŸ¯ Grand Total</div>
              <div style="font-size:2rem;font-weight:700;">$${grandTotal.toFixed(2)}</div>
            </div>
          </div>
          
          <div style="display:flex;gap:12px;">
            <button onclick="state.settlementSummary=null;render();" 
                    style="flex:1;padding:14px;background:white;color:#7f1d1d;border:2px solid #7f1d1d;border-radius:8px;cursor:pointer;font-weight:700;">
              â† Back
            </button>
            <button onclick="confirmSettlement()" 
                    style="flex:1;padding:14px;background:#22c55e;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:700;">
              âœ… Confirm Settlement
            </button>
          </div>
        </div>
      `;
    }
    
    // History íƒ­
    function renderTipHistory(t) {
      // ì„ íƒëœ ì •ì‚° ìƒì„¸
      if (state.selectedSettlement) {
        return renderSettlementDetail();
      }
      
      if (state.settlements.length === 0) {
        return `
          <div style="text-align:center;padding:60px;">
            <div style="font-size:48px;margin-bottom:16px;">ğŸ“œ</div>
            <h2 style="color:#7f1d1d;margin-bottom:8px;">No Settlement History</h2>
            <p style="color:#64748b;">Complete a settlement to see history</p>
          </div>
        `;
      }
      
      return `
        <div style="max-width:900px;margin:0 auto;padding:20px;">
          <h2 style="color:#7f1d1d;margin-bottom:30px;text-align:center;">ğŸ“œ Settlement History</h2>
          
          <div style="display:grid;gap:16px;">
            ${state.settlements.map(settlement => {
              const startDate = new Date(settlement.startDate).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'});
              const endDate = new Date(settlement.endDate).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'});
              const settledDate = new Date(settlement.settledAt).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'});
              const empCount = Object.keys(settlement.employees).length;
              
              return `
                <div onclick="selectSettlement('${settlement.id}')" 
                     style="background:white;border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1);cursor:pointer;transition:all 0.2s;border-left:4px solid #7f1d1d;"
                     onmouseover="this.style.boxShadow='0 4px 16px rgba(127,29,29,0.2)'"
                     onmouseout="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
                  <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px;">
                    <div style="flex:1;">
                      <div style="font-size:1.25rem;font-weight:700;color:#2c3e50;margin-bottom:4px;">
                        ${startDate} ~ ${endDate}
                      </div>
                      <div style="font-size:0.875rem;color:#64748b;">
                        Settled: ${settledDate}
                      </div>
                    </div>
                    <div style="text-align:right;">
                      <div style="font-size:1.75rem;font-weight:700;color:#7f1d1d;">
                        $${settlement.grandTotal.toFixed(2)}
                      </div>
                      <div style="font-size:0.875rem;color:#64748b;">
                        ${empCount} employee${empCount > 1 ? 's' : ''}
                      </div>
                    </div>
                  </div>
                  
                  <div style="display:flex;gap:8px;align-items:center;color:#7f1d1d;font-weight:600;font-size:0.875rem;">
                    <span>View Details</span>
                    <span>â†’</span>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }
    
    // ì •ì‚° ìƒì„¸ í™”ë©´
    function renderSettlementDetail() {
      const settlement = state.selectedSettlement;
      const employees = Object.keys(settlement.employees);
      
      const startDate = new Date(settlement.startDate).toLocaleDateString('en-US', {month: 'long', day: 'numeric', year: 'numeric'});
      const endDate = new Date(settlement.endDate).toLocaleDateString('en-US', {month: 'long', day: 'numeric', year: 'numeric'});
      const settledDate = new Date(settlement.settledAt).toLocaleDateString('en-US', {month: 'long', day: 'numeric', year: 'numeric'});
      
      return `
        <div style="max-width:800px;margin:0 auto;padding:20px;">
          <button onclick="closeSettlementDetail()" 
                  style="padding:8px 16px;background:white;color:#7f1d1d;border:2px solid #7f1d1d;border-radius:6px;cursor:pointer;font-weight:600;margin-bottom:20px;">
            â† Back to History
          </button>
          
          <h2 style="color:#7f1d1d;margin-bottom:8px;text-align:center;">ğŸ’° Settlement Details</h2>
          <div style="text-align:center;margin-bottom:30px;">
            <p style="color:#2c3e50;font-size:1.1rem;font-weight:600;margin-bottom:4px;">
              ${startDate} ~ ${endDate}
            </p>
            <p style="color:#64748b;font-size:0.875rem;">
              Settled on: ${settledDate}
            </p>
          </div>
          
          <div style="display:grid;gap:16px;margin-bottom:30px;">
            ${employees.map(empName => {
              const empData = settlement.employees[empName];
              const emp = state.employees.find(e => e.name === empName);
              const isActive = emp && emp.status === 'active';
              
              return `
                <div style="background:white;border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                  <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                    <div style="font-size:1.5rem;">ğŸ‘¤</div>
                    <div style="flex:1;">
                      <div style="font-size:1.25rem;font-weight:700;color:#2c3e50;">${empName}</div>
                      <div style="font-size:0.875rem;color:${isActive ? '#22c55e' : '#ef4444'};font-weight:600;">
                        ${isActive ? 'âœ“ Active' : `âœ— Left${emp && emp.leftDate ? ' (' + new Date(emp.leftDate).toLocaleDateString('en-US', {month: 'short', day: 'numeric'}) + ')' : ''}`}
                      </div>
                    </div>
                    <div style="font-size:1.5rem;font-weight:700;color:#7f1d1d;">
                      $${empData.total.toFixed(2)}
                    </div>
                  </div>
                  
                  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <div style="background:#fef3c7;padding:12px;border-radius:8px;">
                      <div style="font-size:0.75rem;color:#92400e;margin-bottom:4px;font-weight:600;">ğŸŒ LUNCH</div>
                      <div style="font-size:1.1rem;font-weight:700;color:#92400e;margin-bottom:6px;">$${empData.lunch.toFixed(2)}</div>
                      <div style="font-size:0.75rem;color:#92400e;">
                        ${empData.lunchDays && empData.lunchDays.length > 0 ? 
                          'â€¢ Days: ' + empData.lunchDays.sort((a,b) => a-b).join(', ') : 
                          'â€¢ No shifts'}
                      </div>
                    </div>
                    <div style="background:#dbeafe;padding:12px;border-radius:8px;">
                      <div style="font-size:0.75rem;color:#1e40af;margin-bottom:4px;font-weight:600;">ğŸŒ™ DINNER</div>
                      <div style="font-size:1.1rem;font-weight:700;color:#1e40af;margin-bottom:6px;">$${empData.dinner.toFixed(2)}</div>
                      <div style="font-size:0.75rem;color:#1e40af;">
                        ${empData.dinnerDays && empData.dinnerDays.length > 0 ? 
                          'â€¢ Days: ' + empData.dinnerDays.sort((a,b) => a-b).join(', ') : 
                          'â€¢ No shifts'}
                      </div>
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
          
          <div style="background:linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%);color:white;border-radius:12px;padding:24px;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div style="font-size:1.25rem;font-weight:600;">ğŸ¯ Grand Total</div>
              <div style="font-size:2rem;font-weight:700;">$${settlement.grandTotal.toFixed(2)}</div>
            </div>
          </div>
        </div>
      `;
    }

    // ============================================
    // CONFIRM MODAL - íŒ í™•ì¸ ëª¨ë‹¬
    // ============================================
    function renderConfirmModal() {
      const modal = state.confirmModal;
      const shiftName = modal.shift === 'lunch' ? 'ğŸŒ Lunch' : 'ğŸŒ™ Dinner';
      const shiftColor = modal.shift === 'lunch' ? '#fbbf24' : '#60a5fa';
      const shiftBg = modal.shift === 'lunch' ? '#fef3c7' : '#dbeafe';
      
      return `
        <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10000;padding:20px;">
          <div style="background:white;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.3);max-width:500px;width:100%;max-height:80vh;display:flex;flex-direction:column;">
            <!-- í—¤ë” -->
            <div style="padding:24px;border-bottom:2px solid #e2e8f0;background:${shiftBg};border-radius:16px 16px 0 0;">
              <h2 style="margin:0;color:#2c3e50;font-size:1.5rem;display:flex;align-items:center;gap:12px;">
                <span style="font-size:2rem;">${modal.shift === 'lunch' ? 'ğŸŒ' : 'ğŸŒ™'}</span>
                <span>${shiftName} Tips</span>
              </h2>
              <p style="margin:8px 0 0 0;color:#64748b;font-size:0.875rem;">
                ${modal.workers.length} worker${modal.workers.length > 1 ? 's' : ''} â€¢ Total: $${modal.total.toFixed(2)}
              </p>
            </div>
            
            <!-- ì§ì› ë¦¬ìŠ¤íŠ¸ -->
            <div style="flex:1;overflow-y:auto;padding:20px;">
              ${modal.workers.map((worker, i) => `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;margin-bottom:8px;background:#f8fafc;border-radius:8px;border-left:4px solid ${shiftColor};">
                  <div style="display:flex;align-items:center;gap:12px;">
                    <span style="font-weight:700;color:#64748b;font-size:0.875rem;min-width:30px;">#${i + 1}</span>
                    <span style="font-weight:600;color:#2c3e50;font-size:1rem;">${worker.name}</span>
                  </div>
                  <span style="font-weight:700;color:${modal.shift === 'lunch' ? '#92400e' : '#1e40af'};font-size:1.1rem;">
                    $${worker.amount.toFixed(2)}
                  </span>
                </div>
              `).join('')}
            </div>
            
            <!-- ì´ì•¡ -->
            <div style="padding:20px;border-top:2px solid #e2e8f0;background:#f8fafc;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <span style="font-size:1.25rem;font-weight:700;color:#2c3e50;">Grand Total</span>
                <span style="font-size:1.75rem;font-weight:700;color:#7f1d1d;">$${modal.total.toFixed(2)}</span>
              </div>
              
              <!-- ë²„íŠ¼ -->
              <div style="display:flex;gap:12px;">
                <button onclick="state.confirmModal.onCancel()" 
                        style="flex:1;padding:14px;background:white;color:#64748b;border:2px solid #e2e8f0;border-radius:8px;cursor:pointer;font-weight:700;font-size:1rem;">
                  Cancel
                </button>
                <button onclick="state.confirmModal.onConfirm()" 
                        style="flex:1;padding:14px;background:#22c55e;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:1rem;box-shadow:0 4px 12px rgba(34,197,94,0.3);">
                  âœ“ Confirm
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ============================================
    // MODAL - ì§ì› ì¶”ê°€/ìˆ˜ì • íŒì—…
    // ìˆ˜ì •: ëª¨ë‹¬ ë””ìì¸ ë³€ê²½í•˜ë ¤ë©´ ì´ í•¨ìˆ˜!
    // ============================================
    function renderModal(t) {
      const currentStatus = state.editingEmployee?.status || 'active';
      const cantWorkDetails = state.editingEmployee?.cantWorkDetails || {};
      
      return `
        <div class="modal show" onclick="if(event.target === this) closeModal()">
          <div class="modal-content">
            <h3 style="margin-top:0;">${state.editingEmployee ? 'Edit Employee' : t.employees.addEmployee}</h3>
            <form id="employee-form">
              <div class="form-group">
                <label>${t.employees.name} *</label>
                <input type="text" id="emp-name" required value="${state.editingEmployee?.name || ''}" autocomplete="off">
              </div>
              
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
                <div class="form-group" style="margin-bottom:0;">
                  <label>${t.employees.gender}</label>
                  <select id="emp-gender">
                    <option value="male" ${state.editingEmployee?.gender === 'male' ? 'selected' : ''}>${t.employees.male}</option>
                    <option value="female" ${state.editingEmployee?.gender === 'female' ? 'selected' : ''}>${t.employees.female}</option>
                  </select>
                </div>

                <div class="form-group" style="margin-bottom:0;">
                  <label>${t.employees.status}</label>
                  <select id="emp-status">
                    <option value="active" ${currentStatus === 'active' ? 'selected' : ''}>${t.employees.active}</option>
                    <option value="cantWork" ${currentStatus === 'cantWork' ? 'selected' : ''}>${t.employees.cantWork}</option>
                  </select>
                </div>
              </div>

              <div id="cant-work-details" style="display:${currentStatus === 'cantWork' ? 'block' : 'none'};padding:16px;background:#FFF3E0;border-radius:8px;margin-bottom:16px;">
                <h4 style="margin:0 0 12px 0;font-size:14px;font-weight:600;">${t.employees.cantWorkDetails}</h4>
                
                <div class="form-group" style="margin-bottom:12px;">
                  <label>${t.employees.reason}</label>
                  <select id="cant-work-reason">
                    <option value="Vacation" ${cantWorkDetails.reason === 'Vacation' ? 'selected' : ''}>Vacation</option>
                    <option value="Sick" ${cantWorkDetails.reason === 'Sick' ? 'selected' : ''}>Sick</option>
                    <option value="Out of Town" ${cantWorkDetails.reason === 'Out of Town' ? 'selected' : ''}>Out of Town</option>
                    <option value="Other" ${cantWorkDetails.reason === 'Other' ? 'selected' : ''}>Other</option>
                  </select>
                </div>

                <div class="form-group" style="margin-bottom:12px;">
                  <label>${t.employees.startDate}</label>
                  <input type="date" id="cant-work-start" value="${cantWorkDetails.startDate || ''}">
                </div>

                <div class="form-group" style="margin-bottom:0;">
                  <label>${t.employees.endDate}</label>
                  <input type="date" id="cant-work-end" value="${cantWorkDetails.endDate || ''}">
                </div>
              </div>

              <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:24px;">
                <button type="button" class="btn-secondary" onclick="closeModal()">
                  ${t.employees.cancel}
                </button>
                <button type="submit" class="btn-primary">
                  ${t.employees.save}
                </button>
              </div>
            </form>
          </div>
        </div>
      `;
    }

    // ============================================
    // EVENT LISTENERS - ì´ë²¤íŠ¸ ì²˜ë¦¬
    // ============================================
    function attachEventListeners() {
      // --- ì–¸ì–´ ì„ íƒ ---
      const langSelector = document.getElementById('language-selector');
      if (langSelector) {
        langSelector.addEventListener('change', (e) => {
          state.language = e.target.value;
          render();
        });
      }

      // --- íƒ­ ì „í™˜ ---
      document.querySelectorAll('[data-tab]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          state.activeTab = e.target.dataset.tab;
          render();
        });
      });

      // --- ì§ì› ì¶”ê°€ ë²„íŠ¼ ---
      const addBtn = document.getElementById('add-employee-btn');
      if (addBtn) {
        addBtn.addEventListener('click', () => {
          state.editingEmployee = null;
          state.showModal = true;
          render();
        });
      }

      // --- Status ë³€ê²½ ì‹œ Can't Work í•„ë“œ í‘œì‹œ/ìˆ¨ê¹€ ---
      const statusSelect = document.getElementById('emp-status');
      if (statusSelect) {
        statusSelect.addEventListener('change', (e) => {
          const cantWorkDetails = document.getElementById('cant-work-details');
          if (cantWorkDetails) {
            cantWorkDetails.style.display = e.target.value === 'cantWork' ? 'block' : 'none';
          }
        });
      }

      // --- ì§ì› í¼ ì œì¶œ ---
      const form = document.getElementById('employee-form');
      if (form) {
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const status = document.getElementById('emp-status').value;
          const empData = {
            id: state.editingEmployee?.id || Date.now(),
            name: document.getElementById('emp-name').value.trim(),
            gender: document.getElementById('emp-gender').value,
            status: status,
            availableSections: {
              'A-F': true,
              'G+Room': true,
              'H-L': true,
              'Helper': false,
              'MH': false,
              'FR': false
            },
            conflictWith: []
          };

          if (status === 'cantWork') {
            empData.cantWorkDetails = {
              reason: document.getElementById('cant-work-reason').value,
              startDate: document.getElementById('cant-work-start').value,
              endDate: document.getElementById('cant-work-end').value
            };
          }

          if (state.editingEmployee) {
            state.employees = state.employees.map(e => 
              e.id === empData.id ? empData : e
            );
          } else {
            state.employees.push(empData);
          }

          await saveEmployees();
          state.showModal = false;
          render();
        });
      }

      // --- Preferences ì§ì› ì„ íƒ ---
      const empSelector = document.getElementById('employee-selector');
      if (empSelector) {
        empSelector.addEventListener('change', (e) => {
          const empId = parseInt(e.target.value);
          state.selectedEmployee = state.employees.find(emp => emp.id === empId);
          render();
        });
      }
    }

    // ============================================
    // GLOBAL FUNCTIONS - onclickì—ì„œ í˜¸ì¶œ
    // ============================================
    
    // --- ì§ì› ìˆ˜ì • ---
    window.editEmployee = (id) => {
      state.editingEmployee = state.employees.find(e => e.id === id);
      state.showModal = true;
      render();
    };

    // --- ì§ì› ì‚­ì œ ---
    window.deleteEmployee = (id) => {
      if (confirm('Delete this employee?')) {
        state.employees = state.employees.filter(e => e.id !== id);
        saveEmployees();
        render();
      }
    };
    
    // ============================================
    // TIPS ê´€ë ¨ í•¨ìˆ˜
    // ============================================
    
    // Tips ì„œë¸Œíƒ­ ë³€ê²½
    window.setTipsSubTab = (tab) => {
      state.tipsSubTab = tab;
      render();
    };
    
    // ë‚ ì§œ ì„ íƒ
    window.selectTipDate = (dateStr) => {
      state.selectedTipDate = dateStr;
      
      // ê¸°ì¡´ íŒ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
      const existingTips = state.tipsData[dateStr];
      
      if (existingTips && (Object.keys(existingTips.lunch || {}).length > 0 || Object.keys(existingTips.dinner || {}).length > 0)) {
        // ê¸°ì¡´ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ìˆ˜ì •/ì¶”ê°€ ëª¨ë“œ
        state.tipEntryStep = 'edit-existing';
        state.lunchTips = {...existingTips.lunch || {}};
        state.dinnerTips = {...existingTips.dinner || {}};
      } else {
        // ìƒˆë¡œ ì…ë ¥
        state.tipEntryStep = 'worker-select';
        state.lunchTips = {};
        state.dinnerTips = {};
      }
      
      state.lunchWorkers = [];
      state.dinnerWorkers = [];
      render();
    };
    
    
    // Lunch íŒ ì…ë ¥
    window.setLunchTip = (empName, amount) => {
      state.lunchTips[empName] = parseFloat(amount) || 0;
    };
    
    // Dinner íŒ ì…ë ¥
    window.setDinnerTip = (empName, amount) => {
      state.dinnerTips[empName] = parseFloat(amount) || 0;
    };
    
    // Lunch íŒ ì €ì¥
    window.saveLunchTips = async () => {
      const date = state.selectedTipDate;
      if (!state.tipsData[date]) {
        state.tipsData[date] = { lunch: {}, dinner: {} };
      }
      
      // $0 ì œì™¸í•˜ê³  ì €ì¥
      const filteredLunchTips = {};
      Object.keys(state.lunchTips).forEach(empName => {
        const amount = parseFloat(state.lunchTips[empName]) || 0;
        if (amount > 0) {
          filteredLunchTips[empName] = amount;
        }
      });
      
      state.tipsData[date].lunch = filteredLunchTips;
      
      await storage.saveData('tips', state.tipsData);
      await updateTipStats();
      
      state.tipEntryStep = 'dinner-entry';
      render();
    };
    
    // Dinner íŒ ì €ì¥
    window.saveDinnerTips = async () => {
      const date = state.selectedTipDate;
      if (!state.tipsData[date]) {
        state.tipsData[date] = { lunch: {}, dinner: {} };
      }
      
      // $0 ì œì™¸í•˜ê³  ì €ì¥
      const filteredDinnerTips = {};
      Object.keys(state.dinnerTips).forEach(empName => {
        const amount = parseFloat(state.dinnerTips[empName]) || 0;
        if (amount > 0) {
          filteredDinnerTips[empName] = amount;
        }
      });
      
      state.tipsData[date].dinner = filteredDinnerTips;
      
      await storage.saveData('tips', state.tipsData);
      await updateTipStats();
      
      alert('Tips saved successfully!');
      state.tipEntryStep = 'select-date';
      state.selectedTipDate = null;
      render();
    };
    
    // íŒ í†µê³„ ì—…ë°ì´íŠ¸
    async function updateTipStats() {
      const stats = {};
      
      // ëª¨ë“  ì§ì› ì´ˆê¸°í™”
      state.employees.forEach(emp => {
        stats[emp.name] = {
          pending: 0,
          paid: state.tipStats[emp.name]?.paid || 0,
          total: 0
        };
      });
      
      // ëª¨ë“  ë‚ ì§œì˜ íŒ í•©ì‚°
      Object.keys(state.tipsData).forEach(date => {
        const dayTips = state.tipsData[date];
        
        // Lunch
        Object.keys(dayTips.lunch || {}).forEach(empName => {
          if (!stats[empName]) stats[empName] = { pending: 0, paid: 0, total: 0 };
          stats[empName].pending += dayTips.lunch[empName];
        });
        
        // Dinner
        Object.keys(dayTips.dinner || {}).forEach(empName => {
          if (!stats[empName]) stats[empName] = { pending: 0, paid: 0, total: 0 };
          stats[empName].pending += dayTips.dinner[empName];
        });
      });
      
      // Total ê³„ì‚°
      Object.keys(stats).forEach(empName => {
        stats[empName].total = stats[empName].pending + stats[empName].paid;
      });
      
      state.tipStats = stats;
      await storage.saveData('tipStats', stats);
    }
    
    // ì •ì‚° ê³„ì‚°
    window.calculateSettlement = () => {
      const start = state.settlementStart;
      const end = state.settlementEnd;
      
      if (!start || !end) {
        alert('Please select start and end dates');
        return;
      }
      
      const summary = {
        startDate: start,
        endDate: end,
        employees: {}
      };
      
      // ê¸°ê°„ ë‚´ íŒ í•©ì‚°
      Object.keys(state.tipsData).forEach(date => {
        if (date >= start && date <= end) {
          const dayTips = state.tipsData[date];
          
          // Lunch
          Object.keys(dayTips.lunch || {}).forEach(empName => {
            if (!summary.employees[empName]) {
              summary.employees[empName] = { 
                lunch: 0, 
                dinner: 0, 
                total: 0,
                lunchDays: [],
                dinnerDays: []
              };
            }
            summary.employees[empName].lunch += dayTips.lunch[empName];
            const day = new Date(date).getDate();
            summary.employees[empName].lunchDays.push(day);
          });
          
          // Dinner
          Object.keys(dayTips.dinner || {}).forEach(empName => {
            if (!summary.employees[empName]) {
              summary.employees[empName] = { 
                lunch: 0, 
                dinner: 0, 
                total: 0,
                lunchDays: [],
                dinnerDays: []
              };
            }
            summary.employees[empName].dinner += dayTips.dinner[empName];
            const day = new Date(date).getDate();
            summary.employees[empName].dinnerDays.push(day);
          });
        }
      });
      
      // Total ê³„ì‚°
      Object.keys(summary.employees).forEach(empName => {
        summary.employees[empName].total = 
          summary.employees[empName].lunch + 
          summary.employees[empName].dinner;
      });
      
      state.settlementSummary = summary;
      render();
    };
    
    // ì •ì‚° í™•ì •
    window.confirmSettlement = async () => {
      if (!confirm('Confirm this settlement?')) return;
      
      const summary = state.settlementSummary;
      const settlementRecord = {
        id: Date.now().toString(),
        ...summary,
        settledAt: new Date().toISOString(),
        grandTotal: 0
      };
      
      // Grand Total ê³„ì‚°
      Object.keys(summary.employees).forEach(empName => {
        settlementRecord.grandTotal += summary.employees[empName].total;
        
        // Paidì— ì¶”ê°€
        if (!state.tipStats[empName]) {
          state.tipStats[empName] = { pending: 0, paid: 0, total: 0 };
        }
        state.tipStats[empName].paid += summary.employees[empName].total;
      });
      
      // ì •ì‚° ê¸°ë¡ ì €ì¥
      state.settlements.unshift(settlementRecord);
      await storage.saveData('settlements', state.settlements);
      
      // ì •ì‚°ëœ íŒ ë°ì´í„° ì‚­ì œ
      Object.keys(state.tipsData).forEach(date => {
        if (date >= summary.startDate && date <= summary.endDate) {
          delete state.tipsData[date];
        }
      });
      await storage.saveData('tips', state.tipsData);
      
      // í†µê³„ ì—…ë°ì´íŠ¸
      await updateTipStats();
      
      alert('Settlement completed!');
      state.settlementSummary = null;
      state.settlementStart = '';
      state.settlementEnd = '';
      render();
    };
    
    // ì •ì‚° ì´ë ¥ ì„ íƒ
    window.selectSettlement = (id) => {
      state.selectedSettlement = state.settlements.find(s => s.id === id);
      render();
    };
    
    // ì •ì‚° ì´ë ¥ ë‹«ê¸°
    window.closeSettlementDetail = () => {
      state.selectedSettlement = null;
      render();
    };

    // --- ê°€ëŠ¥í•œ ì§ì› ë³´ê¸° (ë‹ë³´ê¸° ë²„íŠ¼) ---
    window.showAvailable = (day, period) => {
      const daySchedule = state.schedule[day] || {};
      const activeEmployees = state.employees.filter(e => e.status === 'active');
      
      // ì´ë¯¸ ë°°ì •ëœ ì§ì› ID
      const assignedIds = [
        ...(daySchedule.lunch || []).map(e => e.id),
        ...(daySchedule.dinner || []).map(e => e.id)
      ];
      
      // ë°°ì • ì•ˆ ëœ ì§ì›ë“¤
      const availableEmployees = activeEmployees.filter(emp => 
        !assignedIds.includes(emp.id)
      );
      
      // Preference ì •ë³´ í¬í•¨
      const employeesWithPrefs = availableEmployees.map(emp => {
        const prefs = state.preferences[emp.id]?.[day];
        let prefText = 'No preference';
        let prefColor = '#999';
        
        if (period === 'lunch' && prefs?.morning) {
          if (prefs.morning === 1) {
            prefText = 'ğŸŸ¡ Prefers Open';
            prefColor = '#FFD93D';
          } else if (prefs.morning === 2) {
            prefText = 'ğŸŸ¢ Prefers 11:00/11:30';
            prefColor = '#6BCB77';
          }
        } else if (period === 'dinner' && prefs?.evening) {
          if (prefs.evening === 1) {
            prefText = 'ğŸ”µ Prefers 3:30';
            prefColor = '#4D96FF';
          } else if (prefs.evening === 2) {
            prefText = 'ğŸŸ£ Prefers 6:00';
            prefColor = '#9D4EDD';
          }
        }
        
        return { emp, prefText, prefColor };
      });
      
      // ëª¨ë‹¬ ìƒì„±
      const t = TRANSLATIONS[state.language];
      const periodName = period === 'lunch' ? t.schedule.lunch : t.schedule.dinner;
      const dayName = t.days?.[day] || day;
      
      const modalHTML = `
        <div class="modal show" onclick="if(event.target === this) closeAvailableModal()">
          <div class="modal-content" style="max-width:600px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
              <h3 style="margin:0;">ğŸ” Available for ${dayName} ${periodName}</h3>
              <button onclick="closeAvailableModal()" style="background:none;border:none;font-size:24px;cursor:pointer;color:#666;">Ã—</button>
            </div>
            
            ${employeesWithPrefs.length === 0 ? `
              <div style="padding:40px;text-align:center;background:#f9f9f9;border-radius:12px;">
                <div style="font-size:48px;margin-bottom:16px;">âœ…</div>
                <p style="color:#666;font-size:16px;">All active employees are already assigned!</p>
              </div>
            ` : `
              <div style="max-height:400px;overflow-y:auto;">
                ${employeesWithPrefs.map(({ emp, prefText, prefColor }) => `
                  <div style="padding:12px;margin-bottom:8px;background:#f9f9f9;border-radius:8px;border-left:4px solid ${prefColor};">
                    <div style="font-weight:600;font-size:15px;margin-bottom:4px;">${emp.name}</div>
                    <div style="font-size:13px;color:#666;">${prefText}</div>
                  </div>
                `).join('')}
              </div>
              
              <div style="margin-top:20px;padding:12px;background:#E3F2FD;border-radius:8px;font-size:13px;">
                ğŸ’¡ <strong>Tip:</strong> These employees are not currently assigned to any shift on ${dayName}.
              </div>
            `}
          </div>
        </div>
      `;
      
      // ëª¨ë‹¬ í‘œì‹œ
      const existingModal = document.querySelector('.modal.show');
      if (existingModal) existingModal.remove();
      
      document.body.insertAdjacentHTML('beforeend', modalHTML);
    };
    
    // --- Excel ë‹¤ìš´ë¡œë“œ ---
    // --- Excel ë‹¤ìš´ë¡œë“œ (ExcelJS - ìƒ‰ìƒ ì™„ë²½ ì§€ì›!) ---
                window.downloadExcel = async () => {
      if (typeof ExcelJS === 'undefined') {
        alert('âŒ ExcelJS library not loaded!');
        return;
      }
      
      if (!state.schedule || Object.keys(state.schedule).length === 0) {
        alert('âš ï¸ No schedule yet!');
        return;
      }
    
      try {
        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet('Schedule');
    
        const employeeOrder = ['Aiden','Carlos','Edgar','Hung','Thanh','Tien','Tommy','Judy','Justin','Tina N','Alan','Chau','Le','Crystal','Tue','Cherry','Christine','Hieu','Kai','Dat','Johnny','Ly','Tho','Kha','Phung','Ye','Esther','Duc','Jimmy','Aca','Vivi','Catherine','Tiffany','Steven','Chris','Dung'];
        
        const orderedEmployees = [];
        employeeOrder.forEach(name => {
          const emp = state.employees.find(e => e.name === name && e.status === 'active');
          if (emp) orderedEmployees.push(emp);
        });
        state.employees.filter(e => e.status === 'active').forEach(emp => {
          if (!employeeOrder.includes(emp.name)) {
            orderedEmployees.push(emp);
          }
        });
    
        const columns = [{width:5},{width:15}];
        DAYS.forEach(() => columns.push({width:14}));
        worksheet.columns = columns;
    
        const totalCols = 2 + DAYS.length;
        const lastCol = String.fromCharCode(65 + totalCols - 1);
        
        // ë‹¤ìŒ ì£¼ ì›”ìš”ì¼ ê³„ì‚°
        const currentDate = new Date();
        const currentDay = currentDate.getDay(); // 0(ì¼) ~ 6(í† )
        const daysUntilNextMonday = currentDay === 0 ? 1 : (8 - currentDay); // ë‹¤ìŒ ì£¼ ì›”ìš”ì¼ê¹Œì§€ ë‚ ì§œ
        const nextMonday = new Date(currentDate);
        nextMonday.setDate(currentDate.getDate() + daysUntilNextMonday);
        
        // ì œëª© í–‰ ì œê±°í•˜ê³  ë°”ë¡œ ë‚ ì§œ í—¤ë”
        const dateHeaderRow = worksheet.getRow(1);
        dateHeaderRow.height = 20;
        
        // ë‚ ì§œ ë°ì´í„° ì¤€ë¹„ (ë‹¤ìŒ ì£¼ ì›”ìš”ì¼ë¶€í„° 7ì¼)
        const dates = DAYS.map((day, idx) => {
          const date = new Date(nextMonday);
          date.setDate(nextMonday.getDate() + idx);
          return `${date.getMonth() + 1}/${date.getDate()}`;
        });
        
        dateHeaderRow.values = ['','', ...dates];
        dateHeaderRow.eachCell((cell)=>{
          cell.fill = {type:'pattern',pattern:'solid',fgColor:{argb:'FF667eea'}};
          cell.font = {bold:true,color:{argb:'FFFFFFFF'},size:11};
          cell.alignment = {horizontal:'center',vertical:'middle'};
          cell.border = {top:{style:'thick'},left:{style:'thick'},bottom:{style:'thick'},right:{style:'thick'}};
        });
    
        const dayHeaderRow = worksheet.getRow(2);
        dayHeaderRow.height = 20;
        dayHeaderRow.values = ['','Name',...DAYS];
        dayHeaderRow.eachCell((cell)=>{
          cell.fill = {type:'pattern',pattern:'solid',fgColor:{argb:'FF667eea'}};
          cell.font = {bold:true,color:{argb:'FFFFFFFF'},size:11};
          cell.alignment = {horizontal:'center',vertical:'middle'};
          cell.border = {top:{style:'thick'},left:{style:'thick'},bottom:{style:'thick'},right:{style:'thick'}};
        });
    
        const shortDayRow = worksheet.getRow(3);
        shortDayRow.height = 18;
        shortDayRow.values = ['','', ...DAYS.map(d=>d.substring(0,3))];
        shortDayRow.eachCell((cell)=>{
          cell.fill = {type:'pattern',pattern:'solid',fgColor:{argb:'FF9D4EDD'}};
          cell.font = {bold:true,color:{argb:'FFFFFFFF'},size:10};
          cell.alignment = {horizontal:'center',vertical:'middle'};
          cell.border = {top:{style:'thick'},left:{style:'thick'},bottom:{style:'thick'},right:{style:'thick'}};
        });
    
        let currentRow = 4;
        orderedEmployees.forEach((emp,idx)=>{
          // ì§ìˆ˜/í™€ìˆ˜ë¡œ ë°°ê²½ìƒ‰ ë³€ê²½
          const isEven = idx % 2 === 0;
          const groupBgColor = isEven ? 'FFFFFFFF' : 'FFE0E0E0'; // í°ìƒ‰ / ì—°í•œ íšŒìƒ‰
    
          // Lunch Row
          const lunchRow = worksheet.getRow(currentRow);
          lunchRow.height = 18;
          
          // ë¨¼ì € ë³‘í•©
          worksheet.mergeCells('A'+currentRow+':A'+(currentRow+1));
          worksheet.mergeCells('B'+currentRow+':B'+(currentRow+1));
          
          // ë³‘í•© í›„ ì ˆëŒ€ ì¢Œí‘œë¡œ ê°’ ì„¤ì •
          worksheet.getCell('A'+currentRow).value = idx+1;
          worksheet.getCell('B'+currentRow).value = emp.name;
          
          // Lunch shift ê°’ ì„¤ì •
          DAYS.forEach((day, i)=>{
            const daySchedule = state.schedule[day]||{};
            const lunchShift = (daySchedule.lunch||[]).find(e=>e.id===emp.id);
            lunchRow.getCell(3+i).value = lunchShift ? lunchShift.shift : '';
          });
    
          // ë²ˆí˜¸ ì…€ ìŠ¤íƒ€ì¼
          const numCell = worksheet.getCell('A'+currentRow);
          numCell.fill = {type:'pattern',pattern:'solid',fgColor:{argb:'FFF0F0F0'}};
          numCell.font = {bold:true,size:10};
          numCell.alignment = {horizontal:'center',vertical:'middle'};
          numCell.border = {
            top:{style:'thick'},
            left:{style:'thick'},
            bottom:{style:'thick'},
            right:{style:'medium'}
          };
    
          // ì´ë¦„ ì…€ ìŠ¤íƒ€ì¼
          const nameCell = worksheet.getCell('B'+currentRow);
          nameCell.fill = {type:'pattern',pattern:'solid',fgColor:{argb:'FFF9F9F9'}};
          nameCell.font = {bold:true,size:14};
          nameCell.alignment = {horizontal:'center',vertical:'middle'};
          nameCell.border = {
            top:{style:'thick'},
            left:{style:'medium'},
            bottom:{style:'thick'},
            right:{style:'medium'}
          };
    
          // Lunch ì…€ ìŠ¤íƒ€ì¼
          for(let i=0; i<DAYS.length; i++){
            const day = DAYS[i];
            const daySchedule = state.schedule[day]||{};
            const lunchShift = (daySchedule.lunch||[]).find(e=>e.id===emp.id);
            const dinnerShift = (daySchedule.dinner||[]).find(e=>e.id===emp.id);
            const cell = lunchRow.getCell(3+i);
            
            if(lunchShift){
              let shiftText = lunchShift.shift;
              
              // Lunchê°€ "11:00~Break" ë˜ëŠ” "11:30~Break"ì´ê³ 
              // Dinnerê°€ "3:30~Close"ì¸ ê²½ìš° â†’ ë¹¨ê°„ìƒ‰ ì²˜ë¦¬
              const isLunchBreak = /^(11:00|11:30)~Break$/i.test(shiftText.trim());
              const isDinnerClose = dinnerShift && /^3:30~Close$/i.test(dinnerShift.shift.trim());
              
              if (isLunchBreak && isDinnerClose) {
                // ë¹¨ê°„ìƒ‰ + "~Break" ì œê±°
                const timeOnly = shiftText.replace(/~Break$/i, '').trim();
                cell.fill = {type:'pattern',pattern:'solid',fgColor:{argb:'FFFF0000'}};  // ë¹¨ê°„ìƒ‰
                cell.font = {bold:true,size:9,color:{argb:'FFFFFFFF'}};  // í°ìƒ‰ ê¸€ì”¨
                cell.value = timeOnly;
              } else {
                // í…ìŠ¤íŠ¸ ì œê±°: Open~Break, 6~Close, 6:00~Close
                let displayText = shiftText;
                if (/^Open~Break$/i.test(shiftText.trim())) {
                  displayText = '';  // Open~Break ì œê±°
                } else if (/^6:00~Close$/i.test(shiftText.trim())) {
                  displayText = '';  // 6:00~Close ì œê±°
                } else if (/^6~Close$/i.test(shiftText.trim())) {
                  displayText = '';  // 6~Close ì œê±°
                }
                
                // ì¼ë°˜ shift
                cell.fill = {type:'pattern',pattern:'solid',fgColor:{argb:getShiftColorARGB(shiftText)}};
                cell.font = {bold:true,size:9};
                cell.value = displayText;
              }
            } else {
              // ë¹ˆ ì…€ë„ ê·¸ë£¹ ë°°ê²½ìƒ‰
              cell.fill = {type:'pattern',pattern:'solid',fgColor:{argb:groupBgColor}};
            }
            
            cell.alignment = {horizontal:'center',vertical:'middle'};
            // ìœ„ìª½ë§Œ ë‘ê»ê²Œ, ë‚˜ë¨¸ì§€ ì–‡ê²Œ
            cell.border = {
              top:{style:'thick'},
              left:{style:'thin'},
              bottom:{style:'hair'},  // ë§¤ìš° ì–‡ì€ ì„ 
              right: i === DAYS.length-1 ? {style:'thick'} : {style:'thin'}
            };
          }
    
          currentRow++;
    
          // Dinner Row
          const dinnerRow = worksheet.getRow(currentRow);
          dinnerRow.height = 18;
          
          // ë²ˆí˜¸/ì´ë¦„ì€ ì´ë¯¸ ë³‘í•©ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ê±´ë“œë¦¬ì§€ ì•ŠìŒ!
          
          // Dinner shift ê°’ ì„¤ì •
          DAYS.forEach((day, i)=>{
            const daySchedule = state.schedule[day]||{};
            const dinnerShift = (daySchedule.dinner||[]).find(e=>e.id===emp.id);
            dinnerRow.getCell(3+i).value = dinnerShift ? dinnerShift.shift : '';
          });
    
          // Dinner ì…€ ìŠ¤íƒ€ì¼
          for(let i=0; i<DAYS.length; i++){
            const day = DAYS[i];
            const daySchedule = state.schedule[day]||{};
            const lunchShift = (daySchedule.lunch||[]).find(e=>e.id===emp.id);
            const dinnerShift = (daySchedule.dinner||[]).find(e=>e.id===emp.id);
            const cell = dinnerRow.getCell(3+i);
            
            if(dinnerShift){
              let shiftText = dinnerShift.shift;
              
              // Lunchê°€ "11:00~Break" ë˜ëŠ” "11:30~Break"ì´ê³ 
              // Dinnerê°€ "3:30~Close"ì¸ ê²½ìš° â†’ ë¹ˆì¹¸ ì²˜ë¦¬
              const isLunchBreak = lunchShift && /^(11:00|11:30)~Break$/i.test(lunchShift.shift.trim());
              const isDinnerClose = /^3:30~Close$/i.test(shiftText.trim());
              
              if (isLunchBreak && isDinnerClose) {
                // ë¹ˆì¹¸ìœ¼ë¡œ (ì•„ë¬´ê²ƒë„ í‘œì‹œ ì•ˆ í•¨)
                cell.fill = {type:'pattern',pattern:'solid',fgColor:{argb:groupBgColor}};
                cell.value = '';
              } else {
                // í…ìŠ¤íŠ¸ ì œê±°: 3:30~Close, 6~Close, 6:00~Close
                let displayText = shiftText;
                if (/^3:30~Close$/i.test(shiftText.trim())) {
                  displayText = '';  // 3:30~Close ì œê±°
                } else if (/^6:00~Close$/i.test(shiftText.trim())) {
                  displayText = '';  // 6:00~Close ì œê±°
                } else if (/^6~Close$/i.test(shiftText.trim())) {
                  displayText = '';  // 6~Close ì œê±°
                }
                
                // ì¼ë°˜ shift
                cell.fill = {type:'pattern',pattern:'solid',fgColor:{argb:getShiftColorARGB(shiftText)}};
                cell.font = {bold:true,size:9};
                cell.value = displayText;
              }
            } else {
              cell.fill = {type:'pattern',pattern:'solid',fgColor:{argb:groupBgColor}};
            }
            
            cell.alignment = {horizontal:'center',vertical:'middle'};
            // ì•„ë˜ìª½ë§Œ ë‘ê»ê²Œ, ë‚˜ë¨¸ì§€ ì–‡ê²Œ
            cell.border = {
              top:{style:'hair'},
              left:{style:'thin'},
              bottom:{style:'thick'},
              right: i === DAYS.length-1 ? {style:'thick'} : {style:'thin'}
            };
          }
    
          currentRow++;
        });
    
        currentRow++;
    
        // Lunch Count
        const lunchCountRow = worksheet.getRow(currentRow);
        lunchCountRow.height = 22;
        lunchCountRow.getCell(2).value = 'Lunch Count:';
        worksheet.mergeCells('A'+currentRow+':B'+currentRow);
        lunchCountRow.getCell(1).fill = {type:'pattern',pattern:'solid',fgColor:{argb:'FFE8F5E9'}};
        lunchCountRow.getCell(1).font = {bold:true,size:11};
        lunchCountRow.getCell(1).alignment = {horizontal:'right',vertical:'middle'};
        lunchCountRow.getCell(1).border = {top:{style:'thick'},left:{style:'thick'},bottom:{style:'thick'},right:{style:'thick'}};
        
        for(let i=0; i<DAYS.length; i++){
          const day = DAYS[i];
          const daySchedule = state.schedule[day]||{};
          const cell = lunchCountRow.getCell(3+i);
          cell.value = (daySchedule.lunch||[]).length;
          cell.fill = {type:'pattern',pattern:'solid',fgColor:{argb:'FFE8F5E9'}};
          cell.font = {bold:true,size:11,color:{argb:'FF2E7D32'}};
          cell.alignment = {horizontal:'center',vertical:'middle'};
          cell.border = {top:{style:'thick'},left:{style:'thick'},bottom:{style:'thick'},right:{style:'thick'}};
        }
    
        currentRow++;
    
        // Dinner Count
        const dinnerCountRow = worksheet.getRow(currentRow);
        dinnerCountRow.height = 22;
        dinnerCountRow.getCell(2).value = 'Dinner Count:';
        worksheet.mergeCells('A'+currentRow+':B'+currentRow);
        dinnerCountRow.getCell(1).fill = {type:'pattern',pattern:'solid',fgColor:{argb:'FFE3F2FD'}};
        dinnerCountRow.getCell(1).font = {bold:true,size:11};
        dinnerCountRow.getCell(1).alignment = {horizontal:'right',vertical:'middle'};
        dinnerCountRow.getCell(1).border = {top:{style:'thick'},left:{style:'thick'},bottom:{style:'thick'},right:{style:'thick'}};
        
        for(let i=0; i<DAYS.length; i++){
          const day = DAYS[i];
          const daySchedule = state.schedule[day]||{};
          const cell = dinnerCountRow.getCell(3+i);
          cell.value = (daySchedule.dinner||[]).length;
          cell.fill = {type:'pattern',pattern:'solid',fgColor:{argb:'FFE3F2FD'}};
          cell.font = {bold:true,size:11,color:{argb:'FF1565C0'}};
          cell.alignment = {horizontal:'center',vertical:'middle'};
          cell.border = {top:{style:'thick'},left:{style:'thick'},bottom:{style:'thick'},right:{style:'thick'}};
        }
    
        currentRow++;
    
        // All Day Count
        const allDayCountRow = worksheet.getRow(currentRow);
        allDayCountRow.height = 22;
        allDayCountRow.getCell(2).value = 'All Day Count:';
        worksheet.mergeCells('A'+currentRow+':B'+currentRow);
        allDayCountRow.getCell(1).fill = {type:'pattern',pattern:'solid',fgColor:{argb:'FFFFF3E0'}};
        allDayCountRow.getCell(1).font = {bold:true,size:11};
        allDayCountRow.getCell(1).alignment = {horizontal:'right',vertical:'middle'};
        allDayCountRow.getCell(1).border = {top:{style:'thick'},left:{style:'thick'},bottom:{style:'thick'},right:{style:'thick'}};
        
        for(let i=0; i<DAYS.length; i++){
          const day = DAYS[i];
          const daySchedule = state.schedule[day]||{};
          const lunchNames = (daySchedule.lunch||[]).map(e=>e.name);
          const dinnerNames = (daySchedule.dinner||[]).map(e=>e.name);
          const allDayCount = lunchNames.filter(name=>dinnerNames.includes(name)).length;
          const cell = allDayCountRow.getCell(3+i);
          cell.value = allDayCount;
          cell.fill = {type:'pattern',pattern:'solid',fgColor:{argb:'FFFFF3E0'}};
          cell.font = {bold:true,size:11,color:{argb:'FFF57C00'}};
          cell.alignment = {horizontal:'center',vertical:'middle'};
          cell.border = {top:{style:'thick'},left:{style:'thick'},bottom:{style:'thick'},right:{style:'thick'}};
        }
    
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
        const today = new Date().toISOString().split('T')[0];
        saveAs(blob,'Shabu_Zone_Schedule_'+today+'.xlsx');
        alert('âœ… Excel downloaded with colors!');
        
      } catch (error) {
        console.error('Excel download error:', error);
        alert('âŒ Error downloading Excel: ' + error.message);
      }
    };
    


    


    





    // --- ì‹œí”„íŠ¸ í¸ì§‘ (Excel View) ---
    window.editShift = (empId, day, period) => {
      const emp = state.employees.find(e => e.id === parseInt(empId));
      if (!emp) return;

      const daySchedule = state.schedule[day] || { lunch: [], dinner: [] };
      const currentShift = period === 'lunch' 
        ? daySchedule.lunch.find(e => e.id === emp.id)
        : daySchedule.dinner.find(e => e.id === emp.id);

      const t = TRANSLATIONS[state.language];
      const dayName = t.days?.[day] || day;
      const periodName = period === 'lunch' ? 'Lunch' : 'Dinner';

      // ê°€ëŠ¥í•œ ì‹œí”„íŠ¸ ì˜µì…˜
      const shiftOptions = period === 'lunch' 
        ? ['Open~Break', '11:00~Break', '11:30~Break']
        : ['3:30~Close', '6:00~Close'];

      const modalHTML = `
        <div class="modal show" onclick="if(event.target === this) closeShiftModal()">
          <div class="modal-content" style="max-width:500px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
              <h3 style="margin:0;">${dayName} ${periodName} - ${emp.name}</h3>
              <button onclick="closeShiftModal()" style="background:none;border:none;font-size:24px;cursor:pointer;color:#666;">Ã—</button>
            </div>

            ${currentShift ? `
              <div style="padding:12px;background:#E3F2FD;border-radius:8px;margin-bottom:20px;">
                <strong>Current:</strong> 
                <span style="padding:4px 12px;background:${getShiftColor(currentShift.shift)};border-radius:6px;display:inline-block;margin-left:8px;">
                  ${currentShift.shift}
                </span>
              </div>
            ` : `
              <div style="padding:12px;background:#FFF3E0;border-radius:8px;margin-bottom:20px;">
                <strong>Currently:</strong> OFF
              </div>
            `}

            <div style="margin-bottom:20px;">
              <h4 style="margin:0 0 12px 0;">Change to:</h4>
              ${shiftOptions.map(shift => `
                <button onclick="changeShift(${empId}, '${day}', '${period}', '${shift}')" 
                        style="display:block;width:100%;padding:12px;margin-bottom:8px;
                               background:${getShiftColor(shift)};border:2px solid #333;
                               border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;
                               ${currentShift?.shift === shift ? 'opacity:0.5;' : ''}">
                  ${shift}
                </button>
              `).join('')}
              <button onclick="changeShift(${empId}, '${day}', '${period}', '')" 
                      style="display:block;width:100%;padding:12px;background:white;
                             border:2px solid #ddd;border-radius:8px;cursor:pointer;
                             font-weight:600;color:#666;">
                OFF (Remove shift)
              </button>
            </div>

            <button onclick="showSwapOptions(${empId}, '${day}', '${period}')" 
                    class="btn-secondary" style="width:100%;padding:14px;font-size:15px;">
              ğŸ”„ Switch Employee
            </button>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHTML);
    };

    // --- ì‹œí”„íŠ¸ ë³€ê²½ ---
    window.changeShift = async (empId, day, period, newShift) => {
      const emp = state.employees.find(e => e.id === parseInt(empId));
      if (!emp) return;

      if (!state.schedule[day]) {
        state.schedule[day] = { lunch: [], dinner: [] };
      }

      const shifts = state.schedule[day][period];
      const existingIndex = shifts.findIndex(e => e.id === emp.id);

      if (newShift === '') {
        // Remove shift
        if (existingIndex !== -1) {
          shifts.splice(existingIndex, 1);
        }
      } else {
        // Add or update shift
        const shiftData = {
          name: emp.name,
          shift: newShift,
          id: emp.id,
          isFixed: false
        };

        if (existingIndex !== -1) {
          shifts[existingIndex] = shiftData;
        } else {
          shifts.push(shiftData);
        }
      }

      await saveSchedule();
      closeShiftModal();
      render();
    };

    // --- Switch ì˜µì…˜ í‘œì‹œ ---
    window.showSwapOptions = (empId, day, period) => {
      const emp = state.employees.find(e => e.id === parseInt(empId));
      if (!emp) return;

      const daySchedule = state.schedule[day] || { lunch: [], dinner: [] };
      const assignedIds = [...daySchedule.lunch.map(e => e.id), ...daySchedule.dinner.map(e => e.id)];

      const availableEmployees = state.employees
        .filter(e => e.status === 'active' && !assignedIds.includes(e.id))
        .map(e => {
          const prefs = state.preferences[e.id]?.[day];
          let prefText = 'No preference';
          let prefColor = '#999';

          if (period === 'lunch' && prefs?.morning) {
            if (prefs.morning === 1) {
              prefText = 'ğŸŸ¡ Prefers Open';
              prefColor = '#FFD93D';
            } else if (prefs.morning === 2) {
              prefText = 'ğŸŸ¢ Prefers 11:00/11:30';
              prefColor = '#6BCB77';
            }
          } else if (period === 'dinner' && prefs?.evening) {
            if (prefs.evening === 1) {
              prefText = 'ğŸ”µ Prefers 3:30';
              prefColor = '#4D96FF';
            } else if (prefs.evening === 2) {
              prefText = 'ğŸŸ£ Prefers 6:00';
              prefColor = '#9D4EDD';
            }
          }

          return { emp: e, prefText, prefColor };
        });

      const t = TRANSLATIONS[state.language];
      const dayName = t.days?.[day] || day;
      const periodName = period === 'lunch' ? 'Lunch' : 'Dinner';

      const currentShift = period === 'lunch'
        ? daySchedule.lunch.find(e => e.id === emp.id)
        : daySchedule.dinner.find(e => e.id === emp.id);

      const swapHTML = `
        <div class="modal show" onclick="if(event.target === this) closeShiftModal()">
          <div class="modal-content" style="max-width:600px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
              <h3 style="margin:0;">Switch ${emp.name} - ${dayName} ${periodName}</h3>
              <button onclick="closeShiftModal()" style="background:none;border:none;font-size:24px;cursor:pointer;color:#666;">Ã—</button>
            </div>

            ${availableEmployees.length === 0 ? `
              <div style="padding:40px;text-align:center;background:#f9f9f9;border-radius:12px;">
                <p style="color:#666;">No available employees for swap</p>
                <button onclick="editShift(${empId}, '${day}', '${period}')" class="btn-secondary" style="margin-top:16px;">
                  â† Back
                </button>
              </div>
            ` : `
              <p style="margin-bottom:16px;color:#666;">Click an employee to swap:</p>
              <div style="max-height:400px;overflow-y:auto;">
                ${availableEmployees.map(({ emp: availEmp, prefText, prefColor }) => `
                  <div onclick="swapEmployee(${empId}, ${availEmp.id}, '${day}', '${period}', '${currentShift?.shift || ''}')" 
                       style="padding:14px;margin-bottom:8px;background:#f9f9f9;border-radius:8px;
                              border-left:4px solid ${prefColor};cursor:pointer;
                              transition:background 0.2s;"
                       onmouseover="this.style.background='#e3f2fd'"
                       onmouseout="this.style.background='#f9f9f9'">
                    <div style="font-weight:600;font-size:15px;margin-bottom:4px;">${availEmp.name}</div>
                    <div style="font-size:13px;color:#666;">${prefText}</div>
                  </div>
                `).join('')}
              </div>
              <button onclick="editShift(${empId}, '${day}', '${period}')" class="btn-secondary" style="width:100%;margin-top:16px;">
                â† Back
              </button>
            `}
          </div>
        </div>
      `;

      const existingModal = document.querySelector('.modal.show');
      if (existingModal) existingModal.remove();
      document.body.insertAdjacentHTML('beforeend', swapHTML);
    };

    // --- ì§ì› êµì²´ ---
    window.swapEmployee = async (removeEmpId, addEmpId, day, period, currentShift) => {
      const removeEmp = state.employees.find(e => e.id === parseInt(removeEmpId));
      const addEmp = state.employees.find(e => e.id === parseInt(addEmpId));
      if (!removeEmp || !addEmp) return;

      if (!state.schedule[day]) {
        state.schedule[day] = { lunch: [], dinner: [] };
      }

      const shifts = state.schedule[day][period];

      // Remove old employee
      const removeIndex = shifts.findIndex(e => e.id === removeEmp.id);
      if (removeIndex !== -1) {
        shifts.splice(removeIndex, 1);
      }

      // Add new employee (keep same shift if exists, otherwise use preference)
      let newShift = currentShift;
      if (!newShift) {
        // Use first available shift option
        newShift = period === 'lunch' ? 'Open~Break' : '3:30~Close';
      }

      shifts.push({
        name: addEmp.name,
        shift: newShift,
        id: addEmp.id,
        isFixed: false
      });

      await saveSchedule();
      closeShiftModal();
      render();
    };

    // --- ì‹œí”„íŠ¸ ëª¨ë‹¬ ë‹«ê¸° ---
    window.closeShiftModal = () => {
      const modal = document.querySelector('.modal.show');
      if (modal) modal.remove();
    };

    // --- ê°€ëŠ¥í•œ ì§ì› ëª¨ë‹¬ ë‹«ê¸° ---
    window.closeAvailableModal = () => {
      const modal = document.querySelector('.modal.show');
      if (modal) modal.remove();
    };

    // --- ëª¨ë‹¬ ë‹«ê¸° ---
    window.closeModal = () => {
      state.showModal = false;
      render();
    };

    // --- Requirements ì—…ë°ì´íŠ¸ ---
    window.updateRequirement = (day, period, shift, value) => {
      state.requirements[day][period][shift] = parseInt(value) || 0;
      saveRequirements();
      render();
    };

    // --- All Day Max ì—…ë°ì´íŠ¸ ---
    window.updateAllDayMax = (day, value) => {
      state.requirements[day].allDayMax = parseInt(value) || 0;
      saveRequirements();
      render();
    };

    // --- Holiday í† ê¸€ ---
    window.toggleHoliday = (day) => {
      state.requirements[day].isHoliday = !state.requirements[day].isHoliday;
      saveRequirements();
      render();
    };

    // --- Preference ìˆœí™˜ (0 â†’ 1 â†’ 2 â†’ 0) ---
    window.cyclePreference = (day, period) => {
      if (!state.selectedEmployee) return;
      
      const empId = state.selectedEmployee.id;
      if (!state.preferences[empId]) {
        state.preferences[empId] = {};
      }
      if (!state.preferences[empId][day]) {
        state.preferences[empId][day] = { morning: 0, evening: 0, morningFixed: false, eveningFixed: false };
      }
      
      const current = state.preferences[empId][day][period] || 0;
      const newValue = (current + 1) % 3;
      state.preferences[empId][day][period] = newValue;
      
      // ìƒ‰ê¹”ì´ ë¹ˆì¹¸(0)ìœ¼ë¡œ ëŒì•„ê°€ë©´ Fixedë„ ìë™ìœ¼ë¡œ í•´ì œ
      if (newValue === 0) {
        state.preferences[empId][day][period + 'Fixed'] = false;
      }
      
      render();
    };

    // --- Fixed í† ê¸€ ---
    window.toggleFixed = (day, period) => {
      if (!state.selectedEmployee) return;
      
      const empId = state.selectedEmployee.id;
      if (!state.preferences[empId]) {
        state.preferences[empId] = {};
      }
      if (!state.preferences[empId][day]) {
        state.preferences[empId][day] = { morning: 0, evening: 0, morningFixed: false, eveningFixed: false };
      }
      
      const fixedKey = period + 'Fixed';
      state.preferences[empId][day][fixedKey] = !state.preferences[empId][day][fixedKey];
      
      render();
    };

    // --- Preferences ì €ì¥ ---
    window.saveCurrentPreferences = async () => {
      if (!state.selectedEmployee) return;
      
      const empId = state.selectedEmployee.id;
      const minGuarantee = parseInt(document.getElementById('min-guarantee').value) || 0;
      
      state.preferences[empId] = {
        ...state.preferences[empId],
        minGuarantee,
        savedAt: new Date().toISOString()
      };
      
      await savePreferences();
      alert('âœ… Saved!');
      render();
    };

    // ============================================
    // SCHEDULE GENERATION - ìŠ¤ì¼€ì¤„ ìƒì„± ì•Œê³ ë¦¬ì¦˜
    // ìˆ˜ì •: ìŠ¤ì¼€ì¤„ ë¡œì§ ë³€ê²½í•˜ë ¤ë©´ ì´ í•¨ìˆ˜!
    // ============================================
    window.runScheduleGeneration = async () => {
      state.generating = true;
      render();

      await new Promise(resolve => setTimeout(resolve, 500));

      const newSchedule = {};
      const activeEmployees = state.employees.filter(e => e.status === 'active');

      // Holidayì¸ ë‚ ë“¤ ì°¾ê¸°
      const holidayDays = DAYS.filter(day => state.requirements[day].isHoliday);

      // ì§ì›ë³„ ì‹œí”„íŠ¸ ì¹´ìš´íŠ¸ ì¶”ì 
      const employeeShiftCount = {};
      activeEmployees.forEach(emp => {
        employeeShiftCount[emp.id] = 0;
      });

      // ========================================
      // ë°°ì • í—¬í¼ í•¨ìˆ˜
      // ========================================
      
      // ëœë¤ ì„ê¸°
      const shuffle = (array) => {
        const arr = [...array];
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
      };

      // Shift ìë™ ì„ íƒ (ìœ ë™ì„±)
      const getFlexibleShift = (prefValue, period, needs) => {
        if (period === 'morning') {
          // ğŸŸ¡ ë…¸ë€ìƒ‰ (Open ì„ í˜¸)
          if (prefValue === 1) {
            if (needs.open > 0) return { shift: 'Open~Break', type: 'open' };
            if (needs.eleven > 0) return { shift: '11:00~Break', type: 'eleven' };
            if (needs.elevenThirty > 0) return { shift: '11:30~Break', type: 'elevenThirty' };
          }
          // ğŸŸ¢ ì´ˆë¡ìƒ‰ (11ì‹œ ì„ í˜¸)
          else if (prefValue === 2) {
            if (needs.eleven > 0) return { shift: '11:00~Break', type: 'eleven' };
            if (needs.elevenThirty > 0) return { shift: '11:30~Break', type: 'elevenThirty' };
            if (needs.open > 0) return { shift: 'Open~Break', type: 'open' };
          }
        } else if (period === 'evening') {
          // ğŸ”µ íŒŒë€ìƒ‰ (3:30 ì„ í˜¸)
          if (prefValue === 1) {
            if (needs.threeThirty > 0) return { shift: '3:30~Close', type: 'threeThirty' };
            if (needs.six > 0) return { shift: '6:00~Close', type: 'six' };
          }
          // ğŸŸ£ ë³´ë¼ìƒ‰ (6ì‹œë§Œ)
          else if (prefValue === 2) {
            if (needs.six > 0) return { shift: '6:00~Close', type: 'six' };
            if (needs.threeThirty > 0) return { shift: '3:30~Close', type: 'threeThirty' };
          }
        }
        return null;
      };

      // ========================================
      // ê° ìš”ì¼ë³„ ìŠ¤ì¼€ì¤„ ìƒì„±
      // ========================================
      DAYS.forEach(day => {
        const req = state.requirements[day];
        const isHoliday = req.isHoliday;
        
        newSchedule[day] = {
          lunch: [],
          dinner: []
        };

        // Remaining needs (ë™ì ìœ¼ë¡œ ê°ì†Œ)
        const remainingNeeds = {
          lunch: {
            open: req.lunch.open || 0,
            eleven: req.lunch.eleven || 0,
            elevenThirty: req.lunch.elevenThirty || 0
          },
          dinner: {
            threeThirty: req.dinner.threeThirty || 0,
            six: req.dinner.six || 0
          }
        };

        const totalLunchNeed = remainingNeeds.lunch.open + remainingNeeds.lunch.eleven + remainingNeeds.lunch.elevenThirty;
        const totalDinnerNeed = remainingNeeds.dinner.threeThirty + remainingNeeds.dinner.six;

        // ì´ë¯¸ ë°°ì •ëœ ì§ì› ì¶”ì 
        const assignedEmployees = new Set();

        // ========================================
        // STEP 1: Fixed ì‹œí”„íŠ¸ ë°°ì • (ë¬´ì¡°ê±´!)
        // ========================================
        activeEmployees.forEach(emp => {
          const prefs = state.preferences[emp.id]?.[day];
          if (!prefs) return;

          // Morning Fixed
          if (prefs.morning > 0 && prefs.morningFixed) {
            const result = getFlexibleShift(prefs.morning, 'morning', remainingNeeds.lunch);
            if (result) {
              newSchedule[day].lunch.push({ 
                name: emp.name, 
                shift: result.shift, 
                id: emp.id, 
                isFixed: true 
              });
              remainingNeeds.lunch[result.type]--;
              employeeShiftCount[emp.id]++;
              assignedEmployees.add(emp.id);
            }
          }

          // Evening Fixed
          if (prefs.evening > 0 && prefs.eveningFixed) {
            const result = getFlexibleShift(prefs.evening, 'evening', remainingNeeds.dinner);
            if (result) {
              newSchedule[day].dinner.push({ 
                name: emp.name, 
                shift: result.shift, 
                id: emp.id, 
                isFixed: true 
              });
              remainingNeeds.dinner[result.type]--;
              employeeShiftCount[emp.id]++;
              assignedEmployees.add(emp.id);
            }
          }
        });

        // ========================================
        // STEP 2: Min Guarantee ë¶€ì¡±í•œ ì‚¬ëŒ ìš°ì„ 
        // ========================================
        const empWithMinGuarantee = activeEmployees
          .filter(emp => {
            if (assignedEmployees.has(emp.id)) return false;
            const prefs = state.preferences[emp.id];
            const minGuarantee = prefs?.minGuarantee || 0;
            return minGuarantee > 0 && employeeShiftCount[emp.id] < minGuarantee;
          })
          .map(emp => ({
            emp,
            deficit: (state.preferences[emp.id]?.minGuarantee || 0) - employeeShiftCount[emp.id],
            prefs: state.preferences[emp.id]?.[day]
          }))
          .sort((a, b) => b.deficit - a.deficit); // ë¶€ì¡±í•œ ìˆœ

        empWithMinGuarantee.forEach(({ emp, prefs }) => {
          if (!prefs) return;

          // Morning (Fixed ì•„ë‹Œ ê²ƒë§Œ)
          if (prefs.morning > 0 && !prefs.morningFixed) {
            const total = remainingNeeds.lunch.open + remainingNeeds.lunch.eleven + remainingNeeds.lunch.elevenThirty;
            if (total > 0) {
              const result = getFlexibleShift(prefs.morning, 'morning', remainingNeeds.lunch);
              if (result) {
                newSchedule[day].lunch.push({ 
                  name: emp.name, 
                  shift: result.shift, 
                  id: emp.id, 
                  isFixed: false 
                });
                remainingNeeds.lunch[result.type]--;
                employeeShiftCount[emp.id]++;
                assignedEmployees.add(emp.id);
              }
            }
          }

          // Evening (Fixed ì•„ë‹Œ ê²ƒë§Œ)
          if (prefs.evening > 0 && !prefs.eveningFixed) {
            const total = remainingNeeds.dinner.threeThirty + remainingNeeds.dinner.six;
            if (total > 0) {
              const result = getFlexibleShift(prefs.evening, 'evening', remainingNeeds.dinner);
              if (result) {
                newSchedule[day].dinner.push({ 
                  name: emp.name, 
                  shift: result.shift, 
                  id: emp.id, 
                  isFixed: false 
                });
                remainingNeeds.dinner[result.type]--;
                employeeShiftCount[emp.id]++;
                assignedEmployees.add(emp.id);
              }
            }
          }
        });

        // ========================================
        // STEP 3: ëœë¤ ë°°ì • (Fixed ì—†ëŠ” ì‚¬ëŒ ìš°ì„ )
        // ========================================
        
        // Fixedê°€ í•˜ë‚˜ë„ ì—†ëŠ” ì‚¬ëŒ
        const noFixedEmployees = shuffle(activeEmployees.filter(emp => {
          if (assignedEmployees.has(emp.id)) return false;
          const allPrefs = state.preferences[emp.id];
          if (!allPrefs) return true;
          
          // ëª¨ë“  ë‚ ì§œ ì²´í¬í•´ì„œ Fixedê°€ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ì œì™¸
          const hasAnyFixed = DAYS.some(d => {
            const dayPref = allPrefs[d];
            return dayPref && (dayPref.morningFixed || dayPref.eveningFixed);
          });
          return !hasAnyFixed;
        }));

        // ëœë¤ ë°°ì • - Fixed ì—†ëŠ” ì‚¬ëŒ
        noFixedEmployees.forEach(emp => {
          const prefs = state.preferences[emp.id]?.[day];
          
          // Morning
          const lunchTotal = remainingNeeds.lunch.open + remainingNeeds.lunch.eleven + remainingNeeds.lunch.elevenThirty;
          if (lunchTotal > 0 && prefs?.morning > 0 && !prefs.morningFixed) {
            const result = getFlexibleShift(prefs.morning, 'morning', remainingNeeds.lunch);
            if (result) {
              newSchedule[day].lunch.push({ 
                name: emp.name, 
                shift: result.shift, 
                id: emp.id, 
                isFixed: false 
              });
              remainingNeeds.lunch[result.type]--;
              employeeShiftCount[emp.id]++;
              assignedEmployees.add(emp.id);
            }
          }

          // Evening
          const dinnerTotal = remainingNeeds.dinner.threeThirty + remainingNeeds.dinner.six;
          if (dinnerTotal > 0 && prefs?.evening > 0 && !prefs.eveningFixed) {
            const result = getFlexibleShift(prefs.evening, 'evening', remainingNeeds.dinner);
            if (result) {
              newSchedule[day].dinner.push({ 
                name: emp.name, 
                shift: result.shift, 
                id: emp.id, 
                isFixed: false 
              });
              remainingNeeds.dinner[result.type]--;
              employeeShiftCount[emp.id]++;
              assignedEmployees.add(emp.id);
            }
          }
        });

        // ========================================
        // STEP 4: ì—¬ì „íˆ ë¶€ì¡±í•˜ë©´ Fixed ìˆëŠ” ì‚¬ëŒë„ ëœë¤
        // ========================================
        const remainingEmployees = shuffle(activeEmployees.filter(emp => !assignedEmployees.has(emp.id)));

        remainingEmployees.forEach(emp => {
          const prefs = state.preferences[emp.id]?.[day];
          
          // Morning
          const lunchTotal = remainingNeeds.lunch.open + remainingNeeds.lunch.eleven + remainingNeeds.lunch.elevenThirty;
          if (lunchTotal > 0 && prefs?.morning > 0 && !prefs.morningFixed) {
            const result = getFlexibleShift(prefs.morning, 'morning', remainingNeeds.lunch);
            if (result) {
              newSchedule[day].lunch.push({ 
                name: emp.name, 
                shift: result.shift, 
                id: emp.id, 
                isFixed: false 
              });
              remainingNeeds.lunch[result.type]--;
              employeeShiftCount[emp.id]++;
              assignedEmployees.add(emp.id);
            }
          }

          // Evening
          const dinnerTotal = remainingNeeds.dinner.threeThirty + remainingNeeds.dinner.six;
          if (dinnerTotal > 0 && prefs?.evening > 0 && !prefs.eveningFixed) {
            const result = getFlexibleShift(prefs.evening, 'evening', remainingNeeds.dinner);
            if (result) {
              newSchedule[day].dinner.push({ 
                name: emp.name, 
                shift: result.shift, 
                id: emp.id, 
                isFixed: false 
              });
              remainingNeeds.dinner[result.type]--;
              employeeShiftCount[emp.id]++;
              assignedEmployees.add(emp.id);
            }
          }
        });

        // ========================================
        // STEP 5: Holiday ì²˜ë¦¬
        // ========================================
        if (isHoliday) {
          const unassigned = shuffle(activeEmployees.filter(emp => !assignedEmployees.has(emp.id)));
          
          unassigned.forEach(emp => {
            const lunchTotal = remainingNeeds.lunch.open + remainingNeeds.lunch.eleven + remainingNeeds.lunch.elevenThirty;
            const dinnerTotal = remainingNeeds.dinner.threeThirty + remainingNeeds.dinner.six;
            
            if (lunchTotal > 0) {
              const shift = remainingNeeds.lunch.open > 0 ? 'Open~Break' : 
                           remainingNeeds.lunch.eleven > 0 ? '11:00~Break' : '11:30~Break';
              const type = remainingNeeds.lunch.open > 0 ? 'open' : 
                          remainingNeeds.lunch.eleven > 0 ? 'eleven' : 'elevenThirty';
              
              newSchedule[day].lunch.push({ 
                name: emp.name, 
                shift, 
                id: emp.id, 
                isFixed: false 
              });
              remainingNeeds.lunch[type]--;
              employeeShiftCount[emp.id]++;
              assignedEmployees.add(emp.id);
            } else if (dinnerTotal > 0) {
              const shift = remainingNeeds.dinner.threeThirty > 0 ? '3:30~Close' : '6:00~Close';
              const type = remainingNeeds.dinner.threeThirty > 0 ? 'threeThirty' : 'six';
              
              newSchedule[day].dinner.push({ 
                name: emp.name, 
                shift, 
                id: emp.id, 
                isFixed: false 
              });
              remainingNeeds.dinner[type]--;
              employeeShiftCount[emp.id]++;
              assignedEmployees.add(emp.id);
            }
          });
        }
      });

      state.schedule = newSchedule;
      await saveSchedule();
      state.generating = false;
      render();
    };

    // ============================================
    // ì•± ì‹œì‘!
    // ============================================
    loadInitialData();
  </script>
</body>
</html>
