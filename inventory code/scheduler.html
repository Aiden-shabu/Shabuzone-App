<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Shabu Zone Schedule Manager</title>
  
  <!-- ExcelJS for Excel export with colors -->
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  
  <!-- Firebase v8 SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  
  <!-- ============================================ -->
  <!-- CSS STYLES - Ïä§ÌÉÄÏùº Ï†ïÏùò -->
  <!-- ============================================ -->
  <style>
    /* --- Í∏∞Î≥∏ Î¶¨ÏÖã --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    /* --- Body Ï†ÑÏ≤¥ Î∞∞Í≤Ω --- */
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f5f5f0;
      min-height: 100vh;
      padding: 10px;
      overflow-x: hidden;
      -webkit-tap-highlight-color: transparent;
    }
    
    @media (max-width: 768px) {
      body {
        padding: 5px;
      }
    }
    
    /* --- Î©îÏù∏ Ïª®ÌÖåÏù¥ÎÑà --- */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    /* --- Ìó§Îçî (Ï†úÎ™© + Ïñ∏Ïñ¥ ÏÑ†ÌÉù) --- */
    .header {
      background: linear-gradient(135deg, #7f1d1d, #991b1b);
      padding: 20px;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    .header h1 { 
      font-size: clamp(20px, 5vw, 36px);
      font-weight: 700;
    }
    
    @media (max-width: 768px) {
      .header {
        padding: 15px;
      }
      .header h1 {
        font-size: 24px;
      }
    }
    .header .subtitle { font-size: 13px; opacity: 0.9; margin-top: 8px; }
    .header select {
      padding: 10px 16px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
    }
    
    /* --- ÌÉ≠ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò --- */
    .tabs {
      display: flex;
      border-bottom: 2px solid #e8e8e8;
      background: white;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .tabs::-webkit-scrollbar {
      display: none;
    }
    .tab {
      flex: 1;
      min-width: 100px;
      padding: 16px 12px;
      border: none;
      background: transparent;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-weight: 500;
      color: #6b7280;
      font-size: 14px;
      transition: all 0.3s ease;
      white-space: nowrap;
    }
    
    @media (max-width: 768px) {
      .tab {
        padding: 12px 10px;
        font-size: 13px;
        min-width: 80px;
      }
    }
    .tab:hover {
      background: #fafafa;
      color: #374151;
    }
    .tab.active {
      background: #fef5f5;
      border-bottom: 3px solid #7f1d1d;
      font-weight: 600;
      color: #7f1d1d;
    }
    
    /* --- ÏΩòÌÖêÏ∏† ÏòÅÏó≠ --- */
    .content { 
      padding: 20px;
      min-height: 500px;
    }
    
    @media (max-width: 768px) {
      .content {
        padding: 15px 10px;
        min-height: auto;
      }
    }
    
    /* --- Î≤ÑÌäº Ïä§ÌÉÄÏùº --- */
    .btn-primary {
      padding: 12px 20px;
      background: linear-gradient(135deg, #7f1d1d, #991b1b);
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 15px;
      min-height: 44px;
      touch-action: manipulation;
    }
    .btn-primary:hover { opacity: 0.9; }
    .btn-primary:active { transform: scale(0.98); }
    
    .btn-secondary {
      padding: 10px 16px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      min-height: 40px;
      touch-action: manipulation;
    }
    .btn-secondary:active { background: #f5f5f5; }
    
    @media (max-width: 768px) {
      .btn-primary {
        padding: 10px 16px;
        font-size: 14px;
        width: 100%;
      }
      .btn-secondary {
        padding: 8px 12px;
        font-size: 13px;
      }
    }
    
    /* --- Î°úÎî© ÌôîÎ©¥ --- */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      color: #7f1d1d;
      font-size: 24px;
      font-weight: 600;
    }
    
    /* --- ÏßÅÏõê Í∑∏Î¶¨Îìú --- */
    .employee-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
      margin-top: 24px;
    }
    
    @media (max-width: 768px) {
      .employee-grid {
        grid-template-columns: 1fr;
        gap: 12px;
        margin-top: 16px;
      }
    }
    
    /* --- ÏßÅÏõê Ïπ¥Îìú --- */
    .employee-card {
      padding: 16px;
      background: white;
      border-radius: 12px;
      border: 1px solid #e8e8e8;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      transition: box-shadow 0.2s;
    }
    .employee-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .employee-card h3 { 
      margin: 0 0 8px 0;
      font-size: 17px;
      font-weight: 600;
      color: #2c3e50;
      word-break: break-word;
    }
    
    @media (max-width: 768px) {
      .employee-card {
        padding: 12px;
      }
      .employee-card h3 {
        font-size: 16px;
      }
    }
    
    /* --- Î∞∞ÏßÄ (ÏÑ±Î≥Ñ, ÏÉÅÌÉú) --- */
    .badge {
      padding: 4px 10px;
      color: white;
      border-radius: 6px;
      font-size: 12px;
      margin-right: 8px;
      display: inline-block;
      font-weight: 500;
    }
    .badge-male { background: #3b82f6; }
    .badge-female { background: #ec4899; }
    .badge-active { background: #10b981; }
    .badge-cant-work { background: #f59e0b; }
    
    /* --- Ìèº Í∑∏Î£π --- */
    .form-group { margin-bottom: 16px; }
    .form-group label { 
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      font-size: 14px;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 16px;
      -webkit-appearance: none;
      appearance: none;
    }
    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #7f1d1d;
    }
    
    @media (max-width: 768px) {
      .form-group input, .form-group select {
        padding: 14px 12px;
        font-size: 16px;
      }
    }
    
    /* --- Î™®Îã¨ (ÌåùÏóÖ) --- */
    .modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 10px;
    }
    .modal.show { display: flex; }
    .modal-content {
      background: white;
      padding: 24px;
      border-radius: 16px;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    @media (max-width: 768px) {
      .modal {
        padding: 0;
        align-items: flex-end;
      }
      .modal-content {
        padding: 20px 16px;
        border-radius: 16px 16px 0 0;
        max-height: 95vh;
        width: 100%;
      }
    }
    
    /* --- Requirements ÌÖåÏù¥Î∏î --- */
    .requirements-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      display: table;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .requirements-table th,
    .requirements-table td {
      padding: 10px 8px;
      border: 1px solid #ddd;
      text-align: center;
      font-size: 14px;
    }
    .requirements-table th { 
      background: #f5f5f5;
      font-weight: 600;
      white-space: nowrap;
    }
    .requirements-table input[type="number"] {
      width: 50px;
      padding: 6px 4px;
      text-align: center;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    @media (max-width: 768px) {
      .requirements-table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }
      .requirements-table th,
      .requirements-table td {
        padding: 8px 6px;
        font-size: 13px;
      }
      .requirements-table input[type="number"] {
        width: 45px;
        font-size: 13px;
      }
    }
    
    /* --- Preferences ÌÖåÏù¥Î∏î --- */
    .preferences-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      display: table;
    }
    .preferences-table th,
    .preferences-table td {
      padding: 10px 8px;
      border: 1px solid #e0e0e0;
      font-size: 14px;
    }
    .preferences-table th { 
      background: #f5f5f5;
      font-weight: 600;
      white-space: nowrap;
    }
    
    .pref-button {
      width: 70px;
      height: 38px;
      border: 2px solid #ddd;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 16px;
      touch-action: manipulation;
    }
    .pref-button:active {
      transform: scale(0.95);
    }
    
    @media (max-width: 768px) {
      .preferences-table {
        display: block;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        white-space: nowrap;
      }
      .preferences-table th,
      .preferences-table td {
        padding: 8px 6px;
        font-size: 13px;
      }
      .pref-button {
        width: 60px;
        height: 36px;
        font-size: 15px;
      }
    }
    
    /* --- Schedule Í∑∏Î¶¨Îìú --- */
    .schedule-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 12px;
      margin-top: 20px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    @media (max-width: 1200px) {
      .schedule-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }
    
    @media (max-width: 768px) {
      .schedule-grid {
        grid-template-columns: 1fr;
        gap: 10px;
      }
    }
    
    .schedule-day {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 12px;
      min-height: 250px;
    }
    
    .schedule-day.holiday {
      background: #FFF3E0;
      border-color: #FF9800;
    }
    
    .schedule-day h3 {
      margin: 0 0 10px 0;
      font-size: 15px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e0e0e0;
    }
    
    @media (max-width: 768px) {
      .schedule-day {
        padding: 12px;
        min-height: auto;
      }
      .schedule-day h3 {
        font-size: 16px;
        font-weight: 700;
      }
    }
    
    .schedule-shift {
      margin-bottom: 12px;
    }
    
    .schedule-shift h4 {
      font-size: 13px;
      color: #666;
      margin-bottom: 6px;
      font-weight: 600;
    }
    
    .schedule-person {
      background: #f9f9f9;
      padding: 6px 10px;
      margin: 3px 0;
      border-radius: 6px;
      font-size: 13px;
      line-height: 1.4;
    }
    
    @media (max-width: 768px) {
      .schedule-shift {
        margin-bottom: 10px;
      }
      .schedule-shift h4 {
        font-size: 14px;
      }
      .schedule-person {
        padding: 8px 12px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <!-- ============================================ -->
  <!-- FIREBASE & JAVASCRIPT -->
  <!-- ============================================ -->
  <script>
    // ============================================
    // FIREBASE ÏÑ§Ï†ï (v8 SDK)
    // ============================================
    const firebaseConfig = {
      apiKey: "AIzaSyAkAf6r0vaBfdF_VvhjFJUp_N4iQx7JXH4",
      authDomain: "shabu-zone-db.firebaseapp.com",
      databaseURL: "https://shabu-zone-inventory-default-rtdb.firebaseio.com",
      projectId: "shabu-zone-db",
      storageBucket: "shabu-zone-db.firebasestorage.app",
      messagingSenderId: "584815119069",
      appId: "1:584815119069:web:18d050cccf586e8f98e52b"
    };

    // --- Firebase Ï¥àÍ∏∞Ìôî (ÏôÑÏ†Ñ ÎèÖÎ¶Ω) ---
    let schedulerApp;
    try {
      // Í∏∞Ï°¥ Ïï±Ïù¥ ÏûàÏúºÎ©¥ ÏÇ¨Ïö©, ÏóÜÏúºÎ©¥ ÏÉàÎ°ú ÏÉùÏÑ±
      schedulerApp = firebase.apps.find(app => app.name === 'scheduler-app') || 
                     firebase.initializeApp(firebaseConfig, 'scheduler-app');
    } catch (error) {
      console.log('Firebase Ïù¥ÎØ∏ Ï¥àÍ∏∞ÌôîÎê®, Í∏∞Ï°¥ Ïù∏Ïä§ÌÑ¥Ïä§ ÏÇ¨Ïö©');
      schedulerApp = firebase.app('scheduler-app');
    }
    const db = schedulerApp.database();
    
    // --- URL ÌååÎùºÎØ∏ÌÑ∞ÏóêÏÑú locationÍ≥º language ÏùΩÍ∏∞ ---
    const urlParams = new URLSearchParams(window.location.search);
    const LOCATION = urlParams.get('location') || 'houston';
    const INITIAL_LANG = urlParams.get('lang') || 'ko';
    
    console.log('üåç Location:', LOCATION);
    console.log('üåê Language:', INITIAL_LANG);

    // ============================================
    // STORAGE - Firebase Realtime Database Ï†ÄÏû•/Î∂àÎü¨Ïò§Í∏∞ (v8)
    // ============================================
    const storage = {
      // --- Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• ---
      async saveData(key, data) {
        try {
          const path = `${LOCATION}/management/${key}`;
          await db.ref(path).set(data);
          console.log(`‚úÖ Firebase saved: ${path}`);
          return true;
        } catch (error) {
          console.error('‚ùå Firebase save error:', error);
          alert(`Save error: ${error.message}`);
          return false;
        }
      },
      
      // --- Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Í∏∞ ---
      async loadData(key, defaultValue) {
        try {
          const path = `${LOCATION}/management/${key}`;
          const snapshot = await db.ref(path).once('value');
          if (snapshot.exists()) {
            console.log(`‚úÖ Firebase loaded: ${path}`);
            return snapshot.val();
          }
          return defaultValue;
        } catch (error) {
          console.error('‚ùå Firebase load error:', error);
          return defaultValue;
        }
      }
    };

    // ============================================
    // ÏÉÅÏàò Ï†ïÏùò
    // ============================================
    
    // --- ÏöîÏùº Î∞∞Ïó¥ ---
    const DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    
    // --- ÏãúÌîÑÌä∏ Ï¢ÖÎ•ò ---
    const SHIFTS = {
      morning: ['open', 'eleven', 'elevenThirty'],
      evening: ['threeThirty', 'six']
    };

    // ============================================
    // Î≤àÏó≠ (3Í∞ú Ïñ∏Ïñ¥)
    // ============================================
    const TRANSLATIONS = {
      en: {
        appTitle: "Shabu Zone Schedule Manager",
        connectedToFirebase: "Connected to Firebase",
        tabs: {
          employees: "Employees",
          requirements: "Requirements",
          preferences: "Preferences",
          schedule: "Schedule",
          excelView: "Excel View",
          tips: "Tips"
        },
        employees: {
          title: "Employee Management",
          addEmployee: "Add Employee",
          name: "Name",
          gender: "Gender",
          male: "Male",
          female: "Female",
          status: "Status",
          active: "Active",
          cantWork: "Can't Work",
          save: "Save",
          cancel: "Cancel",
          noEmployees: "No employees yet. Click 'Add Employee' to start!",
          cantWorkDetails: "Can't Work Details",
          reason: "Reason",
          startDate: "Start Date",
          endDate: "End Date"
        },
        requirements: {
          title: "Weekly Requirements",
          copyPrevious: "Copy Previous Week",
          lunch: "LUNCH",
          dinner: "DINNER",
          open: "Open~Break",
          eleven: "11:00~Break",
          elevenThirty: "11:30~Break",
          threeThirty: "3:30~Close",
          six: "6:00~Close",
          total: "Total",
          holiday: "Holiday"
        },
        preferences: {
          title: "Employee Preferences",
          selectEmployee: "-- Select Employee --",
          minGuarantee: "Min. Guaranteed Shifts",
          savePreferences: "Save Preferences",
          lastSaved: "Last saved",
          clickToCycle: "Click to cycle colors",
          morning: "Morning",
          evening: "Evening",
          fixed: "Fixed"
        },
        schedule: {
          title: "Weekly Schedule",
          runSchedule: "Run Schedule",
          noSchedule: "No schedule generated yet. Click 'Run Schedule' to create!",
          generating: "Generating schedule...",
          lunch: "Lunch",
          dinner: "Dinner"
        },
        excelView: {
          title: "Excel View - Edit Schedule",
          noSchedule: "No schedule yet. Go to Schedule tab and click 'Run Schedule' first!",
          lunchCount: "Lunch Count",
          dinnerCount: "Dinner Count",
          allDayCount: "All Day Count",
          clickToEdit: "Click to edit shift",
          changeShift: "Change Shift",
          currentShift: "Current",
          changeTo: "Change to",
          switchEmployee: "Switch Employee",
          off: "OFF",
          availableEmployees: "Available Employees",
          swapWith: "Click to swap with"
        },
        sections: {
          title: "Section Assignment",
          comingSoon: "Coming soon!"
        }
      },
      ko: {
        appTitle: "ÏÉ§Î∂ÄÏ°¥ Ïä§ÏºÄÏ§Ñ Í¥ÄÎ¶¨",
        connectedToFirebase: "Firebase Ïó∞Í≤∞Îê®",
        tabs: {
          employees: "ÏßÅÏõê Í¥ÄÎ¶¨",
          requirements: "Ïù∏Ïõê ÏÑ§Ï†ï",
          preferences: "Ìù¨Îßù Ïä§ÏºÄÏ§Ñ",
          schedule: "Ïä§ÏºÄÏ§Ñ",
          excelView: "ÏóëÏÖÄ Î∑∞",
          tips: "ÌåÅ Í¥ÄÎ¶¨"
        },
        employees: {
          title: "ÏßÅÏõê Í¥ÄÎ¶¨",
          addEmployee: "ÏßÅÏõê Ï∂îÍ∞Ä",
          name: "Ïù¥Î¶Ñ",
          gender: "ÏÑ±Î≥Ñ",
          male: "ÎÇ®Ïûê",
          female: "Ïó¨Ïûê",
          status: "ÏÉÅÌÉú",
          active: "Í∑ºÎ¨¥ Í∞ÄÎä•",
          cantWork: "Í∑ºÎ¨¥ Î∂àÍ∞Ä",
          save: "Ï†ÄÏû•",
          cancel: "Ï∑®ÏÜå",
          noEmployees: "ÏïÑÏßÅ ÏßÅÏõêÏù¥ ÏóÜÏäµÎãàÎã§. 'ÏßÅÏõê Ï∂îÍ∞Ä'Î•º ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî!",
          cantWorkDetails: "Í∑ºÎ¨¥ Î∂àÍ∞Ä ÏÉÅÏÑ∏",
          reason: "ÏÇ¨Ïú†",
          startDate: "ÏãúÏûëÏùº",
          endDate: "Ï¢ÖÎ£åÏùº"
        },
        requirements: {
          title: "Ï£ºÍ∞Ñ ÌïÑÏöî Ïù∏Ïõê",
          copyPrevious: "Ïù¥Ï†Ñ Ï£º Î≥µÏÇ¨",
          lunch: "Ï†êÏã¨",
          dinner: "Ï†ÄÎÖÅ",
          open: "Ïò§Ìîà~Î∏åÎ†àÏù¥ÌÅ¨",
          eleven: "11:00~Î∏åÎ†àÏù¥ÌÅ¨",
          elevenThirty: "11:30~Î∏åÎ†àÏù¥ÌÅ¨",
          threeThirty: "3:30~ÎßàÍ∞ê",
          six: "6:00~ÎßàÍ∞ê",
          total: "Ìï©Í≥Ñ",
          holiday: "ÌäπÎ≥ÑÏùº"
        },
        preferences: {
          title: "ÏßÅÏõê Ìù¨Îßù Ïä§ÏºÄÏ§Ñ",
          selectEmployee: "-- ÏßÅÏõê ÏÑ†ÌÉù --",
          minGuarantee: "ÏµúÏÜå Î≥¥Ïû• ÏãúÌîÑÌä∏",
          savePreferences: "Ï†ÄÏû•",
          lastSaved: "ÎßàÏßÄÎßâ Ï†ÄÏû•",
          clickToCycle: "ÌÅ¥Î¶≠ÌïòÏó¨ ÏÉâÏÉÅ Î≥ÄÍ≤Ω",
          morning: "Ïò§Ï†Ñ",
          evening: "Ïò§ÌõÑ",
          fixed: "Í≥†Ï†ï"
        },
        schedule: {
          title: "Ï£ºÍ∞Ñ Ïä§ÏºÄÏ§Ñ",
          runSchedule: "Ïä§ÏºÄÏ§Ñ ÏÉùÏÑ±",
          noSchedule: "ÏïÑÏßÅ Ïä§ÏºÄÏ§ÑÏù¥ ÏóÜÏäµÎãàÎã§. 'Ïä§ÏºÄÏ§Ñ ÏÉùÏÑ±'ÏùÑ ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî!",
          generating: "Ïä§ÏºÄÏ§Ñ ÏÉùÏÑ± Ï§ë...",
          lunch: "Ï†êÏã¨",
          dinner: "Ï†ÄÎÖÅ"
        },
        sections: {
          title: "ÏÑπÏÖò Î∞∞Ï†ï",
          comingSoon: "Ï§ÄÎπÑ Ï§ëÏûÖÎãàÎã§!"
        }
      },
      vi: {
        appTitle: "Qu·∫£n L√Ω L·ªãch Shabu Zone",
        connectedToFirebase: "ƒê√£ k·∫øt n·ªëi Firebase",
        tabs: {
          employees: "Nh√¢n Vi√™n",
          requirements: "Y√™u C·∫ßu",
          preferences: "Mong Mu·ªën",
          schedule: "L·ªãch L√†m",
          excelView: "Excel",
          tips: "Tips"
        },
        employees: {
          title: "Qu·∫£n L√Ω Nh√¢n Vi√™n",
          addEmployee: "Th√™m NV",
          name: "T√™n",
          gender: "Gi·ªõi T√≠nh",
          male: "Nam",
          female: "N·ªØ",
          status: "Tr·∫°ng Th√°i",
          active: "Ho·∫°t ƒê·ªông",
          cantWork: "Kh√¥ng L√†m",
          save: "L∆∞u",
          cancel: "H·ªßy",
          noEmployees: "Ch∆∞a c√≥ nh√¢n vi√™n. Click 'Th√™m NV' ƒë·ªÉ b·∫Øt ƒë·∫ßu!",
          cantWorkDetails: "Chi Ti·∫øt Kh√¥ng L√†m",
          reason: "L√Ω Do",
          startDate: "Ng√†y B·∫Øt ƒê·∫ßu",
          endDate: "Ng√†y K·∫øt Th√∫c"
        },
        requirements: {
          title: "Y√™u C·∫ßu H√†ng Tu·∫ßn",
          copyPrevious: "Sao Ch√©p Tu·∫ßn Tr∆∞·ªõc",
          lunch: "TR∆ØA",
          dinner: "T·ªêI",
          open: "M·ªü~Ngh·ªâ",
          eleven: "11:00~Ngh·ªâ",
          elevenThirty: "11:30~Ngh·ªâ",
          threeThirty: "3:30~ƒê√≥ng",
          six: "6:00~ƒê√≥ng",
          total: "T·ªïng",
          holiday: "Ng√†y L·ªÖ"
        },
        preferences: {
          title: "Mong Mu·ªën Nh√¢n Vi√™n",
          selectEmployee: "-- Ch·ªçn Nh√¢n Vi√™n --",
          minGuarantee: "Ca T·ªëi Thi·ªÉu",
          savePreferences: "L∆∞u",
          lastSaved: "L∆∞u l·∫ßn cu·ªëi",
          clickToCycle: "Click ƒë·ªÉ thay ƒë·ªïi m√†u",
          morning: "S√°ng",
          evening: "T·ªëi",
          fixed: "C·ªë ƒê·ªãnh"
        },
        schedule: {
          title: "L·ªãch H√†ng Tu·∫ßn",
          runSchedule: "T·∫°o L·ªãch",
          noSchedule: "Ch∆∞a c√≥ l·ªãch. Click 'T·∫°o L·ªãch' ƒë·ªÉ b·∫Øt ƒë·∫ßu!",
          generating: "ƒêang t·∫°o l·ªãch...",
          lunch: "Tr∆∞a",
          dinner: "T·ªëi"
        },
        sections: {
          title: "Ph√¢n Khu V·ª±c",
          comingSoon: "S·∫Øp ra m·∫Øt!"
        }
      }
    };

    // ============================================
    // APP STATE - Ïï± Ï†ÑÏ≤¥ ÏÉÅÌÉú Í¥ÄÎ¶¨
    // ÏàòÏ†ï: Ï¥àÍ∏∞Í∞í Î≥ÄÍ≤ΩÌïòÎ†§Î©¥ Ïó¨Í∏∞!
    // ============================================
    let state = {
      language: INITIAL_LANG,       // ÌòÑÏû¨ Ïñ∏Ïñ¥ (URLÏóêÏÑú)
      activeTab: 'employees',       // ÌòÑÏû¨ ÌÉ≠
      employees: [],                // ÏßÅÏõê Î™©Î°ù
      requirements: {},             // Ï£ºÍ∞Ñ ÌïÑÏöî Ïù∏Ïõê
      preferences: {},              // ÏßÅÏõêÎ≥Ñ Ìù¨Îßù Ïä§ÏºÄÏ§Ñ
      schedule: {},                 // ÏÉùÏÑ±Îêú Ïä§ÏºÄÏ§Ñ
      loading: true,                // Î°úÎî© ÏÉÅÌÉú
      showModal: false,             // Î™®Îã¨ ÌëúÏãú Ïó¨Î∂Ä
      editingEmployee: null,        // ÏàòÏ†ï Ï§ëÏù∏ ÏßÅÏõê
      selectedEmployee: null,       // ÏÑ†ÌÉùÎêú ÏßÅÏõê (PreferencesÏö©)
      generating: false,            // Ïä§ÏºÄÏ§Ñ ÏÉùÏÑ± Ï§ë
      
      // Tips Í¥ÄÎ†®
      tipsSubTab: 'entry',          // tips ÏÑúÎ∏åÌÉ≠: 'entry', 'statistics', 'settlement', 'history'
      tipsData: {},                 // ÌåÅ Îç∞Ïù¥ÌÑ∞: { "2026-01-27": { lunch: {}, dinner: {} } }
      tipStats: {},                 // ÌÜµÍ≥Ñ: { "John": { pending, paid, total } }
      settlements: [],              // Ï†ïÏÇ∞ Í∏∞Î°ù
      selectedTipDate: null,        // ÏÑ†ÌÉùÎêú ÎÇ†Ïßú
      tipEntryStep: 'select-date',  // 'select-date', 'lunch-select', 'lunch-entry', 'dinner-select', 'dinner-entry'
      lunchWorkers: [],             // Lunch shift Í∑ºÎ¨¥Ïûê
      dinnerWorkers: [],            // Dinner shift Í∑ºÎ¨¥Ïûê
      lunchTips: {},                // { "John": 150.00 }
      dinnerTips: {},               // { "John": 200.00 }
      settlementStart: '',          // Ï†ïÏÇ∞ ÏãúÏûëÏùº
      settlementEnd: '',            // Ï†ïÏÇ∞ Ï¢ÖÎ£åÏùº
      settlementSummary: null,      // Ï†ïÏÇ∞ ÏöîÏïΩ
      selectedSettlement: null,     // HistoryÏóêÏÑú ÏÑ†ÌÉùÎêú Ï†ïÏÇ∞
      tipCalendarMonth: new Date(),  // Îã¨Î†• Ïõî
      confirmModal: null             // ÌôïÏù∏ Î™®Îã¨ Îç∞Ïù¥ÌÑ∞
    };

    // ============================================
    // Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
    // ============================================
    async function loadInitialData() {
      state.loading = true;
      render();
      
      // --- FirebaseÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Í∏∞ ---
      const [employees, requirements, preferences, schedule, tipsData, tipStats, settlements] = await Promise.all([
        storage.loadData('employees', []),
        storage.loadData('requirements', getDefaultRequirements()),
        storage.loadData('preferences', {}),
        storage.loadData('schedule', {}),
        storage.loadData('tips', {}),
        storage.loadData('tipStats', {}),
        storage.loadData('settlements', [])
      ]);
      
      state.employees = employees;
      state.requirements = requirements;
      state.preferences = preferences;
      state.schedule = schedule;
      state.tipsData = tipsData;
      state.tipStats = tipStats;
      state.settlements = settlements;
      state.loading = false;
      
      render();
    }

    // --- Í∏∞Î≥∏ Requirements Íµ¨Ï°∞ ÏÉùÏÑ± ---
    function getDefaultRequirements() {
      const reqs = {};
      DAYS.forEach(day => {
        reqs[day] = {
          lunch: { open: 4, eleven: 2, elevenThirty: 3 },
          dinner: { threeThirty: 8, six: 0 },
          allDayMax: 0,
          isHoliday: false
        };
      });
      return reqs;
    }

    // ============================================
    // Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ìï®ÏàòÎì§
    // ============================================
    async function saveEmployees() {
      await storage.saveData('employees', state.employees);
    }

    async function saveRequirements() {
      await storage.saveData('requirements', state.requirements);
    }

    async function savePreferences() {
      await storage.saveData('preferences', state.preferences);
    }

    async function saveSchedule() {
      await storage.saveData('schedule', state.schedule);
    }

    // ============================================
    // RENDER Ìï®ÏàòÎì§
    // ============================================
    
    // --- Î©îÏù∏ Î†åÎçîÎßÅ ---
    function render() {
      const app = document.getElementById('app');
      
      if (state.loading) {
        app.innerHTML = `<div class="loading">üî• Loading...</div>`;
        return;
      }

      const t = TRANSLATIONS[state.language];

      app.innerHTML = `
        <div class="container">
          ${renderHeader(t)}
          ${renderTabs(t)}
          ${renderContent(t)}
        </div>
        ${state.showModal ? renderModal(t) : ''}
        ${state.confirmModal ? renderConfirmModal() : ''}
      `;

      attachEventListeners();
    }

    // --- Ìó§Îçî Î†åÎçîÎßÅ ---
    function renderHeader(t) {
      return `
        <div class="header">
          <div style="display: flex; align-items: center; gap: 12px;">
            <img src="./shabu_logo_80x80.png" style="width: 80px; height: 80px; border-radius: 8px;">
            <div>
              <h1>${t.appTitle}</h1>
              <div class="subtitle">üî• ${t.connectedToFirebase}</div>
            </div>
          </div>
          <select id="language-selector">
            <option value="en" ${state.language === 'en' ? 'selected' : ''}>üá∫üá∏ English</option>
            <option value="ko" ${state.language === 'ko' ? 'selected' : ''}>üá∞üá∑ ÌïúÍµ≠Ïñ¥</option>
            <option value="vi" ${state.language === 'vi' ? 'selected' : ''}>üáªüá≥ Ti·∫øng Vi·ªát</option>
          </select>
        </div>
      `;
    }

    // --- ÌÉ≠ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î†åÎçîÎßÅ ---
    function renderTabs(t) {
      return `
        <div class="tabs">
          ${['employees', 'requirements', 'preferences', 'schedule', 'excelView', 'tips'].map(tab => `
            <button class="tab ${state.activeTab === tab ? 'active' : ''}" data-tab="${tab}">
              ${t.tabs[tab]}
            </button>
          `).join('')}
        </div>
      `;
    }

    // --- ÏΩòÌÖêÏ∏† Î†åÎçîÎßÅ (ÌÉ≠Î≥Ñ) ---
    function renderContent(t) {
      return `
        <div class="content">
          ${state.activeTab === 'employees' ? renderEmployeesTab(t) : ''}
          ${state.activeTab === 'requirements' ? renderRequirementsTab(t) : ''}
          ${state.activeTab === 'preferences' ? renderPreferencesTab(t) : ''}
          ${state.activeTab === 'schedule' ? renderScheduleTab(t) : ''}
          ${state.activeTab === 'excelView' ? renderExcelViewTab(t) : ''}
          ${state.activeTab === 'tips' ? renderTipsTab(t) : ''}
        </div>
      `;
    }

    // ============================================
    // EMPLOYEES TAB - ÏßÅÏõê Í¥ÄÎ¶¨ ÌÉ≠
    // ÏàòÏ†ï: Ïπ¥Îìú ÎîîÏûêÏù∏ Î≥ÄÍ≤ΩÌïòÎ†§Î©¥ Ïù¥ Ìï®Ïàò!
    // ============================================
    function renderEmployeesTab(t) {
      return `
        <div style="display:flex;justify-content:space-between;margin-bottom:24px;">
          <h2 style="margin:0;font-size:24px;font-weight:600;">${t.employees.title} (${state.employees.length})</h2>
          <button class="btn-primary" id="add-employee-btn">
            ‚ûï ${t.employees.addEmployee}
          </button>
        </div>

        ${state.employees.length === 0 ? `
          <div style="padding:60px;text-align:center;background:#f9f9f9;border-radius:12px;border:2px dashed #ddd;">
            <div style="font-size:48px;margin-bottom:16px;">üë•</div>
            <p style="color:#999;font-size:16px;">${t.employees.noEmployees}</p>
          </div>
        ` : `
          <div class="employee-grid">
            ${state.employees.map(emp => `
              <div class="employee-card" style="${emp.status === 'cantWork' ? 'background:#FFF3E0;' : ''}">
                <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px;">
                  <div style="flex:1;">
                    <h3>${emp.name}</h3>
                    <div style="margin:8px 0;">
                      <span class="badge ${emp.gender === 'male' ? 'badge-male' : 'badge-female'}">
                        ${emp.gender === 'male' ? t.employees.male : t.employees.female}
                      </span>
                      <span class="badge ${emp.status === 'cantWork' ? 'badge-cant-work' : 'badge-active'}">
                        ${emp.status === 'cantWork' ? t.employees.cantWork : t.employees.active}
                      </span>
                    </div>
                    ${emp.status === 'cantWork' && emp.cantWorkDetails ? `
                      <div style="font-size:12px;color:#666;margin-top:8px;padding:8px;background:white;border-radius:6px;">
                        <div><strong>${t.employees.reason}:</strong> ${emp.cantWorkDetails.reason || 'N/A'}</div>
                        <div><strong>${t.employees.startDate}:</strong> ${emp.cantWorkDetails.startDate || 'N/A'}</div>
                        <div><strong>${t.employees.endDate}:</strong> ${emp.cantWorkDetails.endDate || 'N/A'}</div>
                      </div>
                    ` : ''}
                  </div>
                  <div style="display:flex;gap:8px;">
                    <button onclick="editEmployee(${emp.id})" style="padding:6px;background:white;border:1px solid #ddd;border-radius:6px;cursor:pointer;" title="Edit">
                      ‚úèÔ∏è
                    </button>
                    <button onclick="deleteEmployee(${emp.id})" style="padding:6px;background:white;border:1px solid #ddd;border-radius:6px;cursor:pointer;color:#FF6B6B;" title="Delete">
                      üóëÔ∏è
                    </button>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        `}
      `;
    }

    // ============================================
    // REQUIREMENTS TAB - Ïù∏Ïõê ÏÑ§Ï†ï ÌÉ≠
    // ÏàòÏ†ï: ÌÖåÏù¥Î∏î Íµ¨Ï°∞ Î≥ÄÍ≤ΩÌïòÎ†§Î©¥ Ïù¥ Ìï®Ïàò!
    // ============================================
    function renderRequirementsTab(t) {
      return `
        <div style="display:flex;justify-content:space-between;margin-bottom:24px;">
          <h2 style="margin:0;font-size:24px;font-weight:600;">${t.requirements.title}</h2>
        </div>

        <table class="requirements-table">
          <thead>
            <tr>
              <th rowspan="2" style="width:100px;">Day</th>
              <th colspan="3">${t.requirements.lunch}</th>
              <th rowspan="2" style="width:80px;">Lunch<br>Total</th>
              <th colspan="2">${t.requirements.dinner}</th>
              <th rowspan="2" style="width:80px;">Dinner<br>Total</th>
              <th rowspan="2" style="width:80px;">All Day<br>Max</th>
              <th rowspan="2" style="width:100px;">${t.requirements.holiday}</th>
            </tr>
            <tr>
              <th>${t.requirements.open}</th>
              <th>${t.requirements.eleven}</th>
              <th>${t.requirements.elevenThirty}</th>
              <th>${t.requirements.threeThirty}</th>
              <th>${t.requirements.six}</th>
            </tr>
          </thead>
          <tbody>
            ${DAYS.map(day => {
              const req = state.requirements[day];
              const lunchTotal = (req.lunch.open || 0) + (req.lunch.eleven || 0) + (req.lunch.elevenThirty || 0);
              const dinnerTotal = (req.dinner.threeThirty || 0) + (req.dinner.six || 0);
              
              return `
                <tr style="${req.isHoliday ? 'background:#FFF3E0;' : ''}">
                  <td style="font-weight:600;">${t.days?.[day] || day}</td>
                  <td><input type="number" min="0" value="${req.lunch.open}" onchange="updateRequirement('${day}', 'lunch', 'open', this.value)"></td>
                  <td><input type="number" min="0" value="${req.lunch.eleven}" onchange="updateRequirement('${day}', 'lunch', 'eleven', this.value)"></td>
                  <td><input type="number" min="0" value="${req.lunch.elevenThirty}" onchange="updateRequirement('${day}', 'lunch', 'elevenThirty', this.value)"></td>
                  <td style="font-weight:700;background:#E8F5E9;color:#2E7D32;font-size:16px;">${lunchTotal}</td>
                  <td><input type="number" min="0" value="${req.dinner.threeThirty}" onchange="updateRequirement('${day}', 'dinner', 'threeThirty', this.value)"></td>
                  <td><input type="number" min="0" value="${req.dinner.six}" onchange="updateRequirement('${day}', 'dinner', 'six', this.value)"></td>
                  <td style="font-weight:700;background:#E3F2FD;color:#1565C0;font-size:16px;">${dinnerTotal}</td>
                  <td><input type="number" min="0" value="${req.allDayMax || 0}" onchange="updateAllDayMax('${day}', this.value)" style="width:60px;"></td>
                  <td>
                    <input type="checkbox" ${req.isHoliday ? 'checked' : ''} onchange="toggleHoliday('${day}')" style="cursor:pointer;width:20px;height:20px;">
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>

        <div style="margin-top:20px;padding:16px;background:#E3F2FD;border-radius:8px;font-size:14px;">
          üí° <strong>Holiday Mode:</strong> When checked, all available employees will be scheduled regardless of preferences to prevent shortages.<br>
          <strong>Main Job employees</strong> will maintain their fixed schedule even on holidays.
        </div>
      `;
    }

    // ============================================
    // PREFERENCES TAB - Ìù¨Îßù Ïä§ÏºÄÏ§Ñ ÌÉ≠
    // ÏàòÏ†ï: ÏÉâÏÉÅ Î≤ÑÌäº Î≥ÄÍ≤ΩÌïòÎ†§Î©¥ Ïù¥ Ìï®Ïàò!
    // ============================================
    function renderPreferencesTab(t) {
      const activeEmployees = state.employees.filter(e => e.status === 'active');
      const selectedEmp = state.selectedEmployee;
      const empPrefs = selectedEmp ? (state.preferences[selectedEmp.id] || {}) : {};

      return `
        <div style="margin-bottom:24px;">
          <h2 style="margin:0 0 16px 0;font-size:24px;font-weight:600;">${t.preferences.title}</h2>
          
          <select id="employee-selector" style="width:300px;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:15px;">
            <option value="">${t.preferences.selectEmployee}</option>
            ${activeEmployees.map(emp => `
              <option value="${emp.id}" ${selectedEmp?.id === emp.id ? 'selected' : ''}>${emp.name}</option>
            `).join('')}
          </select>
        </div>

        ${!selectedEmp ? `
          <div style="padding:60px;text-align:center;background:#f9f9f9;border-radius:12px;border:2px dashed #ddd;">
            <div style="font-size:48px;margin-bottom:16px;">üë§</div>
            <p style="color:#999;font-size:16px;">Select an employee to set preferences</p>
          </div>
        ` : `
          <div style="padding:24px;background:white;border-radius:12px;border:2px solid #7f1d1d;">
            <h3 style="margin:0 0 16px 0;">${selectedEmp.name}</h3>
            
            <table class="preferences-table">
              <thead>
                <tr style="background:#f5f5f5;">
                  <th style="text-align:left;width:120px;">Day</th>
                  <th style="text-align:center;width:120px;">${t.preferences.morning}</th>
                  <th style="text-align:center;width:80px;">${t.preferences.fixed}</th>
                  <th style="text-align:center;width:120px;">${t.preferences.evening}</th>
                  <th style="text-align:center;width:80px;">${t.preferences.fixed}</th>
                </tr>
              </thead>
              <tbody>
                ${DAYS.map(day => {
                  const dayPrefs = empPrefs[day] || { morning: 0, evening: 0, morningFixed: false, eveningFixed: false };
                  return `
                    <tr>
                      <td style="font-weight:500;">${t.days?.[day] || day}</td>
                      <td style="text-align:center;">
                        <button class="pref-button" onclick="cyclePreference('${day}', 'morning')" 
                                style="background:${getPrefColor(dayPrefs.morning, 'morning')};">
                          ${getPrefEmoji(dayPrefs.morning, 'morning')}
                        </button>
                      </td>
                      <td style="text-align:center;">
                        <input type="checkbox" 
                               ${dayPrefs.morningFixed ? 'checked' : ''} 
                               onchange="toggleFixed('${day}', 'morning')"
                               style="width:20px;height:20px;cursor:pointer;"
                               ${dayPrefs.morning === 0 ? 'disabled' : ''}>
                      </td>
                      <td style="text-align:center;">
                        <button class="pref-button" onclick="cyclePreference('${day}', 'evening')" 
                                style="background:${getPrefColor(dayPrefs.evening, 'evening')};">
                          ${getPrefEmoji(dayPrefs.evening, 'evening')}
                        </button>
                      </td>
                      <td style="text-align:center;">
                        <input type="checkbox" 
                               ${dayPrefs.eveningFixed ? 'checked' : ''} 
                               onchange="toggleFixed('${day}', 'evening')"
                               style="width:20px;height:20px;cursor:pointer;"
                               ${dayPrefs.evening === 0 ? 'disabled' : ''}>
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>

            <div style="margin-top:16px;padding:12px;background:#FFF3E0;border-radius:8px;font-size:13px;border-left:3px solid #F57C00;">
              <strong>‚≠ê Fixed:</strong> When checked, this shift will <strong>ALWAYS</strong> be assigned (ignores min guarantee and shortages).<br>
              <strong>üí° Tip:</strong> Use Fixed for employees who need specific regular shifts (e.g., always Monday morning, always Tuesday evening).
            </div>

            <div style="margin-top:16px;padding:12px;background:#E3F2FD;border-radius:8px;font-size:13px;">
              üí° ${t.preferences.clickToCycle}<br>
              ${t.preferences.morning}: Empty ‚Üí üü° (Open~Break) ‚Üí üü¢ (11:00/11:30~Break)<br>
              ${t.preferences.evening}: Empty ‚Üí üîµ (3:30~Close) ‚Üí üü£ (6:00~Close)
            </div>

            <div style="margin-top:24px;padding:16px;background:#f9f9f9;border-radius:8px;">
              <label style="display:block;margin-bottom:8px;font-weight:600;">
                ${t.preferences.minGuarantee}:
              </label>
              <input type="number" min="0" id="min-guarantee" value="${empPrefs.minGuarantee || 0}" 
                     style="width:100px;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:15px;">
              <div style="margin-top:8px;font-size:12px;color:#666;">
                (Applies only to non-fixed shifts. Fixed shifts are always assigned.)
              </div>
            </div>

            <button class="btn-primary" onclick="saveCurrentPreferences()" style="margin-top:24px;">
              üíæ ${t.preferences.savePreferences}
            </button>

            ${empPrefs.savedAt ? `
              <div style="margin-top:12px;color:#4CAF50;font-size:14px;">
                ‚úÖ ${t.preferences.lastSaved}: ${new Date(empPrefs.savedAt).toLocaleString()}
              </div>
            ` : ''}
          </div>
        `}
      `;
    }

    // --- Preference ÏÉâÏÉÅ Î∞òÌôò ---
    function getPrefColor(value, period) {
      if (value === 0) return '#f5f5f5';
      if (period === 'morning') return value === 1 ? '#FFD93D' : '#6BCB77';
      return value === 1 ? '#4D96FF' : '#9D4EDD';
    }

    // --- Preference Ïù¥Î™®ÏßÄ Î∞òÌôò ---
    function getPrefEmoji(value, period) {
      if (value === 0) return '‚Äî';
      if (period === 'morning') return value === 1 ? 'üü°' : 'üü¢';
      return value === 1 ? 'üîµ' : 'üü£';
    }

    // ============================================
    // SCHEDULE TAB - Ïä§ÏºÄÏ§Ñ ÌÉ≠
    // ÏàòÏ†ï: Ïä§ÏºÄÏ§Ñ Î†àÏù¥ÏïÑÏõÉ Î≥ÄÍ≤ΩÌïòÎ†§Î©¥ Ïù¥ Ìï®Ïàò!
    // ============================================
    function renderScheduleTab(t) {
      const hasSchedule = Object.keys(state.schedule).length > 0;

      return `
        <div style="display:flex;justify-content:space-between;margin-bottom:24px;">
          <h2 style="margin:0;font-size:24px;font-weight:600;">${t.schedule.title}</h2>
          <button class="btn-primary" onclick="runScheduleGeneration()" ${state.generating ? 'disabled' : ''}>
            ${state.generating ? '‚è≥' : '‚ñ∂Ô∏è'} ${state.generating ? t.schedule.generating : t.schedule.runSchedule}
          </button>
        </div>

        ${!hasSchedule ? `
          <div style="padding:60px;text-align:center;background:#f9f9f9;border-radius:12px;border:2px dashed #ddd;">
            <div style="font-size:48px;margin-bottom:16px;">üìÖ</div>
            <p style="color:#999;font-size:16px;">${t.schedule.noSchedule}</p>
          </div>
        ` : `
          <div class="schedule-grid">
            ${DAYS.map(day => {
              const daySchedule = state.schedule[day] || {};
              const isHoliday = state.requirements[day]?.isHoliday;
              const req = state.requirements[day] || { lunch: {}, dinner: {} };
              
              // ÌïÑÏöî Ïù∏Ïõê Í≥ÑÏÇ∞
              const lunchNeed = (req.lunch.open || 0) + (req.lunch.eleven || 0) + (req.lunch.elevenThirty || 0);
              const dinnerNeed = (req.dinner.threeThirty || 0) + (req.dinner.six || 0);
              
              // Î∞∞Ï†ïÎêú Ïù∏Ïõê
              const lunchAssigned = (daySchedule.lunch || []).length;
              const dinnerAssigned = (daySchedule.dinner || []).length;
              
              // All Day ÏßÅÏõê Ï∞æÍ∏∞
              const lunchNames = (daySchedule.lunch || []).map(e => e.name);
              const dinnerNames = (daySchedule.dinner || []).map(e => e.name);
              const allDayPeople = lunchNames.filter(name => dinnerNames.includes(name));
              
              // Short/Over Ï≤¥ÌÅ¨
              const lunchDiff = lunchAssigned - lunchNeed;
              const dinnerDiff = dinnerAssigned - dinnerNeed;
              
              return `
                <div class="schedule-day ${isHoliday ? 'holiday' : ''}">
                  <h3>${t.days?.[day] || day} ${isHoliday ? 'üéÑ' : ''}</h3>
                  
                  <!-- LUNCH SECTION -->
                  <div class="schedule-shift">
                    <h4 style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                      <span>‚òÄÔ∏è ${t.schedule.lunch}</span>
                      <div style="display:flex;align-items:center;gap:8px;">
                        <span style="font-size:11px;font-weight:normal;color:#666;">
                          ${lunchAssigned}/${lunchNeed}
                        </span>
                        <button onclick="showAvailable('${day}', 'lunch')" style="background:none;border:none;cursor:pointer;font-size:16px;padding:4px;" title="View available employees">
                          üîç
                        </button>
                      </div>
                    </h4>
                    
                    ${lunchDiff < 0 ? `
                      <div style="padding:6px 10px;background:#FFEBEE;color:#C62828;border-radius:4px;margin-bottom:8px;font-size:12px;font-weight:600;">
                        ‚ùå SHORT: ${Math.abs(lunchDiff)} more needed!
                      </div>
                    ` : lunchDiff > 0 ? `
                      <div style="padding:6px 10px;background:#FFF3E0;color:#F57C00;border-radius:4px;margin-bottom:8px;font-size:12px;font-weight:600;">
                        ‚ö†Ô∏è OVER: ${lunchDiff} extra assigned!
                      </div>
                    ` : lunchAssigned > 0 ? `
                      <div style="padding:4px 8px;background:#E8F5E9;color:#2E7D32;border-radius:4px;margin-bottom:8px;font-size:11px;font-weight:600;">
                        ‚úÖ OK
                      </div>
                    ` : ''}
                    
                    ${(daySchedule.lunch || []).map(emp => {
                      const isAllDay = allDayPeople.includes(emp.name);
                      const fixedMark = emp.isFixed ? ' *' : '';
                      return `
                        <div class="schedule-person" style="${isAllDay ? 'font-weight:700;border-left:3px solid #D32F2F;' : ''}">
                          ${isAllDay ? 'üî¥ ' : ''}${emp.name}${fixedMark} <span style="font-size:11px;color:#666;">(${emp.shift})</span>
                        </div>
                      `;
                    }).join('') || '<div style="color:#999;font-size:12px;padding:8px;">No assignments</div>'}
                  </div>

                  <!-- DINNER SECTION -->
                  <div class="schedule-shift">
                    <h4 style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                      <span>üåô ${t.schedule.dinner}</span>
                      <div style="display:flex;align-items:center;gap:8px;">
                        <span style="font-size:11px;font-weight:normal;color:#666;">
                          ${dinnerAssigned}/${dinnerNeed}
                        </span>
                        <button onclick="showAvailable('${day}', 'dinner')" style="background:none;border:none;cursor:pointer;font-size:16px;padding:4px;" title="View available employees">
                          üîç
                        </button>
                      </div>
                    </h4>
                    
                    ${dinnerDiff < 0 ? `
                      <div style="padding:6px 10px;background:#FFEBEE;color:#C62828;border-radius:4px;margin-bottom:8px;font-size:12px;font-weight:600;">
                        ‚ùå SHORT: ${Math.abs(dinnerDiff)} more needed!
                      </div>
                    ` : dinnerDiff > 0 ? `
                      <div style="padding:6px 10px;background:#FFF3E0;color:#F57C00;border-radius:4px;margin-bottom:8px;font-size:12px;font-weight:600;">
                        ‚ö†Ô∏è OVER: ${dinnerDiff} extra assigned!
                      </div>
                    ` : dinnerAssigned > 0 ? `
                      <div style="padding:4px 8px;background:#E8F5E9;color:#2E7D32;border-radius:4px;margin-bottom:8px;font-size:11px;font-weight:600;">
                        ‚úÖ OK
                      </div>
                    ` : ''}
                    
                    ${(daySchedule.dinner || []).map(emp => {
                      const isAllDay = allDayPeople.includes(emp.name);
                      const fixedMark = emp.isFixed ? ' *' : '';
                      return `
                        <div class="schedule-person" style="${isAllDay ? 'font-weight:700;border-left:3px solid #D32F2F;' : ''}">
                          ${isAllDay ? 'üî¥ ' : ''}${emp.name}${fixedMark} <span style="font-size:11px;color:#666;">(${emp.shift})</span>
                        </div>
                      `;
                    }).join('') || '<div style="color:#999;font-size:12px;padding:8px;">No assignments</div>'}
                  </div>

                  <!-- ALL DAY SUMMARY -->
                  ${allDayPeople.length > 0 ? `
                    <div style="margin-top:12px;padding:8px;background:${
                      req.allDayMax && allDayPeople.length > req.allDayMax 
                        ? '#FFEBEE' 
                        : '#FFF3E0'
                    };border-radius:6px;border-left:3px solid ${
                      req.allDayMax && allDayPeople.length > req.allDayMax 
                        ? '#C62828' 
                        : '#F57C00'
                    };">
                      <div style="font-size:11px;font-weight:600;color:${
                        req.allDayMax && allDayPeople.length > req.allDayMax 
                          ? '#C62828' 
                          : '#E65100'
                      };margin-bottom:4px;">
                        üìä All Day: ${allDayPeople.length}${req.allDayMax ? `/${req.allDayMax}` : ''} 
                        ${req.allDayMax && allDayPeople.length > req.allDayMax 
                          ? `‚ö†Ô∏è (${allDayPeople.length - req.allDayMax} over - remove some Fixed)` 
                          : ''}
                      </div>
                      <div style="font-size:11px;color:#666;">
                        ${allDayPeople.join(', ')}
                      </div>
                    </div>
                  ` : ''}
                </div>
              `;
            }).join('')}
          </div>
        `}
      `;
    }

    // ============================================
    // ============================================
    // EXCEL VIEW TAB - ÏóëÏÖÄ Î∑∞ ÌÉ≠
    // ============================================
    function renderExcelViewTab(t) {
      // Î≤àÏó≠ ÏïàÏ†Ñ Ï†ëÍ∑º
      const excelT = t.excelView || {};
      
      if (!state.schedule || Object.keys(state.schedule).length === 0) {
        return `
          <div style="padding:60px;text-align:center;">
            <div style="font-size:48px;margin-bottom:16px;">üìä</div>
            <h3>${excelT.noSchedule || 'No schedule yet. Generate schedule first!'}</h3>
          </div>
        `;
      }

      // Ï†ïÌï¥ÏßÑ ÏßÅÏõê ÏàúÏÑú
      const employeeOrder = [
        'Aiden', 'Carlos', 'Edgar', 'Hung', 'Thanh', 'Tien', 'Tommy', 'Judy', 
        'Justin', 'Tina N', 'Alan', 'Chau', 'Le', 'Crystal', 'Tue', 'Cherry', 
        'Christine', 'Hieu', 'Kai', 'Dat', 'Johnny', 'Ly', 'Tho', 'Kha', 
        'Phung', 'Ye', 'Esther', 'Duc', 'Jimmy', 'Aca', 'Vivi', 'Catherine', 
        'Tiffany', 'Steven', 'Chris', 'Dung'
      ];

      // ÌôúÏÑ± ÏßÅÏõê Ï†ïÎ†¨
      const orderedEmployees = [];
      employeeOrder.forEach(name => {
        const emp = state.employees.find(e => e.name === name && e.status === 'active');
        if (emp) orderedEmployees.push(emp);
      });

      // ÏàúÏÑúÏóê ÏóÜÎäî ÏßÅÏõê Ï∂îÍ∞Ä
      state.employees.filter(e => e.status === 'active').forEach(emp => {
        if (!employeeOrder.includes(emp.name)) {
          orderedEmployees.push(emp);
        }
      });

      return `
        <div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <h2 style="margin:0;font-size:24px;font-weight:600;">${excelT.title || 'Excel View'}</h2>
            <button onclick="downloadExcel()" class="btn-primary" style="display:inline-flex;align-items:center;gap:8px;">
              üì• Download Excel
            </button>
          </div>
          
          <div style="overflow-x:auto;max-height:calc(100vh - 200px);border:3px solid #333;border-radius:8px;">
            <table style="width:100%;border-collapse:collapse;background:white;font-size:13px;">
              <thead style="position:sticky;top:0;z-index:10;">
                <tr style="background:#7f1d1d;color:white;">
                  <th style="padding:10px;border:2px solid #333;width:35px;position:sticky;left:0;background:#7f1d1d;z-index:11;">#</th>
                  <th style="padding:10px;border:2px solid #333;width:90px;position:sticky;left:35px;background:#7f1d1d;z-index:11;">Name</th>
                  ${DAYS.map(day => {
                    const dayT = TRANSLATIONS[state.language];
                    return `
                      <th style="padding:10px;border:2px solid #333;min-width:110px;">
                        ${dayT.days?.[day] || day}
                      </th>
                    `;
                  }).join('')}
                </tr>
              </thead>
              <tbody>
                ${orderedEmployees.map((emp, idx) => {
                  return `
                    <!-- Lunch Row -->
                    <tr>
                      <td rowspan="2" style="padding:8px;border:2px solid #333;text-align:center;background:#f0f0f0;font-weight:700;position:sticky;left:0;z-index:5;">${idx + 1}</td>
                      <td style="padding:8px;border:2px solid #333;font-weight:600;background:#FFF9E6;position:sticky;left:35px;z-index:5;">
                        ${emp.name}
                        <div style="font-size:10px;color:#666;font-weight:400;">Lunch</div>
                      </td>
                      ${DAYS.map(day => {
                        const daySchedule = state.schedule[day] || {};
                        const lunchShift = (daySchedule.lunch || []).find(e => e.id === emp.id);
                        
                        return `
                          <td onclick="editShift('${emp.id}', '${day}', 'lunch')" 
                              style="padding:8px;border:2px solid #333;cursor:pointer;text-align:center;
                                     background:${getShiftColor(lunchShift?.shift)};
                                     ${lunchShift ? 'font-weight:600;' : ''}
                                     transition:background 0.2s;">
                            ${lunchShift ? lunchShift.shift : ''}
                          </td>
                        `;
                      }).join('')}
                    </tr>
                    <!-- Dinner Row -->
                    <tr>
                      <td style="padding:8px;border:2px solid #333;font-weight:600;background:#E6F3FF;position:sticky;left:35px;z-index:5;">
                        ${emp.name}
                        <div style="font-size:10px;color:#666;font-weight:400;">Dinner</div>
                      </td>
                      ${DAYS.map(day => {
                        const daySchedule = state.schedule[day] || {};
                        const dinnerShift = (daySchedule.dinner || []).find(e => e.id === emp.id);
                        
                        return `
                          <td onclick="editShift('${emp.id}', '${day}', 'dinner')" 
                              style="padding:8px;border:2px solid #333;cursor:pointer;text-align:center;
                                     background:${getShiftColor(dinnerShift?.shift)};
                                     ${dinnerShift ? 'font-weight:600;' : ''}
                                     transition:background 0.2s;">
                            ${dinnerShift ? dinnerShift.shift : ''}
                          </td>
                        `;
                      }).join('')}
                    </tr>
                  `;
                }).join('')}
              </tbody>
              <tfoot style="position:sticky;bottom:0;background:white;z-index:8;">
                <tr style="background:#E8F5E9;font-weight:700;font-size:12px;">
                  <td colspan="2" style="padding:10px;border:2px solid #333;text-align:right;position:sticky;left:0;background:#E8F5E9;z-index:9;">
                    Lunch:
                  </td>
                  ${DAYS.map(day => {
                    const daySchedule = state.schedule[day] || {};
                    const lunchCount = (daySchedule.lunch || []).length;
                    return `
                      <td style="padding:10px;border:2px solid #333;text-align:center;color:#2E7D32;">${lunchCount}</td>
                    `;
                  }).join('')}
                </tr>
                <tr style="background:#E3F2FD;font-weight:700;font-size:12px;">
                  <td colspan="2" style="padding:10px;border:2px solid #333;text-align:right;position:sticky;left:0;background:#E3F2FD;z-index:9;">
                    Dinner:
                  </td>
                  ${DAYS.map(day => {
                    const daySchedule = state.schedule[day] || {};
                    const dinnerCount = (daySchedule.dinner || []).length;
                    return `
                      <td style="padding:10px;border:2px solid #333;text-align:center;color:#1565C0;">${dinnerCount}</td>
                    `;
                  }).join('')}
                </tr>
                <tr style="background:#FFF3E0;font-weight:700;font-size:12px;">
                  <td colspan="2" style="padding:10px;border:2px solid #333;text-align:right;position:sticky;left:0;background:#FFF3E0;z-index:9;">
                    All Day:
                  </td>
                  ${DAYS.map(day => {
                    const daySchedule = state.schedule[day] || {};
                    const lunchNames = (daySchedule.lunch || []).map(e => e.name);
                    const dinnerNames = (daySchedule.dinner || []).map(e => e.name);
                    const allDayCount = lunchNames.filter(name => dinnerNames.includes(name)).length;
                    return `
                      <td style="padding:10px;border:2px solid #333;text-align:center;color:#F57C00;">${allDayCount}</td>
                    `;
                  }).join('')}
                </tr>
              </tfoot>
            </table>
          </div>

          <div style="margin-top:16px;padding:12px;background:#E3F2FD;border-radius:8px;font-size:13px;">
            üí° <strong>Tip:</strong> Click any cell to edit shift. Use arrow keys or scroll to navigate.
          </div>
        </div>
      `;
    }

    // ÏãúÌîÑÌä∏ ÏÉâÏÉÅ Î∞òÌôò
    function getShiftColor(shift) {
      if (!shift) return '#ffffff';
      if (shift.includes('Open')) return '#FFD93D';  // üü° ÎÖ∏ÎûÄÏÉâ
      if (shift.includes('11:00') || shift.includes('11:30')) return '#6BCB77';  // üü¢ Ï¥àÎ°ùÏÉâ
      if (shift.includes('3:30')) return '#4D96FF';  // üîµ ÌååÎûÄÏÉâ
      if (shift.includes('6:00') || shift.includes('6 PM')) return '#9D4EDD';  // üü£ Î≥¥ÎùºÏÉâ
      return '#ffffff';
    }

    // ÏãúÌîÑÌä∏ ÏÉâÏÉÅ ARGB Î∞òÌôò (ExcelJSÏö©)
    function getShiftColorARGB(shift) {
      if (!shift) return 'FFFFFFFF';
      if (shift.includes('Open')) return 'FFFFD93D';  // üü° ÎÖ∏ÎûÄÏÉâ
      if (shift.includes('11:00') || shift.includes('11:30')) return 'FF6BCB77';  // üü¢ Ï¥àÎ°ùÏÉâ
      if (shift.includes('3:30')) return 'FF4D96FF';  // üîµ ÌååÎûÄÏÉâ
      if (shift.includes('6:00') || shift.includes('6 PM')) return 'FF9D4EDD';  // üü£ Î≥¥ÎùºÏÉâ
      return 'FFFFFFFF';
    }

    // SECTIONS TAB - ÏÑπÏÖò ÌÉ≠
    // ============================================
    function renderTipsTab(t) {
      // Tips ÏÑúÎ∏åÌÉ≠
      const tipsSubTab = state.tipsSubTab || 'entry';
      
      return `
        <div style="padding:20px;">
          <!-- ÏÑúÎ∏åÌÉ≠ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò -->
          <div style="display:flex;gap:8px;margin-bottom:20px;border-bottom:2px solid #e2e8f0;padding-bottom:10px;">
            <button 
              onclick="setTipsSubTab('entry')" 
              style="padding:10px 20px;border:none;background:${tipsSubTab === 'entry' ? '#7f1d1d' : 'transparent'};color:${tipsSubTab === 'entry' ? 'white' : '#64748b'};border-radius:8px 8px 0 0;cursor:pointer;font-weight:600;">
              üìÖ Tip Entry
            </button>
            <button 
              onclick="setTipsSubTab('statistics')" 
              style="padding:10px 20px;border:none;background:${tipsSubTab === 'statistics' ? '#7f1d1d' : 'transparent'};color:${tipsSubTab === 'statistics' ? 'white' : '#64748b'};border-radius:8px 8px 0 0;cursor:pointer;font-weight:600;">
              üìä Statistics
            </button>
            <button 
              onclick="setTipsSubTab('settlement')" 
              style="padding:10px 20px;border:none;background:${tipsSubTab === 'settlement' ? '#7f1d1d' : 'transparent'};color:${tipsSubTab === 'settlement' ? 'white' : '#64748b'};border-radius:8px 8px 0 0;cursor:pointer;font-weight:600;">
              üí∞ Settlement
            </button>
            <button 
              onclick="setTipsSubTab('history')" 
              style="padding:10px 20px;border:none;background:${tipsSubTab === 'history' ? '#7f1d1d' : 'transparent'};color:${tipsSubTab === 'history' ? 'white' : '#64748b'};border-radius:8px 8px 0 0;cursor:pointer;font-weight:600;">
              üìú History
            </button>
          </div>
          
          <!-- ÏÑúÎ∏åÌÉ≠ ÎÇ¥Ïö© -->
          ${tipsSubTab === 'entry' ? renderTipEntry(t) : ''}
          ${tipsSubTab === 'statistics' ? renderTipStatistics(t) : ''}
          ${tipsSubTab === 'settlement' ? renderTipSettlement(t) : ''}
          ${tipsSubTab === 'history' ? renderTipHistory(t) : ''}
        </div>
      `;
    }
    
    // Tip Entry ÌÉ≠
    function renderTipEntry(t) {
      const step = state.tipEntryStep;
      
      // Step 0: Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ ÏàòÏ†ï/Ï∂îÍ∞Ä Î™®Îìú
      if (step === 'edit-existing') {
        return renderEditExistingTips();
      }
      
      // Step 1: ÎÇ†Ïßú ÏÑ†ÌÉù
      if (step === 'select-date') {
        return renderTipCalendar();
      }
      
      // Step 2: Í∑ºÎ¨¥Ïûê ÏÑ†ÌÉù (Lunch/Dinner ÌÜµÌï©)
      if (step === 'worker-select') {
        return renderWorkerSelection();
      }
      
      // Step 3: Lunch ÌåÅ ÏûÖÎ†•
      if (step === 'lunch-entry') {
        return renderTipInput('lunch');
      }
      
      // Step 4: Dinner ÌåÅ ÏûÖÎ†•
      if (step === 'dinner-entry') {
        return renderTipInput('dinner');
      }
    }
    
    // Í∏∞Ï°¥ ÌåÅ ÏàòÏ†ï/Ï∂îÍ∞Ä ÌôîÎ©¥
    function renderEditExistingTips() {
      const activeEmployees = state.employees.filter(e => e.status === 'active');
      const lunchTips = state.lunchTips || {};
      const dinnerTips = state.dinnerTips || {};
      
      // ÏïÑÏßÅ Ï∂îÍ∞Ä Ïïà Îêú ÏßÅÏõêÎì§
      const lunchEmployees = activeEmployees.filter(emp => !lunchTips[emp.name]);
      const dinnerEmployees = activeEmployees.filter(emp => !dinnerTips[emp.name]);
      
      return `
        <div style="max-width:900px;margin:0 auto;padding:20px;">
          <h2 style="color:#7f1d1d;margin-bottom:8px;text-align:center;">‚úèÔ∏è Edit Tips</h2>
          <p style="text-align:center;color:#64748b;margin-bottom:30px;">
            ${new Date(state.selectedTipDate).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
          </p>
          
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
            <!-- Lunch Tips -->
            <div>
              <h3 style="color:#92400e;margin-bottom:16px;display:flex;align-items:center;gap:8px;">
                <span>üåû</span>
                <span>Lunch Tips</span>
              </h3>
              
              <!-- Í∏∞Ï°¥ Lunch ÌåÅ -->
              <div style="background:white;border-radius:8px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,0.1);margin-bottom:16px;">
                ${Object.keys(lunchTips).length > 0 ? 
                  Object.keys(lunchTips).map(empName => `
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;padding:8px;background:#fef3c7;border-radius:6px;">
                      <span style="flex:1;font-weight:600;color:#2c3e50;">${empName}</span>
                      <div style="display:flex;align-items:center;gap:4px;">
                        <span style="color:#92400e;font-weight:600;">$</span>
                        <input type="number" 
                               step="0.01" 
                               value="${lunchTips[empName]}" 
                               onchange="updateExistingTip('lunch', '${empName}', this.value)"
                               style="width:90px;padding:6px;border:2px solid #fbbf24;border-radius:4px;text-align:right;background:white;">
                        <button onclick="deleteExistingTip('lunch', '${empName}')" 
                                style="padding:6px 10px;background:#ef4444;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:600;">
                          ‚úï
                        </button>
                      </div>
                    </div>
                  `).join('') : 
                  '<p style="color:#64748b;text-align:center;padding:20px;font-size:0.875rem;">No lunch tips yet</p>'
                }
              </div>
              
              <!-- ÏÉà Lunch ÌåÅ Ï∂îÍ∞Ä -->
              ${lunchEmployees.length > 0 ? `
                <div style="background:#fff7ed;border-radius:8px;padding:16px;border:2px dashed #fbbf24;">
                  <div style="font-weight:600;color:#92400e;margin-bottom:12px;font-size:0.875rem;">‚ûï Add Lunch Tip</div>
                  <div style="display:flex;gap:8px;margin-bottom:8px;">
                    <select id="newLunchEmployee" style="flex:1;padding:8px;border:2px solid #fbbf24;border-radius:6px;background:white;">
                      <option value="">Select employee...</option>
                      ${lunchEmployees.map(emp => `<option value="${emp.name}">${emp.name}</option>`).join('')}
                    </select>
                    <div style="display:flex;align-items:center;gap:4px;">
                      <span style="color:#92400e;font-weight:600;">$</span>
                      <input type="number" 
                             id="newLunchAmount" 
                             step="0.01" 
                             placeholder="0.00"
                             style="width:90px;padding:8px;border:2px solid #fbbf24;border-radius:6px;text-align:right;">
                    </div>
                  </div>
                  <button onclick="addNewTip('lunch')" 
                          style="width:100%;padding:10px;background:#fbbf24;color:#92400e;border:none;border-radius:6px;cursor:pointer;font-weight:700;">
                    ‚ûï Add
                  </button>
                </div>
              ` : '<p style="color:#64748b;text-align:center;padding:12px;font-size:0.875rem;background:#f8fafc;border-radius:6px;">All employees added</p>'}
            </div>
            
            <!-- Dinner Tips -->
            <div>
              <h3 style="color:#1e40af;margin-bottom:16px;display:flex;align-items:center;gap:8px;">
                <span>üåô</span>
                <span>Dinner Tips</span>
              </h3>
              
              <!-- Í∏∞Ï°¥ Dinner ÌåÅ -->
              <div style="background:white;border-radius:8px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,0.1);margin-bottom:16px;">
                ${Object.keys(dinnerTips).length > 0 ? 
                  Object.keys(dinnerTips).map(empName => `
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;padding:8px;background:#dbeafe;border-radius:6px;">
                      <span style="flex:1;font-weight:600;color:#2c3e50;">${empName}</span>
                      <div style="display:flex;align-items:center;gap:4px;">
                        <span style="color:#1e40af;font-weight:600;">$</span>
                        <input type="number" 
                               step="0.01" 
                               value="${dinnerTips[empName]}" 
                               onchange="updateExistingTip('dinner', '${empName}', this.value)"
                               style="width:90px;padding:6px;border:2px solid #60a5fa;border-radius:4px;text-align:right;background:white;">
                        <button onclick="deleteExistingTip('dinner', '${empName}')" 
                                style="padding:6px 10px;background:#ef4444;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:600;">
                          ‚úï
                        </button>
                      </div>
                    </div>
                  `).join('') : 
                  '<p style="color:#64748b;text-align:center;padding:20px;font-size:0.875rem;">No dinner tips yet</p>'
                }
              </div>
              
              <!-- ÏÉà Dinner ÌåÅ Ï∂îÍ∞Ä -->
              ${dinnerEmployees.length > 0 ? `
                <div style="background:#eff6ff;border-radius:8px;padding:16px;border:2px dashed #60a5fa;">
                  <div style="font-weight:600;color:#1e40af;margin-bottom:12px;font-size:0.875rem;">‚ûï Add Dinner Tip</div>
                  <div style="display:flex;gap:8px;margin-bottom:8px;">
                    <select id="newDinnerEmployee" style="flex:1;padding:8px;border:2px solid #60a5fa;border-radius:6px;background:white;">
                      <option value="">Select employee...</option>
                      ${dinnerEmployees.map(emp => `<option value="${emp.name}">${emp.name}</option>`).join('')}
                    </select>
                    <div style="display:flex;align-items:center;gap:4px;">
                      <span style="color:#1e40af;font-weight:600;">$</span>
                      <input type="number" 
                             id="newDinnerAmount" 
                             step="0.01" 
                             placeholder="0.00"
                             style="width:90px;padding:8px;border:2px solid #60a5fa;border-radius:6px;text-align:right;">
                    </div>
                  </div>
                  <button onclick="addNewTip('dinner')" 
                          style="width:100%;padding:10px;background:#60a5fa;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:700;">
                    ‚ûï Add
                  </button>
                </div>
              ` : '<p style="color:#64748b;text-align:center;padding:12px;font-size:0.875rem;background:#f8fafc;border-radius:6px;">All employees added</p>'}
            </div>
          </div>
          
          <div style="display:flex;gap:12px;margin-top:30px;">
            <button onclick="state.tipEntryStep='select-date';render();" 
                    style="flex:1;padding:14px;background:white;color:#7f1d1d;border:2px solid #7f1d1d;border-radius:8px;cursor:pointer;font-weight:700;">
              ‚Üê Back to Calendar
            </button>
            <button onclick="saveEditedTips()" 
                    style="flex:2;padding:14px;background:#22c55e;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:1.1rem;">
              üíæ Save Changes
            </button>
          </div>
        </div>
      `;
    }
    
    // Í∏∞Ï°¥ ÌåÅ ÏóÖÎç∞Ïù¥Ìä∏
    window.updateExistingTip = (shift, empName, amount) => {
      const value = parseFloat(amount) || 0;
      if (shift === 'lunch') {
        state.lunchTips[empName] = value;
      } else {
        state.dinnerTips[empName] = value;
      }
    };
    
    // Í∏∞Ï°¥ ÌåÅ ÏÇ≠Ï†ú
    window.deleteExistingTip = (shift, empName) => {
      if (confirm(`Delete ${empName}'s ${shift} tip?`)) {
        if (shift === 'lunch') {
          delete state.lunchTips[empName];
        } else {
          delete state.dinnerTips[empName];
        }
        render();
      }
    };
    
    // ÏÉà ÌåÅ Ï∂îÍ∞Ä
    window.addNewTip = (shift) => {
      const employeeSelect = document.getElementById(`new${shift === 'lunch' ? 'Lunch' : 'Dinner'}Employee`);
      const amountInput = document.getElementById(`new${shift === 'lunch' ? 'Lunch' : 'Dinner'}Amount`);
      
      const empName = employeeSelect.value;
      const amount = parseFloat(amountInput.value) || 0;
      
      if (!empName) {
        alert('Please select an employee');
        return;
      }
      
      if (amount <= 0) {
        alert('Please enter a valid amount');
        return;
      }
      
      if (shift === 'lunch') {
        state.lunchTips[empName] = amount;
      } else {
        state.dinnerTips[empName] = amount;
      }
      
      render();
    };
    
    // ÏàòÏ†ïÎêú ÌåÅ Ï†ÄÏû•
    window.saveEditedTips = async () => {
      const date = state.selectedTipDate;
      
      // $0 Ï†úÏô∏
      const filteredLunchTips = {};
      Object.keys(state.lunchTips).forEach(empName => {
        const amount = parseFloat(state.lunchTips[empName]) || 0;
        if (amount > 0) {
          filteredLunchTips[empName] = amount;
        }
      });
      
      const filteredDinnerTips = {};
      Object.keys(state.dinnerTips).forEach(empName => {
        const amount = parseFloat(state.dinnerTips[empName]) || 0;
        if (amount > 0) {
          filteredDinnerTips[empName] = amount;
        }
      });
      
      state.tipsData[date] = {
        lunch: filteredLunchTips,
        dinner: filteredDinnerTips
      };
      
      await storage.saveData('tips', state.tipsData);
      await updateTipStats();
      
      alert('‚úÖ Tips updated successfully!');
      state.tipEntryStep = 'select-date';
      state.selectedTipDate = null;
      render();
    };
    
    // Îã¨Î†• Î†åÎçîÎßÅ
    function renderTipCalendar() {
      const year = state.tipCalendarMonth.getFullYear();
      const month = state.tipCalendarMonth.getMonth();
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                          'July', 'August', 'September', 'October', 'November', 'December'];
      
      let calendar = '';
      let dayCount = 1;
      
      for (let week = 0; week < 6; week++) {
        let weekHtml = '<tr>';
        for (let day = 0; day < 7; day++) {
          if ((week === 0 && day < firstDay) || dayCount > daysInMonth) {
            weekHtml += '<td></td>';
          } else {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(dayCount).padStart(2, '0')}`;
            const hasTips = state.tipsData[dateStr];
            
            // Ïò§Îäò ÎÇ†Ïßú ÎπÑÍµê (Î°úÏª¨ ÏãúÍ∞ÑÎåÄ)
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            const isToday = dateStr === todayStr;
            
            weekHtml += `
              <td onclick="selectTipDate('${dateStr}')" 
                  style="padding:12px;text-align:center;cursor:pointer;border:1px solid #e2e8f0;
                         background:${isToday ? '#fff7ed' : 'white'};
                         position:relative;
                         ${hasTips ? 'font-weight:700;' : ''}">
                ${dayCount}
                ${hasTips ? '<div style="width:6px;height:6px;background:#7f1d1d;border-radius:50%;position:absolute;bottom:4px;left:50%;transform:translateX(-50%);"></div>' : ''}
              </td>
            `;
            dayCount++;
          }
        }
        weekHtml += '</tr>';
        calendar += weekHtml;
        if (dayCount > daysInMonth) break;
      }
      
      return `
        <div style="max-width:600px;margin:0 auto;padding:20px;">
          <h2 style="color:#7f1d1d;margin-bottom:20px;text-align:center;">üìÖ Select Date</h2>
          
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <button onclick="changeCalendarMonth(-1)" style="padding:8px 16px;background:#7f1d1d;color:white;border:none;border-radius:6px;cursor:pointer;">
              ‚Üê Prev
            </button>
            <h3 style="margin:0;">${monthNames[month]} ${year}</h3>
            <button onclick="changeCalendarMonth(1)" style="padding:8px 16px;background:#7f1d1d;color:white;border:none;border-radius:6px;cursor:pointer;">
              Next ‚Üí
            </button>
          </div>
          
          <table style="width:100%;border-collapse:collapse;background:white;border-radius:8px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
            <thead>
              <tr style="background:#f8fafc;">
                <th style="padding:12px;color:#64748b;font-weight:600;">Sun</th>
                <th style="padding:12px;color:#64748b;font-weight:600;">Mon</th>
                <th style="padding:12px;color:#64748b;font-weight:600;">Tue</th>
                <th style="padding:12px;color:#64748b;font-weight:600;">Wed</th>
                <th style="padding:12px;color:#64748b;font-weight:600;">Thu</th>
                <th style="padding:12px;color:#64748b;font-weight:600;">Fri</th>
                <th style="padding:12px;color:#64748b;font-weight:600;">Sat</th>
              </tr>
            </thead>
            <tbody>
              ${calendar}
            </tbody>
          </table>
          
          <p style="text-align:center;color:#64748b;margin-top:20px;font-size:0.875rem;">
            ‚Ä¢ <span style="color:#7f1d1d;font-weight:700;">Bold dates</span> have tips recorded
          </p>
        </div>
      `;
    }
    
    // Îã¨Î†• Ïõî Î≥ÄÍ≤Ω
    window.changeCalendarMonth = (delta) => {
      const newMonth = new Date(state.tipCalendarMonth);
      newMonth.setMonth(newMonth.getMonth() + delta);
      state.tipCalendarMonth = newMonth;
      render();
    };
    
    // Í∑ºÎ¨¥Ïûê ÏÑ†ÌÉù ÌôîÎ©¥ (ÌÜµÌï©)
    function renderWorkerSelection() {
      const workers = state.lunchWorkers; // ÌïòÎÇòÏùò Î¶¨Ïä§Ìä∏Î°ú ÌÜµÌï©
      const activeEmployees = state.employees.filter(e => e.status === 'active');
      
      if (activeEmployees.length === 0) {
        return `
          <div style="text-align:center;padding:60px;">
            <div style="font-size:48px;margin-bottom:16px;">üë•</div>
            <h2 style="color:#7f1d1d;margin-bottom:8px;">No Employees</h2>
            <p style="color:#64748b;">Please add employees first</p>
            <button onclick="state.tipEntryStep='select-date';render();" 
                    style="margin-top:20px;padding:10px 20px;background:#7f1d1d;color:white;border:none;border-radius:6px;cursor:pointer;">
              ‚Üê Back to Calendar
            </button>
          </div>
        `;
      }
      
      return `
        <div style="max-width:600px;margin:0 auto;padding:20px;">
          <h2 style="color:#7f1d1d;margin-bottom:8px;text-align:center;">üë• Select Workers</h2>
          <p style="text-align:center;color:#64748b;margin-bottom:20px;">
            ${new Date(state.selectedTipDate).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
          </p>
          <p style="text-align:center;color:#64748b;margin-bottom:30px;font-weight:600;">
            Select employees who worked (Lunch or Dinner)
          </p>
          
          <div style="background:white;border-radius:8px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
            ${activeEmployees.map(emp => {
              const isSelected = workers.includes(emp.name);
              return `
                <div onclick="toggleWorker('${emp.name}')" 
                     style="display:flex;align-items:center;gap:12px;padding:12px;margin-bottom:8px;
                            background:${isSelected ? '#f0fdf4' : '#f8fafc'};
                            border:2px solid ${isSelected ? '#22c55e' : '#e2e8f0'};
                            border-radius:8px;cursor:pointer;transition:all 0.2s;">
                  <div style="width:24px;height:24px;border-radius:4px;
                              background:${isSelected ? '#22c55e' : 'white'};
                              border:2px solid ${isSelected ? '#22c55e' : '#cbd5e1'};
                              display:flex;align-items:center;justify-content:center;
                              color:white;font-weight:700;font-size:16px;">
                    ${isSelected ? '‚úì' : ''}
                  </div>
                  <span style="font-weight:600;color:#2c3e50;">${emp.name}</span>
                </div>
              `;
            }).join('')}
          </div>
          
          <div style="display:flex;gap:12px;margin-top:30px;">
            <button onclick="state.tipEntryStep='select-date';render();" 
                    style="flex:1;padding:12px;background:white;color:#7f1d1d;border:2px solid #7f1d1d;border-radius:8px;cursor:pointer;font-weight:600;">
              ‚Üê Back
            </button>
            <button onclick="proceedToLunchEntry()" 
                    style="flex:1;padding:12px;background:#7f1d1d;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;
                           ${workers.length === 0 ? 'opacity:0.5;cursor:not-allowed;' : ''}"
                    ${workers.length === 0 ? 'disabled' : ''}>
              Next: Enter Tips ‚Üí
            </button>
          </div>
        </div>
      `;
    }
    
    // Í∑ºÎ¨¥Ïûê ÌÜ†Í∏Ä (ÌÜµÌï©)
    window.toggleWorker = (empName) => {
      const index = state.lunchWorkers.indexOf(empName);
      if (index === -1) {
        state.lunchWorkers.push(empName);
      } else {
        state.lunchWorkers.splice(index, 1);
      }
      render();
    };
    
    // Lunch ÏûÖÎ†•ÏúºÎ°ú ÏßÑÌñâ
    window.proceedToLunchEntry = () => {
      if (state.lunchWorkers.length === 0) {
        alert('Please select at least one employee');
        return;
      }
      state.tipEntryStep = 'lunch-entry';
      render();
    };
    
    // ÌåÅ ÏûÖÎ†• ÌôîÎ©¥
    function renderTipInput(shift) {
      const shiftName = shift === 'lunch' ? 'üåû Lunch' : 'üåô Dinner';
      const workers = state.lunchWorkers; // ÏÑ†ÌÉùÎêú Ï†ÑÏ≤¥ Í∑ºÎ¨¥Ïûê ÏÇ¨Ïö©
      const tips = shift === 'lunch' ? state.lunchTips : state.dinnerTips;
      
      return `
        <div style="max-width:600px;margin:0 auto;padding:20px;">
          <h2 style="color:#7f1d1d;margin-bottom:8px;text-align:center;">${shiftName} Tips</h2>
          <p style="text-align:center;color:#64748b;margin-bottom:30px;">
            ${new Date(state.selectedTipDate).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
          </p>
          
          <div style="background:white;border-radius:8px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
            ${workers.map(empName => `
              <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                <span style="flex:1;font-weight:600;color:#2c3e50;">${empName}</span>
                <div style="display:flex;align-items:center;gap:8px;">
                  <span style="color:#64748b;font-size:1.2rem;font-weight:600;">$</span>
                  <input type="number" 
                         step="0.01" 
                         value="${tips[empName] || ''}" 
                         onchange="set${shift === 'lunch' ? 'Lunch' : 'Dinner'}Tip('${empName}', this.value)"
                         placeholder="0.00"
                         style="width:120px;padding:10px;border:2px solid #e2e8f0;border-radius:6px;font-size:1rem;text-align:right;">
                </div>
              </div>
            `).join('')}
          </div>
          
          <p style="text-align:center;color:#64748b;margin-top:20px;font-size:0.875rem;">
            üí° Enter $0 if they didn't work this shift
          </p>
          
          <div style="display:flex;gap:12px;margin-top:30px;">
            <button onclick="state.tipEntryStep='worker-select';render();" 
                    style="flex:1;padding:12px;background:white;color:#7f1d1d;border:2px solid #7f1d1d;border-radius:8px;cursor:pointer;font-weight:600;">
              ‚Üê Back
            </button>
            <button onclick="confirmAnd${shift === 'lunch' ? 'SaveLunch' : 'SaveDinner'}Tips()" 
                    style="flex:1;padding:12px;background:#22c55e;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;">
              ${shift === 'lunch' ? 'üíæ Save & Next' : '‚úÖ Save'}
            </button>
          </div>
        </div>
      `;
    }
    
    // Lunch ÌåÅ ÌôïÏù∏ Î∞è Ï†ÄÏû•
    window.confirmAndSaveLunchTips = () => {
      const workers = state.lunchWorkers;
      const tips = state.lunchTips;
      
      // $0 Ï†úÏô∏ÌïòÍ≥† Ïã§Ï†ú ÏùºÌïú ÏÇ¨ÎûåÎßå ÌïÑÌÑ∞ÎßÅ
      const workedList = workers
        .filter(name => (tips[name] || 0) > 0)
        .map(name => ({ name, amount: tips[name] || 0 }))
        .sort((a, b) => b.amount - a.amount); // ÎÜíÏùÄ Í∞ÄÍ≤©Ïàú
      
      if (workedList.length === 0) {
        if (confirm('No tips entered for Lunch. Skip Lunch and continue to Dinner?')) {
          state.tipEntryStep = 'dinner-entry';
          render();
        }
        return;
      }
      
      // Ï¥ùÏï° Í≥ÑÏÇ∞
      const total = workedList.reduce((sum, w) => sum + w.amount, 0);
      
      // Ïª§Ïä§ÌÖÄ Î™®Îã¨ ÌëúÏãú
      state.confirmModal = {
        shift: 'lunch',
        workers: workedList,
        total: total,
        onConfirm: () => {
          state.confirmModal = null;
          saveLunchTips();
        },
        onCancel: () => {
          state.confirmModal = null;
          render();
        }
      };
      render();
    };
    
    // Dinner ÌåÅ ÌôïÏù∏ Î∞è Ï†ÄÏû•
    window.confirmAndSaveDinnerTips = () => {
      const workers = state.lunchWorkers;
      const tips = state.dinnerTips;
      
      // $0 Ï†úÏô∏ÌïòÍ≥† Ïã§Ï†ú ÏùºÌïú ÏÇ¨ÎûåÎßå ÌïÑÌÑ∞ÎßÅ
      const workedList = workers
        .filter(name => (tips[name] || 0) > 0)
        .map(name => ({ name, amount: tips[name] || 0 }))
        .sort((a, b) => b.amount - a.amount); // ÎÜíÏùÄ Í∞ÄÍ≤©Ïàú
      
      if (workedList.length === 0) {
        if (confirm('No tips entered for Dinner. Save anyway?')) {
          saveDinnerTips();
        }
        return;
      }
      
      // Ï¥ùÏï° Í≥ÑÏÇ∞
      const total = workedList.reduce((sum, w) => sum + w.amount, 0);
      
      // Ïª§Ïä§ÌÖÄ Î™®Îã¨ ÌëúÏãú
      state.confirmModal = {
        shift: 'dinner',
        workers: workedList,
        total: total,
        onConfirm: () => {
          state.confirmModal = null;
          saveDinnerTips();
        },
        onCancel: () => {
          state.confirmModal = null;
          render();
        }
      };
      render();
    };
    
    // Statistics ÌÉ≠
    function renderTipStatistics(t) {
      const employees = Object.keys(state.tipStats);
      
      if (employees.length === 0) {
        return `
          <div style="text-align:center;padding:60px;">
            <div style="font-size:48px;margin-bottom:16px;">üìä</div>
            <h2 style="color:#7f1d1d;margin-bottom:8px;">No Statistics Yet</h2>
            <p style="color:#64748b;">Enter tips first to see statistics</p>
          </div>
        `;
      }
      
      // Ï†ÑÏ≤¥ Ìï©Í≥Ñ Í≥ÑÏÇ∞
      let totalPending = 0;
      let totalPaid = 0;
      let grandTotal = 0;
      
      employees.forEach(empName => {
        const stats = state.tipStats[empName];
        totalPending += stats.pending || 0;
        totalPaid += stats.paid || 0;
        grandTotal += stats.total || 0;
      });
      
      return `
        <div style="max-width:800px;margin:0 auto;padding:20px;">
          <h2 style="color:#7f1d1d;margin-bottom:30px;text-align:center;">üìä Tip Statistics</h2>
          
          <!-- Ï†ÑÏ≤¥ ÏöîÏïΩ -->
          <div style="background:linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%);color:white;border-radius:12px;padding:24px;margin-bottom:30px;box-shadow:0 4px 12px rgba(127,29,29,0.2);">
            <h3 style="margin:0 0 16px 0;font-size:1.1rem;opacity:0.9;">Overall Summary</h3>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:20px;">
              <div>
                <div style="font-size:0.875rem;opacity:0.9;margin-bottom:4px;">üí∞ Total (All)</div>
                <div style="font-size:1.75rem;font-weight:700;">$${grandTotal.toFixed(2)}</div>
              </div>
              <div>
                <div style="font-size:0.875rem;opacity:0.9;margin-bottom:4px;">‚è≥ Pending</div>
                <div style="font-size:1.75rem;font-weight:700;">$${totalPending.toFixed(2)}</div>
              </div>
              <div>
                <div style="font-size:0.875rem;opacity:0.9;margin-bottom:4px;">‚úÖ Paid</div>
                <div style="font-size:1.75rem;font-weight:700;">$${totalPaid.toFixed(2)}</div>
              </div>
            </div>
          </div>
          
          <!-- ÏßÅÏõêÎ≥Ñ ÌÜµÍ≥Ñ -->
          <div style="display:grid;gap:16px;">
            ${employees.map(empName => {
              const stats = state.tipStats[empName];
              const emp = state.employees.find(e => e.name === empName);
              const isActive = emp && emp.status === 'active';
              
              return `
                <div style="background:white;border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1);border-left:4px solid ${isActive ? '#22c55e' : '#ef4444'};">
                  <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                    <div style="font-size:1.5rem;">üë§</div>
                    <div style="flex:1;">
                      <div style="font-size:1.25rem;font-weight:700;color:#2c3e50;">${empName}</div>
                      <div style="font-size:0.875rem;color:${isActive ? '#22c55e' : '#ef4444'};font-weight:600;">
                        ${isActive ? '‚úì Active' : '‚úó Left'}
                      </div>
                    </div>
                  </div>
                  
                  <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;">
                    <div style="text-align:center;padding:12px;background:#f8fafc;border-radius:8px;">
                      <div style="font-size:0.75rem;color:#64748b;margin-bottom:4px;font-weight:600;">üí∞ TOTAL</div>
                      <div style="font-size:1.25rem;font-weight:700;color:#2c3e50;">$${stats.total.toFixed(2)}</div>
                    </div>
                    <div style="text-align:center;padding:12px;background:#fef3c7;border-radius:8px;">
                      <div style="font-size:0.75rem;color:#92400e;margin-bottom:4px;font-weight:600;">‚è≥ PENDING</div>
                      <div style="font-size:1.25rem;font-weight:700;color:#92400e;">$${stats.pending.toFixed(2)}</div>
                    </div>
                    <div style="text-align:center;padding:12px;background:#d1fae5;border-radius:8px;">
                      <div style="font-size:0.75rem;color:#065f46;margin-bottom:4px;font-weight:600;">‚úÖ PAID</div>
                      <div style="font-size:1.25rem;font-weight:700;color:#065f46;">$${stats.paid.toFixed(2)}</div>
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }
    
    // Settlement ÌÉ≠
    function renderTipSettlement(t) {
      // Ï†ïÏÇ∞ ÏöîÏïΩÏù¥ ÏûàÏúºÎ©¥ ÌëúÏãú
      if (state.settlementSummary) {
        return renderSettlementSummary();
      }
      
      return `
        <div style="max-width:700px;margin:0 auto;padding:20px;">
          <h2 style="color:#7f1d1d;margin-bottom:30px;text-align:center;">üí∞ Tip Settlement</h2>
          
          <div style="background:white;border-radius:12px;padding:30px;box-shadow:0 2px 12px rgba(0,0,0,0.1);">
            <h3 style="color:#2c3e50;margin:0 0 24px 0;font-size:1.1rem;">Settlement Period</h3>
            
            <div style="display:grid;gap:20px;margin-bottom:30px;">
              <div>
                <label style="display:block;color:#64748b;font-weight:600;margin-bottom:8px;font-size:0.875rem;">
                  üìÖ Start Date
                </label>
                <input type="date" 
                       value="${state.settlementStart}" 
                       onchange="state.settlementStart=this.value;render();"
                       style="width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:8px;font-size:1rem;">
              </div>
              
              <div>
                <label style="display:block;color:#64748b;font-weight:600;margin-bottom:8px;font-size:0.875rem;">
                  üìÖ End Date
                </label>
                <input type="date" 
                       value="${state.settlementEnd}" 
                       onchange="state.settlementEnd=this.value;render();"
                       style="width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:8px;font-size:1rem;">
              </div>
            </div>
            
            <button onclick="calculateSettlement()" 
                    style="width:100%;padding:14px;background:#7f1d1d;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:1rem;
                           ${!state.settlementStart || !state.settlementEnd ? 'opacity:0.5;cursor:not-allowed;' : ''}"
                    ${!state.settlementStart || !state.settlementEnd ? 'disabled' : ''}>
              üîç Calculate Settlement
            </button>
          </div>
        </div>
      `;
    }
    
    // Ï†ïÏÇ∞ ÏöîÏïΩ ÌôîÎ©¥
    function renderSettlementSummary() {
      const summary = state.settlementSummary;
      const employees = Object.keys(summary.employees);
      let grandTotal = 0;
      
      employees.forEach(empName => {
        grandTotal += summary.employees[empName].total;
      });
      
      return `
        <div style="max-width:800px;margin:0 auto;padding:20px;">
          <h2 style="color:#7f1d1d;margin-bottom:8px;text-align:center;">üí∞ Settlement Summary</h2>
          <p style="text-align:center;color:#64748b;margin-bottom:30px;font-size:1rem;font-weight:600;">
            ${new Date(summary.startDate).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})} ~ 
            ${new Date(summary.endDate).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})}
          </p>
          
          <div style="display:grid;gap:16px;margin-bottom:30px;">
            ${employees.map(empName => {
              const empData = summary.employees[empName];
              const emp = state.employees.find(e => e.name === empName);
              const isActive = emp && emp.status === 'active';
              
              return `
                <div style="background:white;border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                  <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                    <div style="font-size:1.5rem;">üë§</div>
                    <div style="flex:1;">
                      <div style="font-size:1.25rem;font-weight:700;color:#2c3e50;">${empName}</div>
                      <div style="font-size:0.875rem;color:${isActive ? '#22c55e' : '#64748b'};font-weight:600;">
                        ${isActive ? 'Active' : 'Left'}
                      </div>
                    </div>
                    <div style="font-size:1.5rem;font-weight:700;color:#7f1d1d;">
                      $${empData.total.toFixed(2)}
                    </div>
                  </div>
                  
                  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <div style="background:#fef3c7;padding:12px;border-radius:8px;">
                      <div style="font-size:0.75rem;color:#92400e;margin-bottom:4px;font-weight:600;">üåû LUNCH</div>
                      <div style="font-size:1.1rem;font-weight:700;color:#92400e;">$${empData.lunch.toFixed(2)}</div>
                      <div style="font-size:0.75rem;color:#92400e;margin-top:4px;">
                        Days: ${empData.lunchDays.sort((a,b) => a-b).join(', ')}
                      </div>
                    </div>
                    <div style="background:#dbeafe;padding:12px;border-radius:8px;">
                      <div style="font-size:0.75rem;color:#1e40af;margin-bottom:4px;font-weight:600;">üåô DINNER</div>
                      <div style="font-size:1.1rem;font-weight:700;color:#1e40af;">$${empData.dinner.toFixed(2)}</div>
                      <div style="font-size:0.75rem;color:#1e40af;margin-top:4px;">
                        Days: ${empData.dinnerDays.sort((a,b) => a-b).join(', ')}
                      </div>
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
          
          <div style="background:linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%);color:white;border-radius:12px;padding:24px;margin-bottom:20px;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div style="font-size:1.25rem;font-weight:600;">üéØ Grand Total</div>
              <div style="font-size:2rem;font-weight:700;">$${grandTotal.toFixed(2)}</div>
            </div>
          </div>
          
          <div style="display:flex;gap:12px;">
            <button onclick="state.settlementSummary=null;render();" 
                    style="flex:1;padding:14px;background:white;color:#7f1d1d;border:2px solid #7f1d1d;border-radius:8px;cursor:pointer;font-weight:700;">
              ‚Üê Back
            </button>
            <button onclick="confirmSettlement()" 
                    style="flex:1;padding:14px;background:#22c55e;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:700;">
              ‚úÖ Confirm Settlement
            </button>
          </div>
        </div>
      `;
    }
    
    // History ÌÉ≠
    function renderTipHistory(t) {
      // ÏÑ†ÌÉùÎêú Ï†ïÏÇ∞ ÏÉÅÏÑ∏
      if (state.selectedSettlement) {
        return renderSettlementDetail();
      }
      
      if (state.settlements.length === 0) {
        return `
          <div style="text-align:center;padding:60px;">
            <div style="font-size:48px;margin-bottom:16px;">üìú</div>
            <h2 style="color:#7f1d1d;margin-bottom:8px;">No Settlement History</h2>
            <p style="color:#64748b;">Complete a settlement to see history</p>
          </div>
        `;
      }
      
      return `
        <div style="max-width:900px;margin:0 auto;padding:20px;">
          <h2 style="color:#7f1d1d;margin-bottom:30px;text-align:center;">üìú Settlement History</h2>
          
          <div style="display:grid;gap:16px;">
            ${state.settlements.map(settlement => {
              const startDate = new Date(settlement.startDate).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'});
              const endDate = new Date(settlement.endDate).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'});
              const settledDate = new Date(settlement.settledAt).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'});
              const empCount = Object.keys(settlement.employees).length;
              
              return `
                <div onclick="selectSettlement('${settlement.id}')" 
                     style="background:white;border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1);cursor:pointer;transition:all 0.2s;border-left:4px solid #7f1d1d;"
                     onmouseover="this.style.boxShadow='0 4px 16px rgba(127,29,29,0.2)'"
                     onmouseout="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
                  <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px;">
                    <div style="flex:1;">
                      <div style="font-size:1.25rem;font-weight:700;color:#2c3e50;margin-bottom:4px;">
                        ${startDate} ~ ${endDate}
                      </div>
                      <div style="font-size:0.875rem;color:#64748b;">
                        Settled: ${settledDate}
                      </div>
                    </div>
                    <div style="text-align:right;">
                      <div style="font-size:1.75rem;font-weight:700;color:#7f1d1d;">
                        $${settlement.grandTotal.toFixed(2)}
                      </div>
                      <div style="font-size:0.875rem;color:#64748b;">
                        ${empCount} employee${empCount > 1 ? 's' : ''}
                      </div>
                    </div>
                  </div>
                  
                  <div style="display:flex;gap:8px;align-items:center;color:#7f1d1d;font-weight:600;font-size:0.875rem;">
                    <span>View Details</span>
                    <span>‚Üí</span>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }
    
    // Ï†ïÏÇ∞ ÏÉÅÏÑ∏ ÌôîÎ©¥
    function renderSettlementDetail() {
      const settlement = state.selectedSettlement;
      const employees = Object.keys(settlement.employees);
      
      const startDate = new Date(settlement.startDate).toLocaleDateString('en-US', {month: 'long', day: 'numeric', year: 'numeric'});
      const endDate = new Date(settlement.endDate).toLocaleDateString('en-US', {month: 'long', day: 'numeric', year: 'numeric'});
      const settledDate = new Date(settlement.settledAt).toLocaleDateString('en-US', {month: 'long', day: 'numeric', year: 'numeric'});
      
      return `
        <div style="max-width:800px;margin:0 auto;padding:20px;">
          <button onclick="closeSettlementDetail()" 
                  style="padding:8px 16px;background:white;color:#7f1d1d;border:2px solid #7f1d1d;border-radius:6px;cursor:pointer;font-weight:600;margin-bottom:20px;">
            ‚Üê Back to History
          </button>
          
          <h2 style="color:#7f1d1d;margin-bottom:8px;text-align:center;">üí∞ Settlement Details</h2>
          <div style="text-align:center;margin-bottom:30px;">
            <p style="color:#2c3e50;font-size:1.1rem;font-weight:600;margin-bottom:4px;">
              ${startDate} ~ ${endDate}
            </p>
            <p style="color:#64748b;font-size:0.875rem;">
              Settled on: ${settledDate}
            </p>
          </div>
          
          <div style="display:grid;gap:16px;margin-bottom:30px;">
            ${employees.map(empName => {
              const empData = settlement.employees[empName];
              const emp = state.employees.find(e => e.name === empName);
              const isActive = emp && emp.status === 'active';
              
              return `
                <div style="background:white;border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                  <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                    <div style="font-size:1.5rem;">üë§</div>
                    <div style="flex:1;">
                      <div style="font-size:1.25rem;font-weight:700;color:#2c3e50;">${empName}</div>
                      <div style="font-size:0.875rem;color:${isActive ? '#22c55e' : '#ef4444'};font-weight:600;">
                        ${isActive ? '‚úì Active' : `‚úó Left${emp && emp.leftDate ? ' (' + new Date(emp.leftDate).toLocaleDateString('en-US', {month: 'short', day: 'numeric'}) + ')' : ''}`}
                      </div>
                    </div>
                    <div style="font-size:1.5rem;font-weight:700;color:#7f1d1d;">
                      $${empData.total.toFixed(2)}
                    </div>
                  </div>
                  
                  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <div style="background:#fef3c7;padding:12px;border-radius:8px;">
                      <div style="font-size:0.75rem;color:#92400e;margin-bottom:4px;font-weight:600;">üåû LUNCH</div>
                      <div style="font-size:1.1rem;font-weight:700;color:#92400e;margin-bottom:6px;">$${empData.lunch.toFixed(2)}</div>
                      <div style="font-size:0.75rem;color:#92400e;">
                        ${empData.lunchDays && empData.lunchDays.length > 0 ? 
                          '‚Ä¢ Days: ' + empData.lunchDays.sort((a,b) => a-b).join(', ') : 
                          '‚Ä¢ No shifts'}
                      </div>
                    </div>
                    <div style="background:#dbeafe;padding:12px;border-radius:8px;">
                      <div style="font-size:0.75rem;color:#1e40af;margin-bottom:4px;font-weight:600;">üåô DINNER</div>
                      <div style="font-size:1.1rem;font-weight:700;color:#1e40af;margin-bottom:6px;">$${empData.dinner.toFixed(2)}</div>
                      <div style="font-size:0.75rem;color:#1e40af;">
                        ${empData.dinnerDays && empData.dinnerDays.length > 0 ? 
                          '‚Ä¢ Days: ' + empData.dinnerDays.sort((a,b) => a-b).join(', ') : 
                          '‚Ä¢ No shifts'}
                      </div>
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
          
          <div style="background:linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%);color:white;border-radius:12px;padding:24px;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div style="font-size:1.25rem;font-weight:600;">üéØ Grand Total</div>
              <div style="font-size:2rem;font-weight:700;">$${settlement.grandTotal.toFixed(2)}</div>
            </div>
          </div>
        </div>
      `;
    }

    // ============================================
    // CONFIRM MODAL - ÌåÅ ÌôïÏù∏ Î™®Îã¨
    // ============================================
    function renderConfirmModal() {
      const modal = state.confirmModal;
      const shiftName = modal.shift === 'lunch' ? 'üåû Lunch' : 'üåô Dinner';
      const shiftColor = modal.shift === 'lunch' ? '#fbbf24' : '#60a5fa';
      const shiftBg = modal.shift === 'lunch' ? '#fef3c7' : '#dbeafe';
      
      return `
        <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10000;padding:20px;">
          <div style="background:white;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.3);max-width:500px;width:100%;max-height:80vh;display:flex;flex-direction:column;">
            <!-- Ìó§Îçî -->
            <div style="padding:24px;border-bottom:2px solid #e2e8f0;background:${shiftBg};border-radius:16px 16px 0 0;">
              <h2 style="margin:0;color:#2c3e50;font-size:1.5rem;display:flex;align-items:center;gap:12px;">
                <span style="font-size:2rem;">${modal.shift === 'lunch' ? 'üåû' : 'üåô'}</span>
                <span>${shiftName} Tips</span>
              </h2>
              <p style="margin:8px 0 0 0;color:#64748b;font-size:0.875rem;">
                ${modal.workers.length} worker${modal.workers.length > 1 ? 's' : ''} ‚Ä¢ Total: $${modal.total.toFixed(2)}
              </p>
            </div>
            
            <!-- ÏßÅÏõê Î¶¨Ïä§Ìä∏ -->
            <div style="flex:1;overflow-y:auto;padding:20px;">
              ${modal.workers.map((worker, i) => `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;margin-bottom:8px;background:#f8fafc;border-radius:8px;border-left:4px solid ${shiftColor};">
                  <div style="display:flex;align-items:center;gap:12px;">
                    <span style="font-weight:700;color:#64748b;font-size:0.875rem;min-width:30px;">#${i + 1}</span>
                    <span style="font-weight:600;color:#2c3e50;font-size:1rem;">${worker.name}</span>
                  </div>
                  <span style="font-weight:700;color:${modal.shift === 'lunch' ? '#92400e' : '#1e40af'};font-size:1.1rem;">
                    $${worker.amount.toFixed(2)}
                  </span>
                </div>
              `).join('')}
            </div>
            
            <!-- Ï¥ùÏï° -->
            <div style="padding:20px;border-top:2px solid #e2e8f0;background:#f8fafc;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <span style="font-size:1.25rem;font-weight:700;color:#2c3e50;">Grand Total</span>
                <span style="font-size:1.75rem;font-weight:700;color:#7f1d1d;">$${modal.total.toFixed(2)}</span>
              </div>
              
              <!-- Î≤ÑÌäº -->
              <div style="display:flex;gap:12px;">
                <button onclick="state.confirmModal.onCancel()" 
                        style="flex:1;padding:14px;background:white;color:#64748b;border:2px solid #e2e8f0;border-radius:8px;cursor:pointer;font-weight:700;font-size:1rem;">
                  Cancel
                </button>
                <button onclick="state.confirmModal.onConfirm()" 
                        style="flex:1;padding:14px;background:#22c55e;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:1rem;box-shadow:0 4px 12px rgba(34,197,94,0.3);">
                  ‚úì Confirm
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ============================================
    // MODAL - ÏßÅÏõê Ï∂îÍ∞Ä/ÏàòÏ†ï ÌåùÏóÖ
    // ÏàòÏ†ï: Î™®Îã¨ ÎîîÏûêÏù∏ Î≥ÄÍ≤ΩÌïòÎ†§Î©¥ Ïù¥ Ìï®Ïàò!
    // ============================================
    function renderModal(t) {
      const currentStatus = state.editingEmployee?.status || 'active';
      const cantWorkDetails = state.editingEmployee?.cantWorkDetails || {};
      
      return `
        <div class="modal show" onclick="if(event.target === this) closeModal()">
          <div class="modal-content">
            <h3 style="margin-top:0;">${state.editingEmployee ? 'Edit Employee' : t.employees.addEmployee}</h3>
            <form id="employee-form">
              <div class="form-group">
                <label>${t.employees.name} *</label>
                <input type="text" id="emp-name" required value="${state.editingEmployee?.name || ''}" autocomplete="off">
              </div>
              
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
                <div class="form-group" style="margin-bottom:0;">
                  <label>${t.employees.gender}</label>
                  <select id="emp-gender">
                    <option value="male" ${state.editingEmployee?.gender === 'male' ? 'selected' : ''}>${t.employees.male}</option>
                    <option value="female" ${state.editingEmployee?.gender === 'female' ? 'selected' : ''}>${t.employees.female}</option>
                  </select>
                </div>

                <div class="form-group" style="margin-bottom:0;">
                  <label>${t.employees.status}</label>
                  <select id="emp-status">
                    <option value="active" ${currentStatus === 'active' ? 'selected' : ''}>${t.employees.active}</option>
                    <option value="cantWork" ${currentStatus === 'cantWork' ? 'selected' : ''}>${t.employees.cantWork}</option>
                  </select>
                </div>
              </div>

              <div id="cant-work-details" style="display:${currentStatus === 'cantWork' ? 'block' : 'none'};padding:16px;background:#FFF3E0;border-radius:8px;margin-bottom:16px;">
                <h4 style="margin:0 0 12px 0;font-size:14px;font-weight:600;">${t.employees.cantWorkDetails}</h4>
                
                <div class="form-group" style="margin-bottom:12px;">
                  <label>${t.employees.reason}</label>
                  <select id="cant-work-reason">
                    <option value="Vacation" ${cantWorkDetails.reason === 'Vacation' ? 'selected' : ''}>Vacation</option>
                    <option value="Sick" ${cantWorkDetails.reason === 'Sick' ? 'selected' : ''}>Sick</option>
                    <option value="Out of Town" ${cantWorkDetails.reason === 'Out of Town' ? 'selected' : ''}>Out of Town</option>
                    <option value="Other" ${cantWorkDetails.reason === 'Other' ? 'selected' : ''}>Other</option>
                  </select>
                </div>

                <div class="form-group" style="margin-bottom:12px;">
                  <label>${t.employees.startDate}</label>
                  <input type="date" id="cant-work-start" value="${cantWorkDetails.startDate || ''}">
                </div>

                <div class="form-group" style="margin-bottom:0;">
                  <label>${t.employees.endDate}</label>
                  <input type="date" id="cant-work-end" value="${cantWorkDetails.endDate || ''}">
                </div>
              </div>

              <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:24px;">
                <button type="button" class="btn-secondary" onclick="closeModal()">
                  ${t.employees.cancel}
                </button>
                <button type="submit" class="btn-primary">
                  ${t.employees.save}
                </button>
              </div>
            </form>
          </div>
        </div>
      `;
    }

    // ============================================
    // EVENT LISTENERS - Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨
    // ============================================
    function attachEventListeners() {
      // --- Ïñ∏Ïñ¥ ÏÑ†ÌÉù ---
      const langSelector = document.getElementById('language-selector');
      if (langSelector) {
        langSelector.addEventListener('change', (e) => {
          state.language = e.target.value;
          render();
        });
      }

      // --- ÌÉ≠ Ï†ÑÌôò ---
      document.querySelectorAll('[data-tab]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          state.activeTab = e.target.dataset.tab;
          render();
        });
      });

      // --- ÏßÅÏõê Ï∂îÍ∞Ä Î≤ÑÌäº ---
      const addBtn = document.getElementById('add-employee-btn');
      if (addBtn) {
        addBtn.addEventListener('click', () => {
          state.editingEmployee = null;
          state.showModal = true;
          render();
        });
      }

      // --- Status Î≥ÄÍ≤Ω Ïãú Can't Work ÌïÑÎìú ÌëúÏãú/Ïà®ÍπÄ ---
      const statusSelect = document.getElementById('emp-status');
      if (statusSelect) {
        statusSelect.addEventListener('change', (e) => {
          const cantWorkDetails = document.getElementById('cant-work-details');
          if (cantWorkDetails) {
            cantWorkDetails.style.display = e.target.value === 'cantWork' ? 'block' : 'none';
          }
        });
      }

      // --- ÏßÅÏõê Ìèº Ï†úÏ∂ú ---
      const form = document.getElementById('employee-form');
      if (form) {
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const status = document.getElementById('emp-status').value;
          const empData = {
            id: state.editingEmployee?.id || Date.now(),
            name: document.getElementById('emp-name').value.trim(),
            gender: document.getElementById('emp-gender').value,
            status: status,
            availableSections: {
              'A-F': true,
              'G+Room': true,
              'H-L': true,
              'Helper': false,
              'MH': false,
              'FR': false
            },
            conflictWith: []
          };

          if (status === 'cantWork') {
            empData.cantWorkDetails = {
              reason: document.getElementById('cant-work-reason').value,
              startDate: document.getElementById('cant-work-start').value,
              endDate: document.getElementById('cant-work-end').value
            };
          }

          if (state.editingEmployee) {
            state.employees = state.employees.map(e => 
              e.id === empData.id ? empData : e
            );
          } else {
            state.employees.push(empData);
          }

          await saveEmployees();
          state.showModal = false;
          render();
        });
      }

      // --- Preferences ÏßÅÏõê ÏÑ†ÌÉù ---
      const empSelector = document.getElementById('employee-selector');
      if (empSelector) {
        empSelector.addEventListener('change', (e) => {
          const empId = parseInt(e.target.value);
          state.selectedEmployee = state.employees.find(emp => emp.id === empId);
          render();
        });
      }
    }

    // ============================================
    // GLOBAL FUNCTIONS - onclickÏóêÏÑú Ìò∏Ï∂ú
    // ============================================
    
    // --- ÏßÅÏõê ÏàòÏ†ï ---
    window.editEmployee = (id) => {
      state.editingEmployee = state.employees.find(e => e.id === id);
      state.showModal = true;
      render();
    };

    // --- ÏßÅÏõê ÏÇ≠Ï†ú ---
    window.deleteEmployee = (id) => {
      if (confirm('Delete this employee?')) {
        state.employees = state.employees.filter(e => e.id !== id);
        saveEmployees();
        render();
      }
    };
    
    // ============================================
    // TIPS Í¥ÄÎ†® Ìï®Ïàò
    // ============================================
    
    // Tips ÏÑúÎ∏åÌÉ≠ Î≥ÄÍ≤Ω
    window.setTipsSubTab = (tab) => {
      state.tipsSubTab = tab;
      render();
    };
    
    // ÎÇ†Ïßú ÏÑ†ÌÉù
    window.selectTipDate = (dateStr) => {
      state.selectedTipDate = dateStr;
      
      // Í∏∞Ï°¥ ÌåÅ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏
      const existingTips = state.tipsData[dateStr];
      
      if (existingTips && (Object.keys(existingTips.lunch || {}).length > 0 || Object.keys(existingTips.dinner || {}).length > 0)) {
        // Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÏúºÎ©¥ ÏàòÏ†ï/Ï∂îÍ∞Ä Î™®Îìú
        state.tipEntryStep = 'edit-existing';
        state.lunchTips = {...existingTips.lunch || {}};
        state.dinnerTips = {...existingTips.dinner || {}};
      } else {
        // ÏÉàÎ°ú ÏûÖÎ†•
        state.tipEntryStep = 'worker-select';
        state.lunchTips = {};
        state.dinnerTips = {};
      }
      
      state.lunchWorkers = [];
      state.dinnerWorkers = [];
      render();
    };
    
    
    // Lunch ÌåÅ ÏûÖÎ†•
    window.setLunchTip = (empName, amount) => {
      state.lunchTips[empName] = parseFloat(amount) || 0;
    };
    
    // Dinner ÌåÅ ÏûÖÎ†•
    window.setDinnerTip = (empName, amount) => {
      state.dinnerTips[empName] = parseFloat(amount) || 0;
    };
    
    // Lunch ÌåÅ Ï†ÄÏû•
    window.saveLunchTips = async () => {
      const date = state.selectedTipDate;
      if (!state.tipsData[date]) {
        state.tipsData[date] = { lunch: {}, dinner: {} };
      }
      
      // $0 Ï†úÏô∏ÌïòÍ≥† Ï†ÄÏû•
      const filteredLunchTips = {};
      Object.keys(state.lunchTips).forEach(empName => {
        const amount = parseFloat(state.lunchTips[empName]) || 0;
        if (amount > 0) {
          filteredLunchTips[empName] = amount;
        }
      });
      
      state.tipsData[date].lunch = filteredLunchTips;
      
      await storage.saveData('tips', state.tipsData);
      await updateTipStats();
      
      state.tipEntryStep = 'dinner-entry';
      render();
    };
    
    // Dinner ÌåÅ Ï†ÄÏû•
    window.saveDinnerTips = async () => {
      const date = state.selectedTipDate;
      if (!state.tipsData[date]) {
        state.tipsData[date] = { lunch: {}, dinner: {} };
      }
      
      // $0 Ï†úÏô∏ÌïòÍ≥† Ï†ÄÏû•
      const filteredDinnerTips = {};
      Object.keys(state.dinnerTips).forEach(empName => {
        const amount = parseFloat(state.dinnerTips[empName]) || 0;
        if (amount > 0) {
          filteredDinnerTips[empName] = amount;
        }
      });
      
      state.tipsData[date].dinner = filteredDinnerTips;
      
      await storage.saveData('tips', state.tipsData);
      await updateTipStats();
      
      alert('Tips saved successfully!');
      state.tipEntryStep = 'select-date';
      state.selectedTipDate = null;
      render();
    };
    
    // ÌåÅ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
    async function updateTipStats() {
      const stats = {};
      
      // Î™®Îì† ÏßÅÏõê Ï¥àÍ∏∞Ìôî
      state.employees.forEach(emp => {
        stats[emp.name] = {
          pending: 0,
          paid: state.tipStats[emp.name]?.paid || 0,
          total: 0
        };
      });
      
      // Î™®Îì† ÎÇ†ÏßúÏùò ÌåÅ Ìï©ÏÇ∞
      Object.keys(state.tipsData).forEach(date => {
        const dayTips = state.tipsData[date];
        
        // Lunch
        Object.keys(dayTips.lunch || {}).forEach(empName => {
          if (!stats[empName]) stats[empName] = { pending: 0, paid: 0, total: 0 };
          stats[empName].pending += dayTips.lunch[empName];
        });
        
        // Dinner
        Object.keys(dayTips.dinner || {}).forEach(empName => {
          if (!stats[empName]) stats[empName] = { pending: 0, paid: 0, total: 0 };
          stats[empName].pending += dayTips.dinner[empName];
        });
      });
      
      // Total Í≥ÑÏÇ∞
      Object.keys(stats).forEach(empName => {
        stats[empName].total = stats[empName].pending + stats[empName].paid;
      });
      
      state.tipStats = stats;
      await storage.saveData('tipStats', stats);
    }
    
    // Ï†ïÏÇ∞ Í≥ÑÏÇ∞
    window.calculateSettlement = () => {
      const start = state.settlementStart;
      const end = state.settlementEnd;
      
      if (!start || !end) {
        alert('Please select start and end dates');
        return;
      }
      
      const summary = {
        startDate: start,
        endDate: end,
        employees: {}
      };
      
      // Í∏∞Í∞Ñ ÎÇ¥ ÌåÅ Ìï©ÏÇ∞
      Object.keys(state.tipsData).forEach(date => {
        if (date >= start && date <= end) {
          const dayTips = state.tipsData[date];
          
          // Lunch
          Object.keys(dayTips.lunch || {}).forEach(empName => {
            if (!summary.employees[empName]) {
              summary.employees[empName] = { 
                lunch: 0, 
                dinner: 0, 
                total: 0,
                lunchDays: [],
                dinnerDays: []
              };
            }
            summary.employees[empName].lunch += dayTips.lunch[empName];
            const day = new Date(date).getDate();
            summary.employees[empName].lunchDays.push(day);
          });
          
          // Dinner
          Object.keys(dayTips.dinner || {}).forEach(empName => {
            if (!summary.employees[empName]) {
              summary.employees[empName] = { 
                lunch: 0, 
                dinner: 0, 
                total: 0,
                lunchDays: [],
                dinnerDays: []
              };
            }
            summary.employees[empName].dinner += dayTips.dinner[empName];
            const day = new Date(date).getDate();
            summary.employees[empName].dinnerDays.push(day);
          });
        }
      });
      
      // Total Í≥ÑÏÇ∞
      Object.keys(summary.employees).forEach(empName => {
        summary.employees[empName].total = 
          summary.employees[empName].lunch + 
          summary.employees[empName].dinner;
      });
      
      state.settlementSummary = summary;
      render();
    };
    
    // Ï†ïÏÇ∞ ÌôïÏ†ï
    window.confirmSettlement = async () => {
      if (!confirm('Confirm this settlement?')) return;
      
      const summary = state.settlementSummary;
      const settlementRecord = {
        id: Date.now().toString(),
        ...summary,
        settledAt: new Date().toISOString(),
        grandTotal: 0
      };
      
      // Grand Total Í≥ÑÏÇ∞
      Object.keys(summary.employees).forEach(empName => {
        settlementRecord.grandTotal += summary.employees[empName].total;
        
        // PaidÏóê Ï∂îÍ∞Ä
        if (!state.tipStats[empName]) {
          state.tipStats[empName] = { pending: 0, paid: 0, total: 0 };
        }
        state.tipStats[empName].paid += summary.employees[empName].total;
      });
      
      // Ï†ïÏÇ∞ Í∏∞Î°ù Ï†ÄÏû•
      state.settlements.unshift(settlementRecord);
      await storage.saveData('settlements', state.settlements);
      
      // Ï†ïÏÇ∞Îêú ÌåÅ Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú
      Object.keys(state.tipsData).forEach(date => {
        if (date >= summary.startDate && date <= summary.endDate) {
          delete state.tipsData[date];
        }
      });
      await storage.saveData('tips', state.tipsData);
      
      // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
      await updateTipStats();
      
      alert('Settlement completed!');
      state.settlementSummary = null;
      state.settlementStart = '';
      state.settlementEnd = '';
      render();
    };
    
    // Ï†ïÏÇ∞ Ïù¥Î†• ÏÑ†ÌÉù
    window.selectSettlement = (id) => {
      state.selectedSettlement = state.settlements.find(s => s.id === id);
      render();
    };
    
    // Ï†ïÏÇ∞ Ïù¥Î†• Îã´Í∏∞
    window.closeSettlementDetail = () => {
      state.selectedSettlement = null;
      render();
    };

    // --- Í∞ÄÎä•Ìïú ÏßÅÏõê Î≥¥Í∏∞ (ÎèãÎ≥¥Í∏∞ Î≤ÑÌäº) ---
    window.showAvailable = (day, period) => {
      const daySchedule = state.schedule[day] || {};
      const activeEmployees = state.employees.filter(e => e.status === 'active');
      
      // Ïù¥ÎØ∏ Î∞∞Ï†ïÎêú ÏßÅÏõê ID
      const assignedIds = [
        ...(daySchedule.lunch || []).map(e => e.id),
        ...(daySchedule.dinner || []).map(e => e.id)
      ];
      
      // Î∞∞Ï†ï Ïïà Îêú ÏßÅÏõêÎì§
      const availableEmployees = activeEmployees.filter(emp => 
        !assignedIds.includes(emp.id)
      );
      
      // Preference Ï†ïÎ≥¥ Ìè¨Ìï®
      const employeesWithPrefs = availableEmployees.map(emp => {
        const prefs = state.preferences[emp.id]?.[day];
        let prefText = 'No preference';
        let prefColor = '#999';
        
        if (period === 'lunch' && prefs?.morning) {
          if (prefs.morning === 1) {
            prefText = 'üü° Prefers Open';
            prefColor = '#FFD93D';
          } else if (prefs.morning === 2) {
            prefText = 'üü¢ Prefers 11:00/11:30';
            prefColor = '#6BCB77';
          }
        } else if (period === 'dinner' && prefs?.evening) {
          if (prefs.evening === 1) {
            prefText = 'üîµ Prefers 3:30';
            prefColor = '#4D96FF';
          } else if (prefs.evening === 2) {
            prefText = 'üü£ Prefers 6:00';
            prefColor = '#9D4EDD';
          }
        }
        
        return { emp, prefText, prefColor };
      });
      
      // Î™®Îã¨ ÏÉùÏÑ±
      const t = TRANSLATIONS[state.language];
      const periodName = period === 'lunch' ? t.schedule.lunch : t.schedule.dinner;
      const dayName = t.days?.[day] || day;
      
      const modalHTML = `
        <div class="modal show" onclick="if(event.target === this) closeAvailableModal()">
          <div class="modal-content" style="max-width:600px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
              <h3 style="margin:0;">üîç Available for ${dayName} ${periodName}</h3>
              <button onclick="closeAvailableModal()" style="background:none;border:none;font-size:24px;cursor:pointer;color:#666;">√ó</button>
            </div>
            
            ${employeesWithPrefs.length === 0 ? `
              <div style="padding:40px;text-align:center;background:#f9f9f9;border-radius:12px;">
                <div style="font-size:48px;margin-bottom:16px;">‚úÖ</div>
                <p style="color:#666;font-size:16px;">All active employees are already assigned!</p>
              </div>
            ` : `
              <div style="max-height:400px;overflow-y:auto;">
                ${employeesWithPrefs.map(({ emp, prefText, prefColor }) => `
                  <div style="padding:12px;margin-bottom:8px;background:#f9f9f9;border-radius:8px;border-left:4px solid ${prefColor};">
                    <div style="font-weight:600;font-size:15px;margin-bottom:4px;">${emp.name}</div>
                    <div style="font-size:13px;color:#666;">${prefText}</div>
                  </div>
                `).join('')}
              </div>
              
              <div style="margin-top:20px;padding:12px;background:#E3F2FD;border-radius:8px;font-size:13px;">
                üí° <strong>Tip:</strong> These employees are not currently assigned to any shift on ${dayName}.
              </div>
            `}
          </div>
        </div>
      `;
      
      // Î™®Îã¨ ÌëúÏãú
      const existingModal = document.querySelector('.modal.show');
      if (existingModal) existingModal.remove();
      
      document.body.insertAdjacentHTML('beforeend', modalHTML);
    };
    
    // --- Excel Îã§Ïö¥Î°úÎìú ---
    // --- Excel Îã§Ïö¥Î°úÎìú (ExcelJS - ÏÉâÏÉÅ ÏôÑÎ≤Ω ÏßÄÏõê!) ---
                window.downloadExcel = async () => {
      if (typeof ExcelJS === 'undefined') {
        alert('‚ùå ExcelJS library not loaded!');
        return;
      }
      
      if (!state.schedule || Object.keys(state.schedule).length === 0) {
        alert('‚ö†Ô∏è No schedule yet!');
        return;
      }
    
      try {
        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet('Schedule');
    
        const employeeOrder = ['Aiden','Carlos','Edgar','Hung','Thanh','Tien','Tommy','Judy','Justin','Tina N','Alan','Chau','Le','Crystal','Tue','Cherry','Christine','Hieu','Kai','Dat','Johnny','Ly','Tho','Kha','Phung','Ye','Esther','Duc','Jimmy','Aca','Vivi','Catherine','Tiffany','Steven','Chris','Dung'];
        
        const orderedEmployees = [];
        employeeOrder.forEach(name => {
          const emp = state.employees.find(e => e.name === name && e.status === 'active');
          if (emp) orderedEmployees.push(emp);
        });
        state.employees.filter(e => e.status === 'active').forEach(emp => {
          if (!employeeOrder.includes(emp.name)) {
            orderedEmployees.push(emp);
          }
        });
    
        const columns = [{width:5},{width:15}];
        DAYS.forEach(() => columns.push({width:14}));
        worksheet.columns = columns;
    
        const totalCols = 2 + DAYS.length;
        const lastCol = String.fromCharCode(65 + totalCols - 1);
        
        // Îã§Ïùå Ï£º ÏõîÏöîÏùº Í≥ÑÏÇ∞
        const currentDate = new Date();
        const currentDay = currentDate.getDay(); // 0(Ïùº) ~ 6(ÌÜ†)
        const daysUntilNextMonday = currentDay === 0 ? 1 : (8 - currentDay); // Îã§Ïùå Ï£º ÏõîÏöîÏùºÍπåÏßÄ ÎÇ†Ïßú
        const nextMonday = new Date(currentDate);
        nextMonday.setDate(currentDate.getDate() + daysUntilNextMonday);
        
        // Ï†úÎ™© Ìñâ Ï†úÍ±∞ÌïòÍ≥† Î∞îÎ°ú ÎÇ†Ïßú Ìó§Îçî
        const dateHeaderRow = worksheet.getRow(1);
        dateHeaderRow.height = 20;
        
        // ÎÇ†Ïßú Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ (Îã§Ïùå Ï£º ÏõîÏöîÏùºÎ∂ÄÌÑ∞ 7Ïùº)
        const dates = DAYS.map((day, idx) => {
          const date = new Date(nextMonday);
          date.setDate(nextMonday.getDate() + idx);
          return `${date.getMonth() + 1}/${date.getDate()}`;
        });
        
        dateHeaderRow.values = ['','', ...dates];
        dateHeaderRow.eachCell((cell)=>{
          cell.fill = {type:'pattern',pattern:'solid',fgColor:{argb:'FF667eea'}};
          cell.font = {bold:true,color:{argb:'FFFFFFFF'},size:11};
          cell.alignment = {horizontal:'center',vertical:'middle'};
          cell.border = {top:{style:'thick'},left:{style:'thick'},bottom:{style:'thick'},right:{style:'thick'}};
        });
    
        const dayHeaderRow = worksheet.getRow(2);
        dayHeaderRow.height = 20;
        dayHeaderRow.values = ['','Name',...DAYS];
        dayHeaderRow.eachCell((cell)=>{
          cell.fill = {type:'pattern',pattern:'solid',fgColor:{argb:'FF667eea'}};
          cell.font = {bold:true,color:{argb:'FFFFFFFF'},size:11};
          cell.alignment = {horizontal:'center',vertical:'middle'};
          cell.border = {top:{style:'thick'},left:{style:'thick'},bottom:{style:'thick'},right:{style:'thick'}};
        });
    
        const shortDayRow = worksheet.getRow(3);
        shortDayRow.height = 18;
        shortDayRow.values = ['','', ...DAYS.map(d=>d.substring(0,3))];
        shortDayRow.eachCell((cell)=>{
          cell.fill = {type:'pattern',pattern:'solid',fgColor:{argb:'FF9D4EDD'}};
          cell.font = {bold:true,color:{argb:'FFFFFFFF'},size:10};
          cell.alignment = {horizontal:'center',vertical:'middle'};
          cell.border = {top:{style:'thick'},left:{style:'thick'},bottom:{style:'thick'},right:{style:'thick'}};
        });
    
        let currentRow = 4;
        orderedEmployees.forEach((emp,idx)=>{
          // ÏßùÏàò/ÌôÄÏàòÎ°ú Î∞∞Í≤ΩÏÉâ Î≥ÄÍ≤Ω
          const isEven = idx % 2 === 0;
          const groupBgColor = isEven ? 'FFFFFFFF' : 'FFE0E0E0'; // Ìù∞ÏÉâ / Ïó∞Ìïú ÌöåÏÉâ
    
          // Lunch Row
          const lunchRow = worksheet.getRow(currentRow);
          lunchRow.height = 18;
          
          // Î®ºÏ†Ä Î≥ëÌï©
          worksheet.mergeCells('A'+currentRow+':A'+(currentRow+1));
          worksheet.mergeCells('B'+currentRow+':B'+(currentRow+1));
          
          // Î≥ëÌï© ÌõÑ Ï†àÎåÄ Ï¢åÌëúÎ°ú Í∞í ÏÑ§Ï†ï
          worksheet.getCell('A'+currentRow).value = idx+1;
          worksheet.getCell('B'+currentRow).value = emp.name;
          
          // Lunch shift Í∞í ÏÑ§Ï†ï
          DAYS.forEach((day, i)=>{
            const daySchedule = state.schedule[day]||{};
            const lunchShift = (daySchedule.lunch||[]).find(e=>e.id===emp.id);
            lunchRow.getCell(3+i).value = lunchShift ? lunchShift.shift : '';
          });
    
          // Î≤àÌò∏ ÏÖÄ Ïä§ÌÉÄÏùº
          const numCell = worksheet.getCell('A'+currentRow);
          numCell.fill = {type:'pattern',pattern:'solid',fgColor:{argb:'FFF0F0F0'}};
          numCell.font = {bold:true,size:10};
          numCell.alignment = {horizontal:'center',vertical:'middle'};
          numCell.border = {
            top:{style:'thick'},
            left:{style:'thick'},
            bottom:{style:'thick'},
            right:{style:'medium'}
          };
    
          // Ïù¥Î¶Ñ ÏÖÄ Ïä§ÌÉÄÏùº
          const nameCell = worksheet.getCell('B'+currentRow);
          nameCell.fill = {type:'pattern',pattern:'solid',fgColor:{argb:'FFF9F9F9'}};
          nameCell.font = {bold:true,size:14};
          nameCell.alignment = {horizontal:'center',vertical:'middle'};
          nameCell.border = {
            top:{style:'thick'},
            left:{style:'medium'},
            bottom:{style:'thick'},
            right:{style:'medium'}
          };
    
          // Lunch ÏÖÄ Ïä§ÌÉÄÏùº
          for(let i=0; i<DAYS.length; i++){
            const day = DAYS[i];
            const daySchedule = state.schedule[day]||{};
            const lunchShift = (daySchedule.lunch||[]).find(e=>e.id===emp.id);
            const dinnerShift = (daySchedule.dinner||[]).find(e=>e.id===emp.id);
            const cell = lunchRow.getCell(3+i);
            
            if(lunchShift){
              let shiftText = lunchShift.shift;
              
              // LunchÍ∞Ä "11:00~Break" ÎòêÎäî "11:30~Break"Ïù¥Í≥†
              // DinnerÍ∞Ä "3:30~Close"Ïù∏ Í≤ΩÏö∞ ‚Üí Îπ®Í∞ÑÏÉâ Ï≤òÎ¶¨
              const isLunchBreak = /^(11:00|11:30)~Break$/i.test(shiftText.trim());
              const isDinnerClose = dinnerShift && /^3:30~Close$/i.test(dinnerShift.shift.trim());
              
              if (isLunchBreak && isDinnerClose) {
                // Îπ®Í∞ÑÏÉâ + "~Break" Ï†úÍ±∞
                const timeOnly = shiftText.replace(/~Break$/i, '').trim();
                cell.fill = {type:'pattern',pattern:'solid',fgColor:{argb:'FFFF0000'}};  // Îπ®Í∞ÑÏÉâ
                cell.font = {bold:true,size:9,color:{argb:'FFFFFFFF'}};  // Ìù∞ÏÉâ Í∏ÄÏî®
                cell.value = timeOnly;
              } else {
                // ÌÖçÏä§Ìä∏ Ï†úÍ±∞: Open~Break, 6~Close, 6:00~Close
                let displayText = shiftText;
                if (/^Open~Break$/i.test(shiftText.trim())) {
                  displayText = '';  // Open~Break Ï†úÍ±∞
                } else if (/^6:00~Close$/i.test(shiftText.trim())) {
                  displayText = '';  // 6:00~Close Ï†úÍ±∞
                } else if (/^6~Close$/i.test(shiftText.trim())) {
                  displayText = '';  // 6~Close Ï†úÍ±∞
                }
                
                // ÏùºÎ∞ò shift
                cell.fill = {type:'pattern',pattern:'solid',fgColor:{argb:getShiftColorARGB(shiftText)}};
                cell.font = {bold:true,size:9};
                cell.value = displayText;
              }
            } else {
              // Îπà ÏÖÄÎèÑ Í∑∏Î£π Î∞∞Í≤ΩÏÉâ
              cell.fill = {type:'pattern',pattern:'solid',fgColor:{argb:groupBgColor}};
            }
            
            cell.alignment = {horizontal:'center',vertical:'middle'};
            // ÏúÑÏ™ΩÎßå ÎëêÍªçÍ≤å, ÎÇòÎ®∏ÏßÄ ÏñáÍ≤å
            cell.border = {
              top:{style:'thick'},
              left:{style:'thin'},
              bottom:{style:'hair'},  // Îß§Ïö∞ ÏñáÏùÄ ÏÑ†
              right: i === DAYS.length-1 ? {style:'thick'} : {style:'thin'}
            };
          }
    
          currentRow++;
    
          // Dinner Row
          const dinnerRow = worksheet.getRow(currentRow);
          dinnerRow.height = 18;
          
          // Î≤àÌò∏/Ïù¥Î¶ÑÏùÄ Ïù¥ÎØ∏ Î≥ëÌï©ÎêòÏñ¥ ÏûàÏúºÎØÄÎ°ú Í±¥ÎìúÎ¶¨ÏßÄ ÏïäÏùå!
          
          // Dinner shift Í∞í ÏÑ§Ï†ï
          DAYS.forEach((day, i)=>{
            const daySchedule = state.schedule[day]||{};
            const dinnerShift = (daySchedule.dinner||[]).find(e=>e.id===emp.id);
            dinnerRow.getCell(3+i).value = dinnerShift ? dinnerShift.shift : '';
          });
    
          // Dinner ÏÖÄ Ïä§ÌÉÄÏùº
          for(let i=0; i<DAYS.length; i++){
            const day = DAYS[i];
            const daySchedule = state.schedule[day]||{};
            const lunchShift = (daySchedule.lunch||[]).find(e=>e.id===emp.id);
            const dinnerShift = (daySchedule.dinner||[]).find(e=>e.id===emp.id);
            const cell = dinnerRow.getCell(3+i);
            
            if(dinnerShift){
              let shiftText = dinnerShift.shift;
              
              // LunchÍ∞Ä "11:00~Break" ÎòêÎäî "11:30~Break"Ïù¥Í≥†
              // DinnerÍ∞Ä "3:30~Close"Ïù∏ Í≤ΩÏö∞ ‚Üí ÎπàÏπ∏ Ï≤òÎ¶¨
              const isLunchBreak = lunchShift && /^(11:00|11:30)~Break$/i.test(lunchShift.shift.trim());
              const isDinnerClose = /^3:30~Close$/i.test(shiftText.trim());
              
              if (isLunchBreak && isDinnerClose) {
                // ÎπàÏπ∏ÏúºÎ°ú (ÏïÑÎ¨¥Í≤ÉÎèÑ ÌëúÏãú Ïïà Ìï®)
                cell.fill = {type:'pattern',pattern:'solid',fgColor:{argb:groupBgColor}};
                cell.value = '';
              } else {
                // ÌÖçÏä§Ìä∏ Ï†úÍ±∞: 3:30~Close, 6~Close, 6:00~Close
                let displayText = shiftText;
                if (/^3:30~Close$/i.test(shiftText.trim())) {
                  displayText = '';  // 3:30~Close Ï†úÍ±∞
                } else if (/^6:00~Close$/i.test(shiftText.trim())) {
                  displayText = '';  // 6:00~Close Ï†úÍ±∞
                } else if (/^6~Close$/i.test(shiftText.trim())) {
                  displayText = '';  // 6~Close Ï†úÍ±∞
                }
                
                // ÏùºÎ∞ò shift
                cell.fill = {type:'pattern',pattern:'solid',fgColor:{argb:getShiftColorARGB(shiftText)}};
                cell.font = {bold:true,size:9};
                cell.value = displayText;
              }
            } else {
              cell.fill = {type:'pattern',pattern:'solid',fgColor:{argb:groupBgColor}};
            }
            
            cell.alignment = {horizontal:'center',vertical:'middle'};
            // ÏïÑÎûòÏ™ΩÎßå ÎëêÍªçÍ≤å, ÎÇòÎ®∏ÏßÄ ÏñáÍ≤å
            cell.border = {
              top:{style:'hair'},
              left:{style:'thin'},
              bottom:{style:'thick'},
              right: i === DAYS.length-1 ? {style:'thick'} : {style:'thin'}
            };
          }
    
          currentRow++;
        });
    
        currentRow++;
    
        // Lunch Count
        const lunchCountRow = worksheet.getRow(currentRow);
        lunchCountRow.height = 22;
        lunchCountRow.getCell(2).value = 'Lunch Count:';
        worksheet.mergeCells('A'+currentRow+':B'+currentRow);
        lunchCountRow.getCell(1).fill = {type:'pattern',pattern:'solid',fgColor:{argb:'FFE8F5E9'}};
        lunchCountRow.getCell(1).font = {bold:true,size:11};
        lunchCountRow.getCell(1).alignment = {horizontal:'right',vertical:'middle'};
        lunchCountRow.getCell(1).border = {top:{style:'thick'},left:{style:'thick'},bottom:{style:'thick'},right:{style:'thick'}};
        
        for(let i=0; i<DAYS.length; i++){
          const day = DAYS[i];
          const daySchedule = state.schedule[day]||{};
          const cell = lunchCountRow.getCell(3+i);
          cell.value = (daySchedule.lunch||[]).length;
          cell.fill = {type:'pattern',pattern:'solid',fgColor:{argb:'FFE8F5E9'}};
          cell.font = {bold:true,size:11,color:{argb:'FF2E7D32'}};
          cell.alignment = {horizontal:'center',vertical:'middle'};
          cell.border = {top:{style:'thick'},left:{style:'thick'},bottom:{style:'thick'},right:{style:'thick'}};
        }
    
        currentRow++;
    
        // Dinner Count
        const dinnerCountRow = worksheet.getRow(currentRow);
        dinnerCountRow.height = 22;
        dinnerCountRow.getCell(2).value = 'Dinner Count:';
        worksheet.mergeCells('A'+currentRow+':B'+currentRow);
        dinnerCountRow.getCell(1).fill = {type:'pattern',pattern:'solid',fgColor:{argb:'FFE3F2FD'}};
        dinnerCountRow.getCell(1).font = {bold:true,size:11};
        dinnerCountRow.getCell(1).alignment = {horizontal:'right',vertical:'middle'};
        dinnerCountRow.getCell(1).border = {top:{style:'thick'},left:{style:'thick'},bottom:{style:'thick'},right:{style:'thick'}};
        
        for(let i=0; i<DAYS.length; i++){
          const day = DAYS[i];
          const daySchedule = state.schedule[day]||{};
          const cell = dinnerCountRow.getCell(3+i);
          cell.value = (daySchedule.dinner||[]).length;
          cell.fill = {type:'pattern',pattern:'solid',fgColor:{argb:'FFE3F2FD'}};
          cell.font = {bold:true,size:11,color:{argb:'FF1565C0'}};
          cell.alignment = {horizontal:'center',vertical:'middle'};
          cell.border = {top:{style:'thick'},left:{style:'thick'},bottom:{style:'thick'},right:{style:'thick'}};
        }
    
        currentRow++;
    
        // All Day Count
        const allDayCountRow = worksheet.getRow(currentRow);
        allDayCountRow.height = 22;
        allDayCountRow.getCell(2).value = 'All Day Count:';
        worksheet.mergeCells('A'+currentRow+':B'+currentRow);
        allDayCountRow.getCell(1).fill = {type:'pattern',pattern:'solid',fgColor:{argb:'FFFFF3E0'}};
        allDayCountRow.getCell(1).font = {bold:true,size:11};
        allDayCountRow.getCell(1).alignment = {horizontal:'right',vertical:'middle'};
        allDayCountRow.getCell(1).border = {top:{style:'thick'},left:{style:'thick'},bottom:{style:'thick'},right:{style:'thick'}};
        
        for(let i=0; i<DAYS.length; i++){
          const day = DAYS[i];
          const daySchedule = state.schedule[day]||{};
          const lunchNames = (daySchedule.lunch||[]).map(e=>e.name);
          const dinnerNames = (daySchedule.dinner||[]).map(e=>e.name);
          const allDayCount = lunchNames.filter(name=>dinnerNames.includes(name)).length;
          const cell = allDayCountRow.getCell(3+i);
          cell.value = allDayCount;
          cell.fill = {type:'pattern',pattern:'solid',fgColor:{argb:'FFFFF3E0'}};
          cell.font = {bold:true,size:11,color:{argb:'FFF57C00'}};
          cell.alignment = {horizontal:'center',vertical:'middle'};
          cell.border = {top:{style:'thick'},left:{style:'thick'},bottom:{style:'thick'},right:{style:'thick'}};
        }
    
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
        const today = new Date().toISOString().split('T')[0];
        saveAs(blob,'Shabu_Zone_Schedule_'+today+'.xlsx');
        alert('‚úÖ Excel downloaded with colors!');
        
      } catch (error) {
        console.error('Excel download error:', error);
        alert('‚ùå Error downloading Excel: ' + error.message);
      }
    };
    


    


    





    // --- ÏãúÌîÑÌä∏ Ìé∏Ïßë (Excel View) ---
    window.editShift = (empId, day, period) => {
      const emp = state.employees.find(e => e.id === parseInt(empId));
      if (!emp) return;

      const daySchedule = state.schedule[day] || { lunch: [], dinner: [] };
      const currentShift = period === 'lunch' 
        ? daySchedule.lunch.find(e => e.id === emp.id)
        : daySchedule.dinner.find(e => e.id === emp.id);

      const t = TRANSLATIONS[state.language];
      const dayName = t.days?.[day] || day;
      const periodName = period === 'lunch' ? 'Lunch' : 'Dinner';

      // Í∞ÄÎä•Ìïú ÏãúÌîÑÌä∏ ÏòµÏÖò
      const shiftOptions = period === 'lunch' 
        ? ['Open~Break', '11:00~Break', '11:30~Break']
        : ['3:30~Close', '6:00~Close'];

      const modalHTML = `
        <div class="modal show" onclick="if(event.target === this) closeShiftModal()">
          <div class="modal-content" style="max-width:500px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
              <h3 style="margin:0;">${dayName} ${periodName} - ${emp.name}</h3>
              <button onclick="closeShiftModal()" style="background:none;border:none;font-size:24px;cursor:pointer;color:#666;">√ó</button>
            </div>

            ${currentShift ? `
              <div style="padding:12px;background:#E3F2FD;border-radius:8px;margin-bottom:20px;">
                <strong>Current:</strong> 
                <span style="padding:4px 12px;background:${getShiftColor(currentShift.shift)};border-radius:6px;display:inline-block;margin-left:8px;">
                  ${currentShift.shift}
                </span>
              </div>
            ` : `
              <div style="padding:12px;background:#FFF3E0;border-radius:8px;margin-bottom:20px;">
                <strong>Currently:</strong> OFF
              </div>
            `}

            <div style="margin-bottom:20px;">
              <h4 style="margin:0 0 12px 0;">Change to:</h4>
              ${shiftOptions.map(shift => `
                <button onclick="changeShift(${empId}, '${day}', '${period}', '${shift}')" 
                        style="display:block;width:100%;padding:12px;margin-bottom:8px;
                               background:${getShiftColor(shift)};border:2px solid #333;
                               border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;
                               ${currentShift?.shift === shift ? 'opacity:0.5;' : ''}">
                  ${shift}
                </button>
              `).join('')}
              <button onclick="changeShift(${empId}, '${day}', '${period}', '')" 
                      style="display:block;width:100%;padding:12px;background:white;
                             border:2px solid #ddd;border-radius:8px;cursor:pointer;
                             font-weight:600;color:#666;">
                OFF (Remove shift)
              </button>
            </div>

            <button onclick="showSwapOptions(${empId}, '${day}', '${period}')" 
                    class="btn-secondary" style="width:100%;padding:14px;font-size:15px;">
              üîÑ Switch Employee
            </button>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHTML);
    };

    // --- ÏãúÌîÑÌä∏ Î≥ÄÍ≤Ω ---
    window.changeShift = async (empId, day, period, newShift) => {
      const emp = state.employees.find(e => e.id === parseInt(empId));
      if (!emp) return;

      if (!state.schedule[day]) {
        state.schedule[day] = { lunch: [], dinner: [] };
      }

      const shifts = state.schedule[day][period];
      const existingIndex = shifts.findIndex(e => e.id === emp.id);

      if (newShift === '') {
        // Remove shift
        if (existingIndex !== -1) {
          shifts.splice(existingIndex, 1);
        }
      } else {
        // Add or update shift
        const shiftData = {
          name: emp.name,
          shift: newShift,
          id: emp.id,
          isFixed: false
        };

        if (existingIndex !== -1) {
          shifts[existingIndex] = shiftData;
        } else {
          shifts.push(shiftData);
        }
      }

      await saveSchedule();
      closeShiftModal();
      render();
    };

    // --- Switch ÏòµÏÖò ÌëúÏãú ---
    window.showSwapOptions = (empId, day, period) => {
      const emp = state.employees.find(e => e.id === parseInt(empId));
      if (!emp) return;

      const daySchedule = state.schedule[day] || { lunch: [], dinner: [] };
      const assignedIds = [...daySchedule.lunch.map(e => e.id), ...daySchedule.dinner.map(e => e.id)];

      const availableEmployees = state.employees
        .filter(e => e.status === 'active' && !assignedIds.includes(e.id))
        .map(e => {
          const prefs = state.preferences[e.id]?.[day];
          let prefText = 'No preference';
          let prefColor = '#999';

          if (period === 'lunch' && prefs?.morning) {
            if (prefs.morning === 1) {
              prefText = 'üü° Prefers Open';
              prefColor = '#FFD93D';
            } else if (prefs.morning === 2) {
              prefText = 'üü¢ Prefers 11:00/11:30';
              prefColor = '#6BCB77';
            }
          } else if (period === 'dinner' && prefs?.evening) {
            if (prefs.evening === 1) {
              prefText = 'üîµ Prefers 3:30';
              prefColor = '#4D96FF';
            } else if (prefs.evening === 2) {
              prefText = 'üü£ Prefers 6:00';
              prefColor = '#9D4EDD';
            }
          }

          return { emp: e, prefText, prefColor };
        });

      const t = TRANSLATIONS[state.language];
      const dayName = t.days?.[day] || day;
      const periodName = period === 'lunch' ? 'Lunch' : 'Dinner';

      const currentShift = period === 'lunch'
        ? daySchedule.lunch.find(e => e.id === emp.id)
        : daySchedule.dinner.find(e => e.id === emp.id);

      const swapHTML = `
        <div class="modal show" onclick="if(event.target === this) closeShiftModal()">
          <div class="modal-content" style="max-width:600px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
              <h3 style="margin:0;">Switch ${emp.name} - ${dayName} ${periodName}</h3>
              <button onclick="closeShiftModal()" style="background:none;border:none;font-size:24px;cursor:pointer;color:#666;">√ó</button>
            </div>

            ${availableEmployees.length === 0 ? `
              <div style="padding:40px;text-align:center;background:#f9f9f9;border-radius:12px;">
                <p style="color:#666;">No available employees for swap</p>
                <button onclick="editShift(${empId}, '${day}', '${period}')" class="btn-secondary" style="margin-top:16px;">
                  ‚Üê Back
                </button>
              </div>
            ` : `
              <p style="margin-bottom:16px;color:#666;">Click an employee to swap:</p>
              <div style="max-height:400px;overflow-y:auto;">
                ${availableEmployees.map(({ emp: availEmp, prefText, prefColor }) => `
                  <div onclick="swapEmployee(${empId}, ${availEmp.id}, '${day}', '${period}', '${currentShift?.shift || ''}')" 
                       style="padding:14px;margin-bottom:8px;background:#f9f9f9;border-radius:8px;
                              border-left:4px solid ${prefColor};cursor:pointer;
                              transition:background 0.2s;"
                       onmouseover="this.style.background='#e3f2fd'"
                       onmouseout="this.style.background='#f9f9f9'">
                    <div style="font-weight:600;font-size:15px;margin-bottom:4px;">${availEmp.name}</div>
                    <div style="font-size:13px;color:#666;">${prefText}</div>
                  </div>
                `).join('')}
              </div>
              <button onclick="editShift(${empId}, '${day}', '${period}')" class="btn-secondary" style="width:100%;margin-top:16px;">
                ‚Üê Back
              </button>
            `}
          </div>
        </div>
      `;

      const existingModal = document.querySelector('.modal.show');
      if (existingModal) existingModal.remove();
      document.body.insertAdjacentHTML('beforeend', swapHTML);
    };

    // --- ÏßÅÏõê ÍµêÏ≤¥ ---
    window.swapEmployee = async (removeEmpId, addEmpId, day, period, currentShift) => {
      const removeEmp = state.employees.find(e => e.id === parseInt(removeEmpId));
      const addEmp = state.employees.find(e => e.id === parseInt(addEmpId));
      if (!removeEmp || !addEmp) return;

      if (!state.schedule[day]) {
        state.schedule[day] = { lunch: [], dinner: [] };
      }

      const shifts = state.schedule[day][period];

      // Remove old employee
      const removeIndex = shifts.findIndex(e => e.id === removeEmp.id);
      if (removeIndex !== -1) {
        shifts.splice(removeIndex, 1);
      }

      // Add new employee (keep same shift if exists, otherwise use preference)
      let newShift = currentShift;
      if (!newShift) {
        // Use first available shift option
        newShift = period === 'lunch' ? 'Open~Break' : '3:30~Close';
      }

      shifts.push({
        name: addEmp.name,
        shift: newShift,
        id: addEmp.id,
        isFixed: false
      });

      await saveSchedule();
      closeShiftModal();
      render();
    };

    // --- ÏãúÌîÑÌä∏ Î™®Îã¨ Îã´Í∏∞ ---
    window.closeShiftModal = () => {
      const modal = document.querySelector('.modal.show');
      if (modal) modal.remove();
    };

    // --- Í∞ÄÎä•Ìïú ÏßÅÏõê Î™®Îã¨ Îã´Í∏∞ ---
    window.closeAvailableModal = () => {
      const modal = document.querySelector('.modal.show');
      if (modal) modal.remove();
    };

    // --- Î™®Îã¨ Îã´Í∏∞ ---
    window.closeModal = () => {
      state.showModal = false;
      render();
    };

    // --- Requirements ÏóÖÎç∞Ïù¥Ìä∏ ---
    window.updateRequirement = (day, period, shift, value) => {
      state.requirements[day][period][shift] = parseInt(value) || 0;
      saveRequirements();
      render();
    };

    // --- All Day Max ÏóÖÎç∞Ïù¥Ìä∏ ---
    window.updateAllDayMax = (day, value) => {
      state.requirements[day].allDayMax = parseInt(value) || 0;
      saveRequirements();
      render();
    };

    // --- Holiday ÌÜ†Í∏Ä ---
    window.toggleHoliday = (day) => {
      state.requirements[day].isHoliday = !state.requirements[day].isHoliday;
      saveRequirements();
      render();
    };

    // --- Preference ÏàúÌôò (0 ‚Üí 1 ‚Üí 2 ‚Üí 0) ---
    window.cyclePreference = (day, period) => {
      if (!state.selectedEmployee) return;
      
      const empId = state.selectedEmployee.id;
      if (!state.preferences[empId]) {
        state.preferences[empId] = {};
      }
      if (!state.preferences[empId][day]) {
        state.preferences[empId][day] = { morning: 0, evening: 0, morningFixed: false, eveningFixed: false };
      }
      
      const current = state.preferences[empId][day][period] || 0;
      const newValue = (current + 1) % 3;
      state.preferences[empId][day][period] = newValue;
      
      // ÏÉâÍπîÏù¥ ÎπàÏπ∏(0)ÏúºÎ°ú ÎèåÏïÑÍ∞ÄÎ©¥ FixedÎèÑ ÏûêÎèôÏúºÎ°ú Ìï¥Ï†ú
      if (newValue === 0) {
        state.preferences[empId][day][period + 'Fixed'] = false;
      }
      
      render();
    };

    // --- Fixed ÌÜ†Í∏Ä ---
    window.toggleFixed = (day, period) => {
      if (!state.selectedEmployee) return;
      
      const empId = state.selectedEmployee.id;
      if (!state.preferences[empId]) {
        state.preferences[empId] = {};
      }
      if (!state.preferences[empId][day]) {
        state.preferences[empId][day] = { morning: 0, evening: 0, morningFixed: false, eveningFixed: false };
      }
      
      const fixedKey = period + 'Fixed';
      state.preferences[empId][day][fixedKey] = !state.preferences[empId][day][fixedKey];
      
      render();
    };

    // --- Preferences Ï†ÄÏû• ---
    window.saveCurrentPreferences = async () => {
      if (!state.selectedEmployee) return;
      
      const empId = state.selectedEmployee.id;
      const minGuarantee = parseInt(document.getElementById('min-guarantee').value) || 0;
      
      state.preferences[empId] = {
        ...state.preferences[empId],
        minGuarantee,
        savedAt: new Date().toISOString()
      };
      
      await savePreferences();
      alert('‚úÖ Saved!');
      render();
    };

    // ============================================
    // SCHEDULE GENERATION - Ïä§ÏºÄÏ§Ñ ÏÉùÏÑ± ÏïåÍ≥†Î¶¨Ï¶ò
    // ÏàòÏ†ï: Ïä§ÏºÄÏ§Ñ Î°úÏßÅ Î≥ÄÍ≤ΩÌïòÎ†§Î©¥ Ïù¥ Ìï®Ïàò!
    // ============================================
    window.runScheduleGeneration = async () => {
      state.generating = true;
      render();

      await new Promise(resolve => setTimeout(resolve, 500));

      const newSchedule = {};
      const activeEmployees = state.employees.filter(e => e.status === 'active');

      // HolidayÏù∏ ÎÇ†Îì§ Ï∞æÍ∏∞
      const holidayDays = DAYS.filter(day => state.requirements[day].isHoliday);

      // ÏßÅÏõêÎ≥Ñ ÏãúÌîÑÌä∏ Ïπ¥Ïö¥Ìä∏ Ï∂îÏ†Å
      const employeeShiftCount = {};
      activeEmployees.forEach(emp => {
        employeeShiftCount[emp.id] = 0;
      });

      // ========================================
      // Î∞∞Ï†ï Ìó¨Ìçº Ìï®Ïàò
      // ========================================
      
      // ÎûúÎç§ ÏÑûÍ∏∞
      const shuffle = (array) => {
        const arr = [...array];
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
      };

      // Shift ÏûêÎèô ÏÑ†ÌÉù (Ïú†ÎèôÏÑ±)
      const getFlexibleShift = (prefValue, period, needs) => {
        if (period === 'morning') {
          // üü° ÎÖ∏ÎûÄÏÉâ (Open ÏÑ†Ìò∏)
          if (prefValue === 1) {
            if (needs.open > 0) return { shift: 'Open~Break', type: 'open' };
            if (needs.eleven > 0) return { shift: '11:00~Break', type: 'eleven' };
            if (needs.elevenThirty > 0) return { shift: '11:30~Break', type: 'elevenThirty' };
          }
          // üü¢ Ï¥àÎ°ùÏÉâ (11Ïãú ÏÑ†Ìò∏)
          else if (prefValue === 2) {
            if (needs.eleven > 0) return { shift: '11:00~Break', type: 'eleven' };
            if (needs.elevenThirty > 0) return { shift: '11:30~Break', type: 'elevenThirty' };
            if (needs.open > 0) return { shift: 'Open~Break', type: 'open' };
          }
        } else if (period === 'evening') {
          // üîµ ÌååÎûÄÏÉâ (3:30 ÏÑ†Ìò∏)
          if (prefValue === 1) {
            if (needs.threeThirty > 0) return { shift: '3:30~Close', type: 'threeThirty' };
            if (needs.six > 0) return { shift: '6:00~Close', type: 'six' };
          }
          // üü£ Î≥¥ÎùºÏÉâ (6ÏãúÎßå)
          else if (prefValue === 2) {
            if (needs.six > 0) return { shift: '6:00~Close', type: 'six' };
            if (needs.threeThirty > 0) return { shift: '3:30~Close', type: 'threeThirty' };
          }
        }
        return null;
      };

      // ========================================
      // Í∞Å ÏöîÏùºÎ≥Ñ Ïä§ÏºÄÏ§Ñ ÏÉùÏÑ±
      // ========================================
      DAYS.forEach(day => {
        const req = state.requirements[day];
        const isHoliday = req.isHoliday;
        
        newSchedule[day] = {
          lunch: [],
          dinner: []
        };

        // Remaining needs (ÎèôÏ†ÅÏúºÎ°ú Í∞êÏÜå)
        const remainingNeeds = {
          lunch: {
            open: req.lunch.open || 0,
            eleven: req.lunch.eleven || 0,
            elevenThirty: req.lunch.elevenThirty || 0
          },
          dinner: {
            threeThirty: req.dinner.threeThirty || 0,
            six: req.dinner.six || 0
          }
        };

        const totalLunchNeed = remainingNeeds.lunch.open + remainingNeeds.lunch.eleven + remainingNeeds.lunch.elevenThirty;
        const totalDinnerNeed = remainingNeeds.dinner.threeThirty + remainingNeeds.dinner.six;

        // Ïù¥ÎØ∏ Î∞∞Ï†ïÎêú ÏßÅÏõê Ï∂îÏ†Å
        const assignedEmployees = new Set();

        // ========================================
        // STEP 1: Fixed ÏãúÌîÑÌä∏ Î∞∞Ï†ï (Î¨¥Ï°∞Í±¥!)
        // ========================================
        activeEmployees.forEach(emp => {
          const prefs = state.preferences[emp.id]?.[day];
          if (!prefs) return;

          // Morning Fixed
          if (prefs.morning > 0 && prefs.morningFixed) {
            const result = getFlexibleShift(prefs.morning, 'morning', remainingNeeds.lunch);
            if (result) {
              newSchedule[day].lunch.push({ 
                name: emp.name, 
                shift: result.shift, 
                id: emp.id, 
                isFixed: true 
              });
              remainingNeeds.lunch[result.type]--;
              employeeShiftCount[emp.id]++;
              assignedEmployees.add(emp.id);
            }
          }

          // Evening Fixed
          if (prefs.evening > 0 && prefs.eveningFixed) {
            const result = getFlexibleShift(prefs.evening, 'evening', remainingNeeds.dinner);
            if (result) {
              newSchedule[day].dinner.push({ 
                name: emp.name, 
                shift: result.shift, 
                id: emp.id, 
                isFixed: true 
              });
              remainingNeeds.dinner[result.type]--;
              employeeShiftCount[emp.id]++;
              assignedEmployees.add(emp.id);
            }
          }
        });

        // ========================================
        // STEP 2: Min Guarantee Î∂ÄÏ°±Ìïú ÏÇ¨Îûå Ïö∞ÏÑ†
        // ========================================
        const empWithMinGuarantee = activeEmployees
          .filter(emp => {
            if (assignedEmployees.has(emp.id)) return false;
            const prefs = state.preferences[emp.id];
            const minGuarantee = prefs?.minGuarantee || 0;
            return minGuarantee > 0 && employeeShiftCount[emp.id] < minGuarantee;
          })
          .map(emp => ({
            emp,
            deficit: (state.preferences[emp.id]?.minGuarantee || 0) - employeeShiftCount[emp.id],
            prefs: state.preferences[emp.id]?.[day]
          }))
          .sort((a, b) => b.deficit - a.deficit); // Î∂ÄÏ°±Ìïú Ïàú

        empWithMinGuarantee.forEach(({ emp, prefs }) => {
          if (!prefs) return;

          // Morning (Fixed ÏïÑÎãå Í≤ÉÎßå)
          if (prefs.morning > 0 && !prefs.morningFixed) {
            const total = remainingNeeds.lunch.open + remainingNeeds.lunch.eleven + remainingNeeds.lunch.elevenThirty;
            if (total > 0) {
              const result = getFlexibleShift(prefs.morning, 'morning', remainingNeeds.lunch);
              if (result) {
                newSchedule[day].lunch.push({ 
                  name: emp.name, 
                  shift: result.shift, 
                  id: emp.id, 
                  isFixed: false 
                });
                remainingNeeds.lunch[result.type]--;
                employeeShiftCount[emp.id]++;
                assignedEmployees.add(emp.id);
              }
            }
          }

          // Evening (Fixed ÏïÑÎãå Í≤ÉÎßå)
          if (prefs.evening > 0 && !prefs.eveningFixed) {
            const total = remainingNeeds.dinner.threeThirty + remainingNeeds.dinner.six;
            if (total > 0) {
              const result = getFlexibleShift(prefs.evening, 'evening', remainingNeeds.dinner);
              if (result) {
                newSchedule[day].dinner.push({ 
                  name: emp.name, 
                  shift: result.shift, 
                  id: emp.id, 
                  isFixed: false 
                });
                remainingNeeds.dinner[result.type]--;
                employeeShiftCount[emp.id]++;
                assignedEmployees.add(emp.id);
              }
            }
          }
        });

        // ========================================
        // STEP 3: ÎûúÎç§ Î∞∞Ï†ï (Fixed ÏóÜÎäî ÏÇ¨Îûå Ïö∞ÏÑ†)
        // ========================================
        
        // FixedÍ∞Ä ÌïòÎÇòÎèÑ ÏóÜÎäî ÏÇ¨Îûå
        const noFixedEmployees = shuffle(activeEmployees.filter(emp => {
          if (assignedEmployees.has(emp.id)) return false;
          const allPrefs = state.preferences[emp.id];
          if (!allPrefs) return true;
          
          // Î™®Îì† ÎÇ†Ïßú Ï≤¥ÌÅ¨Ìï¥ÏÑú FixedÍ∞Ä ÌïòÎÇòÎùºÎèÑ ÏûàÏúºÎ©¥ Ï†úÏô∏
          const hasAnyFixed = DAYS.some(d => {
            const dayPref = allPrefs[d];
            return dayPref && (dayPref.morningFixed || dayPref.eveningFixed);
          });
          return !hasAnyFixed;
        }));

        // ÎûúÎç§ Î∞∞Ï†ï - Fixed ÏóÜÎäî ÏÇ¨Îûå
        noFixedEmployees.forEach(emp => {
          const prefs = state.preferences[emp.id]?.[day];
          
          // Morning
          const lunchTotal = remainingNeeds.lunch.open + remainingNeeds.lunch.eleven + remainingNeeds.lunch.elevenThirty;
          if (lunchTotal > 0 && prefs?.morning > 0 && !prefs.morningFixed) {
            const result = getFlexibleShift(prefs.morning, 'morning', remainingNeeds.lunch);
            if (result) {
              newSchedule[day].lunch.push({ 
                name: emp.name, 
                shift: result.shift, 
                id: emp.id, 
                isFixed: false 
              });
              remainingNeeds.lunch[result.type]--;
              employeeShiftCount[emp.id]++;
              assignedEmployees.add(emp.id);
            }
          }

          // Evening
          const dinnerTotal = remainingNeeds.dinner.threeThirty + remainingNeeds.dinner.six;
          if (dinnerTotal > 0 && prefs?.evening > 0 && !prefs.eveningFixed) {
            const result = getFlexibleShift(prefs.evening, 'evening', remainingNeeds.dinner);
            if (result) {
              newSchedule[day].dinner.push({ 
                name: emp.name, 
                shift: result.shift, 
                id: emp.id, 
                isFixed: false 
              });
              remainingNeeds.dinner[result.type]--;
              employeeShiftCount[emp.id]++;
              assignedEmployees.add(emp.id);
            }
          }
        });

        // ========================================
        // STEP 4: Ïó¨Ï†ÑÌûà Î∂ÄÏ°±ÌïòÎ©¥ Fixed ÏûàÎäî ÏÇ¨ÎûåÎèÑ ÎûúÎç§
        // ========================================
        const remainingEmployees = shuffle(activeEmployees.filter(emp => !assignedEmployees.has(emp.id)));

        remainingEmployees.forEach(emp => {
          const prefs = state.preferences[emp.id]?.[day];
          
          // Morning
          const lunchTotal = remainingNeeds.lunch.open + remainingNeeds.lunch.eleven + remainingNeeds.lunch.elevenThirty;
          if (lunchTotal > 0 && prefs?.morning > 0 && !prefs.morningFixed) {
            const result = getFlexibleShift(prefs.morning, 'morning', remainingNeeds.lunch);
            if (result) {
              newSchedule[day].lunch.push({ 
                name: emp.name, 
                shift: result.shift, 
                id: emp.id, 
                isFixed: false 
              });
              remainingNeeds.lunch[result.type]--;
              employeeShiftCount[emp.id]++;
              assignedEmployees.add(emp.id);
            }
          }

          // Evening
          const dinnerTotal = remainingNeeds.dinner.threeThirty + remainingNeeds.dinner.six;
          if (dinnerTotal > 0 && prefs?.evening > 0 && !prefs.eveningFixed) {
            const result = getFlexibleShift(prefs.evening, 'evening', remainingNeeds.dinner);
            if (result) {
              newSchedule[day].dinner.push({ 
                name: emp.name, 
                shift: result.shift, 
                id: emp.id, 
                isFixed: false 
              });
              remainingNeeds.dinner[result.type]--;
              employeeShiftCount[emp.id]++;
              assignedEmployees.add(emp.id);
            }
          }
        });

        // ========================================
        // STEP 5: Holiday Ï≤òÎ¶¨
        // ========================================
        if (isHoliday) {
          const unassigned = shuffle(activeEmployees.filter(emp => !assignedEmployees.has(emp.id)));
          
          unassigned.forEach(emp => {
            const lunchTotal = remainingNeeds.lunch.open + remainingNeeds.lunch.eleven + remainingNeeds.lunch.elevenThirty;
            const dinnerTotal = remainingNeeds.dinner.threeThirty + remainingNeeds.dinner.six;
            
            if (lunchTotal > 0) {
              const shift = remainingNeeds.lunch.open > 0 ? 'Open~Break' : 
                           remainingNeeds.lunch.eleven > 0 ? '11:00~Break' : '11:30~Break';
              const type = remainingNeeds.lunch.open > 0 ? 'open' : 
                          remainingNeeds.lunch.eleven > 0 ? 'eleven' : 'elevenThirty';
              
              newSchedule[day].lunch.push({ 
                name: emp.name, 
                shift, 
                id: emp.id, 
                isFixed: false 
              });
              remainingNeeds.lunch[type]--;
              employeeShiftCount[emp.id]++;
              assignedEmployees.add(emp.id);
            } else if (dinnerTotal > 0) {
              const shift = remainingNeeds.dinner.threeThirty > 0 ? '3:30~Close' : '6:00~Close';
              const type = remainingNeeds.dinner.threeThirty > 0 ? 'threeThirty' : 'six';
              
              newSchedule[day].dinner.push({ 
                name: emp.name, 
                shift, 
                id: emp.id, 
                isFixed: false 
              });
              remainingNeeds.dinner[type]--;
              employeeShiftCount[emp.id]++;
              assignedEmployees.add(emp.id);
            }
          });
        }
      });

      state.schedule = newSchedule;
      await saveSchedule();
      state.generating = false;
      render();
    };

    // ============================================
    // Ïï± ÏãúÏûë!
    // ============================================
    loadInitialData();
  </script>
</body>
</html>
